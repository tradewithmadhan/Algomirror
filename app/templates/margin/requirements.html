{% extends "layout.html" %}

{% block title %}Margin Requirements - AlgoMirror{% endblock %}

{% block head %}
<style>
    .requirement-section {
        transition: opacity 0.3s ease-in-out;
    }

    .tab {
        transition: all 0.2s ease;
        cursor: pointer;
        user-select: none;
    }

    .tab:hover:not(.tab-active) {
        background-color: rgba(59, 130, 246, 0.1);
        transform: translateY(-2px);
    }

    .tab.tab-active {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .tabs-boxed {
        gap: 0.5rem;
    }

    /* Toast notification animations */
    @keyframes slide-in {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slide-out {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }

    .toast {
        position: fixed !important;
        top: 1rem;
        right: 1rem;
        animation: slide-in 0.3s ease-out;
    }

    .toast .alert {
        min-width: 300px;
        max-width: 400px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <div class="flex items-center gap-4">
            <a href="{{ url_for('margin.dashboard') }}" class="btn btn-ghost btn-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Back
            </a>
            <h1 class="text-3xl font-bold text-base-content">Margin Requirements</h1>
        </div>
        <button onclick="saveAllRequirements(this)" class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V2" />
            </svg>
            Save All Changes
        </button>
    </div>

    <!-- Info Alert -->
    <div class="alert alert-info mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <div>
            <p class="font-semibold">Margin Requirements Configuration</p>
            <p class="text-sm mt-1">Set margin requirements per lot for different trade types and instruments. Values are in INR.</p>
        </div>
    </div>

    <!-- Tabs for different instruments -->
    <div class="tabs tabs-boxed mb-6 bg-base-200 p-2">
        <a class="tab tab-lg font-bold px-6 py-3 rounded-lg tab-active" onclick="switchTab('NIFTY', this)">
            <span class="text-lg">NIFTY</span>
        </a>
        <a class="tab tab-lg font-bold px-6 py-3 rounded-lg" onclick="switchTab('BANKNIFTY', this)">
            <span class="text-lg">BANKNIFTY</span>
        </a>
        <a class="tab tab-lg font-bold px-6 py-3 rounded-lg" onclick="switchTab('SENSEX', this)">
            <span class="text-lg">SENSEX</span>
        </a>
    </div>

    <!-- NIFTY Requirements -->
    <div id="NIFTY-requirements" class="requirement-section">
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title mb-4">NIFTY Margin Requirements</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Expiry Day Margins -->
                    <div>
                        <h3 class="font-semibold mb-3 text-primary">Expiry Day (Tuesday)</h3>
                        <div class="space-y-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">CE/PE Sell</span>
                                </label>
                                <input type="number" id="nifty-ce-pe-sell-expiry" class="input input-bordered" value="205000" />
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">CE & PE Sell (Spread)</span>
                                </label>
                                <input type="number" id="nifty-ce-and-pe-sell-expiry" class="input input-bordered" value="250000" />
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Futures (75 Lot)</span>
                                </label>
                                <input type="number" id="nifty-futures-expiry" class="input input-bordered" value="215000" />
                            </div>
                        </div>
                    </div>

                    <!-- Non-Expiry Day Margins -->
                    <div>
                        <h3 class="font-semibold mb-3 text-secondary">Non-Expiry Days</h3>
                        <div class="space-y-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">CE/PE Sell</span>
                                </label>
                                <input type="number" id="nifty-ce-pe-sell-non-expiry" class="input input-bordered" value="250000" />
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">CE & PE Sell (Spread)</span>
                                </label>
                                <input type="number" id="nifty-ce-and-pe-sell-non-expiry" class="input input-bordered" value="320000" />
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Futures (75 Lot)</span>
                                </label>
                                <input type="number" id="nifty-futures-non-expiry" class="input input-bordered" value="215000" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BANKNIFTY Requirements -->
    <div id="BANKNIFTY-requirements" class="requirement-section hidden">
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title mb-4">BANKNIFTY Margin Requirements</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Expiry Day Margins -->
                    <div>
                        <h3 class="font-semibold mb-3 text-primary">Expiry Day (Tuesday)</h3>
                        <div class="space-y-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">CE/PE Sell</span>
                                </label>
                                <input type="number" id="banknifty-ce-pe-sell-expiry" class="input input-bordered" value="205000" />
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">CE & PE Sell (Spread)</span>
                                </label>
                                <input type="number" id="banknifty-ce-and-pe-sell-expiry" class="input input-bordered" value="250000" />
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Futures (35 Lot)</span>
                                </label>
                                <input type="number" id="banknifty-futures-expiry" class="input input-bordered" value="215000" />
                            </div>
                        </div>
                    </div>

                    <!-- Non-Expiry Day Margins -->
                    <div>
                        <h3 class="font-semibold mb-3 text-secondary">Non-Expiry Days</h3>
                        <div class="space-y-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">CE/PE Sell</span>
                                </label>
                                <input type="number" id="banknifty-ce-pe-sell-non-expiry" class="input input-bordered" value="250000" />
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">CE & PE Sell (Spread)</span>
                                </label>
                                <input type="number" id="banknifty-ce-and-pe-sell-non-expiry" class="input input-bordered" value="320000" />
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Futures (35 Lot)</span>
                                </label>
                                <input type="number" id="banknifty-futures-non-expiry" class="input input-bordered" value="215000" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SENSEX Requirements -->
    <div id="SENSEX-requirements" class="requirement-section hidden">
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title mb-4">SENSEX Margin Requirements</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Expiry Day Margins -->
                    <div>
                        <h3 class="font-semibold mb-3 text-primary">Expiry Day (Thursday)</h3>
                        <div class="space-y-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">CE/PE Sell</span>
                                </label>
                                <input type="number" id="sensex-ce-pe-sell-expiry" class="input input-bordered" value="180000" />
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">CE & PE Sell (Spread)</span>
                                </label>
                                <input type="number" id="sensex-ce-and-pe-sell-expiry" class="input input-bordered" value="225000" />
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Futures (20 Lot)</span>
                                </label>
                                <input type="number" id="sensex-futures-expiry" class="input input-bordered" value="185000" />
                            </div>
                        </div>
                    </div>

                    <!-- Non-Expiry Day Margins -->
                    <div>
                        <h3 class="font-semibold mb-3 text-secondary">Non-Expiry Days</h3>
                        <div class="space-y-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">CE/PE Sell</span>
                                </label>
                                <input type="number" id="sensex-ce-pe-sell-non-expiry" class="input input-bordered" value="220000" />
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">CE & PE Sell (Spread)</span>
                                </label>
                                <input type="number" id="sensex-ce-and-pe-sell-non-expiry" class="input input-bordered" value="290000" />
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Futures (20 Lot)</span>
                                </label>
                                <input type="number" id="sensex-futures-non-expiry" class="input input-bordered" value="185000" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trade Types & Quality Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
        <!-- Trade Types Card -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title mb-4">Trade Types</h2>

                <!-- Option Selling Section -->
                <h3 class="font-semibold text-sm text-primary mt-2 mb-2">Option Selling (Uses Margin Requirements)</h3>
                <div class="space-y-2 mb-4">
                    <div class="flex items-center justify-between p-3 bg-base-200 rounded">
                        <span class="font-medium">Sell CE / PE</span>
                        <span class="badge badge-primary">As per Margin Table</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-base-200 rounded">
                        <span class="font-medium">Sell CE and PE</span>
                        <span class="badge badge-info">As per Margin Table</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-base-200 rounded">
                        <span class="font-medium">Futures</span>
                        <span class="badge badge-warning">As per Margin Table</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-base-200 rounded">
                        <span class="font-medium">Option Buying</span>
                        <span class="badge badge-ghost">No Margin Required</span>
                    </div>
                    <p class="text-xs text-base-content/60 mt-1 pl-1">Option buying only debits premium from cash, no margin blocked</p>
                </div>

                <!-- Option Buying Section -->
                <h3 class="font-semibold text-sm text-success mt-2 mb-2">Option Buying (Uses Cash Margin)</h3>
                <div class="space-y-3">
                    <div class="form-control">
                        <label class="label py-1">
                            <span class="label-text">NIFTY / BANKNIFTY Premium Per Lot</span>
                        </label>
                        <div class="input-group">
                            <span class="px-3 bg-base-200 flex items-center text-sm">Rs</span>
                            <input type="number" id="option-buying-premium" class="input input-bordered input-sm flex-1"
                                   value="{{ option_buying_premium | default(20000) }}" step="1000" min="0" />
                        </div>
                    </div>
                    <div class="form-control">
                        <label class="label py-1">
                            <span class="label-text">SENSEX Premium Per Lot</span>
                        </label>
                        <div class="input-group">
                            <span class="px-3 bg-base-200 flex items-center text-sm">Rs</span>
                            <input type="number" id="sensex-option-buying-premium" class="input input-bordered input-sm flex-1"
                                   value="{{ sensex_option_buying_premium | default(20000) }}" step="1000" min="0" />
                        </div>
                    </div>
                    <button type="button" onclick="saveOptionBuyingPremium(this)" class="btn btn-success btn-sm w-full">
                        Save Option Buying Settings
                    </button>
                    <div class="text-xs text-base-content/70 mt-2 p-2 bg-base-200 rounded">
                        <strong>Formula:</strong> Lots = (Cash x Quality%) / Premium Per Lot<br/>
                        <strong>Example:</strong> Cash = Rs 10,00,000, Grade = 5%, Premium = Rs 20,000<br/>
                        Budget = 10,00,000 x 5% = Rs 50,000 → Lots = 50,000 / 20,000 = <strong>2 lots</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quality Grades Card - Editable -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="card-title">Trade Quality Settings</h2>
                    <button onclick="saveTradeQualities(this)" class="btn btn-sm btn-primary">
                        Save Qualities
                    </button>
                </div>
                <p class="text-sm text-base-content/70 mb-4">Set the margin percentage for each quality grade. These are used in Strategy Builder.</p>
                <div class="space-y-4">
                    <!-- Grade A -->
                    <div class="p-4 bg-base-200 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="badge badge-success badge-lg">A</span>
                                <span class="font-semibold">Grade A</span>
                            </div>
                            <select id="quality-a-risk" class="select select-bordered select-sm w-32">
                                <option value="conservative" {% if qualities_dict and qualities_dict.get('A') and qualities_dict['A'].risk_level == 'conservative' %}selected{% endif %}>Conservative</option>
                                <option value="moderate" {% if qualities_dict and qualities_dict.get('A') and qualities_dict['A'].risk_level == 'moderate' %}selected{% endif %}>Moderate</option>
                                <option value="aggressive" {% if qualities_dict and qualities_dict.get('A') and qualities_dict['A'].risk_level == 'aggressive' %}selected{% endif %}>Aggressive</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text">Margin Percentage (%)</span>
                                </label>
                                <input type="number" id="quality-a-percentage" class="input input-bordered input-sm"
                                       min="1" max="100" step="1"
                                       value="{{ qualities_dict['A'].margin_percentage if qualities_dict and qualities_dict.get('A') else 95 }}" />
                            </div>
                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text">Trade Type</span>
                                </label>
                                <select id="quality-a-margin-source" class="select select-bordered select-sm">
                                    <option value="available" {% if not qualities_dict or not qualities_dict.get('A') or qualities_dict['A'].margin_source != 'cash' %}selected{% endif %}>Option Seller</option>
                                    <option value="cash" {% if qualities_dict and qualities_dict.get('A') and qualities_dict['A'].margin_source == 'cash' %}selected{% endif %}>Option Buyer</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Grade B -->
                    <div class="p-4 bg-base-200 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="badge badge-warning badge-lg">B</span>
                                <span class="font-semibold">Grade B</span>
                            </div>
                            <select id="quality-b-risk" class="select select-bordered select-sm w-32">
                                <option value="conservative" {% if qualities_dict and qualities_dict.get('B') and qualities_dict['B'].risk_level == 'conservative' %}selected{% endif %}>Conservative</option>
                                <option value="moderate" {% if qualities_dict and qualities_dict.get('B') and qualities_dict['B'].risk_level == 'moderate' %}selected{% endif %}>Moderate</option>
                                <option value="aggressive" {% if qualities_dict and qualities_dict.get('B') and qualities_dict['B'].risk_level == 'aggressive' %}selected{% endif %}>Aggressive</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text">Margin Percentage (%)</span>
                                </label>
                                <input type="number" id="quality-b-percentage" class="input input-bordered input-sm"
                                       min="1" max="100" step="1"
                                       value="{{ qualities_dict['B'].margin_percentage if qualities_dict and qualities_dict.get('B') else 65 }}" />
                            </div>
                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text">Trade Type</span>
                                </label>
                                <select id="quality-b-margin-source" class="select select-bordered select-sm">
                                    <option value="available" {% if not qualities_dict or not qualities_dict.get('B') or qualities_dict['B'].margin_source != 'cash' %}selected{% endif %}>Option Seller</option>
                                    <option value="cash" {% if qualities_dict and qualities_dict.get('B') and qualities_dict['B'].margin_source == 'cash' %}selected{% endif %}>Option Buyer</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Grade C -->
                    <div class="p-4 bg-base-200 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="badge badge-error badge-lg">C</span>
                                <span class="font-semibold">Grade C</span>
                            </div>
                            <select id="quality-c-risk" class="select select-bordered select-sm w-32">
                                <option value="conservative" {% if qualities_dict and qualities_dict.get('C') and qualities_dict['C'].risk_level == 'conservative' %}selected{% endif %}>Conservative</option>
                                <option value="moderate" {% if qualities_dict and qualities_dict.get('C') and qualities_dict['C'].risk_level == 'moderate' %}selected{% endif %}>Moderate</option>
                                <option value="aggressive" {% if qualities_dict and qualities_dict.get('C') and qualities_dict['C'].risk_level == 'aggressive' %}selected{% endif %}>Aggressive</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text">Margin Percentage (%)</span>
                                </label>
                                <input type="number" id="quality-c-percentage" class="input input-bordered input-sm"
                                       min="1" max="100" step="1"
                                       value="{{ qualities_dict['C'].margin_percentage if qualities_dict and qualities_dict.get('C') else 36 }}" />
                            </div>
                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text">Trade Type</span>
                                </label>
                                <select id="quality-c-margin-source" class="select select-bordered select-sm">
                                    <option value="available" {% if not qualities_dict or not qualities_dict.get('C') or qualities_dict['C'].margin_source != 'cash' %}selected{% endif %}>Option Seller</option>
                                    <option value="cash" {% if qualities_dict and qualities_dict.get('C') and qualities_dict['C'].margin_source == 'cash' %}selected{% endif %}>Option Buyer</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic Custom Grades -->
                    <div id="custom-grades-container">
                        {% for grade, quality in qualities_dict.items() if grade not in ['A', 'B', 'C'] %}
                        <div class="p-4 bg-base-200 rounded-lg custom-grade-item" data-grade="{{ grade }}">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="badge badge-neutral badge-lg">{{ grade }}</span>
                                    <span class="font-semibold">Grade {{ grade }}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <select class="select select-bordered select-sm w-32 custom-grade-risk">
                                        <option value="conservative" {% if quality.risk_level == 'conservative' %}selected{% endif %}>Conservative</option>
                                        <option value="moderate" {% if quality.risk_level == 'moderate' %}selected{% endif %}>Moderate</option>
                                        <option value="aggressive" {% if quality.risk_level == 'aggressive' %}selected{% endif %}>Aggressive</option>
                                    </select>
                                    <button type="button" class="btn btn-ghost btn-sm btn-circle text-error" onclick="removeGrade(this)">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="form-control">
                                    <label class="label py-1">
                                        <span class="label-text">Margin Percentage (%)</span>
                                    </label>
                                    <input type="number" class="input input-bordered input-sm custom-grade-percentage"
                                           min="1" max="100" step="1" value="{{ quality.margin_percentage }}" />
                                </div>
                                <div class="form-control">
                                    <label class="label py-1">
                                        <span class="label-text">Trade Type</span>
                                    </label>
                                    <select class="select select-bordered select-sm custom-grade-margin-source">
                                        <option value="available" {% if quality.margin_source != 'cash' %}selected{% endif %}>Option Seller</option>
                                        <option value="cash" {% if quality.margin_source == 'cash' %}selected{% endif %}>Option Buyer</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Add New Grade Button -->
                    <div class="mt-4">
                        <button type="button" onclick="addNewGrade()" class="btn btn-outline btn-sm w-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            Add Custom Grade
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Pure JavaScript - no template variables in JS code
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize first tab with primary colors
        const firstTab = document.querySelector('.tab.tab-active');
        if (firstTab) {
            firstTab.classList.add('bg-primary');
            firstTab.classList.add('text-primary-content');
        }

        // Load margin requirements from server
        loadMarginRequirements();
    });

    async function loadMarginRequirements() {
        try {
            // This will load the existing values if they exist in the database
            // The values are already loaded via server-side rendering
            console.log('Margin requirements page loaded');
        } catch (error) {
            console.error('Error loading margin requirements:', error);
        }
    }

    function switchTab(instrument, tabElement) {
        // Hide all sections with fade effect
        document.querySelectorAll('.requirement-section').forEach(section => {
            section.classList.add('hidden');
            section.style.opacity = '0';
        });

        // Remove active from all tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('tab-active');
            tab.classList.remove('bg-primary');
            tab.classList.remove('text-primary-content');
        });

        // Show selected section with fade in
        const selectedSection = document.getElementById(instrument + '-requirements');
        selectedSection.classList.remove('hidden');
        setTimeout(() => {
            selectedSection.style.opacity = '1';
        }, 10);

        // Mark tab as active with enhanced styling
        tabElement.classList.add('tab-active');
        tabElement.classList.add('bg-primary');
        tabElement.classList.add('text-primary-content');
    }

    // Initialize first tab with primary colors (moved to main DOMContentLoaded)

    async function saveAllRequirements(saveBtn) {
        // Disable save button and show loading
        const originalContent = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="loading loading-spinner loading-sm mr-2"></span>Saving...';

        const instruments = ['NIFTY', 'BANKNIFTY', 'SENSEX'];
        let successCount = 0;

        for (const instrument of instruments) {
            const prefix = instrument.toLowerCase();

            // Validate inputs
            const fields = [
                prefix + '-ce-pe-sell-expiry',
                prefix + '-ce-pe-sell-non-expiry',
                prefix + '-ce-and-pe-sell-expiry',
                prefix + '-ce-and-pe-sell-non-expiry',
                prefix + '-futures-expiry',
                prefix + '-futures-non-expiry'
            ];

            let hasError = false;
            for (const fieldId of fields) {
                const field = document.getElementById(fieldId);
                if (!field || !field.value || isNaN(parseFloat(field.value))) {
                    showNotification(`Invalid value for ${instrument} - ${fieldId.replace(prefix + '-', '').replace(/-/g, ' ')}`, 'error');
                    hasError = true;
                    break;
                }
            }

            if (hasError) {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalContent;
                return;
            }

            const data = {
                instrument: instrument,
                ce_pe_sell_expiry: parseFloat(document.getElementById(prefix + '-ce-pe-sell-expiry').value),
                ce_pe_sell_non_expiry: parseFloat(document.getElementById(prefix + '-ce-pe-sell-non-expiry').value),
                ce_and_pe_sell_expiry: parseFloat(document.getElementById(prefix + '-ce-and-pe-sell-expiry').value),
                ce_and_pe_sell_non_expiry: parseFloat(document.getElementById(prefix + '-ce-and-pe-sell-non-expiry').value),
                futures_expiry: parseFloat(document.getElementById(prefix + '-futures-expiry').value),
                futures_non_expiry: parseFloat(document.getElementById(prefix + '-futures-non-expiry').value)
            };

            try {
                const response = await fetch('/margin/requirements', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                if (result.status === 'success') {
                    successCount++;
                } else {
                    throw new Error(result.message || 'Failed to save ' + instrument);
                }
            } catch (error) {
                showNotification('Error saving ' + instrument + ': ' + error.message, 'error');
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalContent;
                return;
            }
        }

        // Re-enable button
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalContent;

        // Show success message
        if (successCount === instruments.length) {
            showNotification('✓ All margin requirements saved successfully!', 'success');
        }
    }

    // Track used grades
    function getUsedGrades() {
        const used = ['A', 'B', 'C'];
        document.querySelectorAll('.custom-grade-item').forEach(item => {
            used.push(item.dataset.grade);
        });
        return used;
    }

    function getNextGrade() {
        const used = getUsedGrades();
        const alphabet = 'DEFGHIJKLMNOPQRSTUVWXYZ'.split('');
        for (const letter of alphabet) {
            if (!used.includes(letter)) {
                return letter;
            }
        }
        return null;
    }

    function addNewGrade() {
        const nextGrade = getNextGrade();
        if (!nextGrade) {
            showNotification('Maximum number of grades reached', 'error');
            return;
        }

        const container = document.getElementById('custom-grades-container');
        const gradeHtml = `
            <div class="p-4 bg-base-200 rounded-lg custom-grade-item mt-4" data-grade="${nextGrade}">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <span class="badge badge-neutral badge-lg">${nextGrade}</span>
                        <span class="font-semibold">Grade ${nextGrade}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <select class="select select-bordered select-sm w-32 custom-grade-risk">
                            <option value="conservative">Conservative</option>
                            <option value="moderate" selected>Moderate</option>
                            <option value="aggressive">Aggressive</option>
                        </select>
                        <button type="button" class="btn btn-ghost btn-sm btn-circle text-error" onclick="removeGrade(this)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="form-control">
                        <label class="label py-1">
                            <span class="label-text">Margin Percentage (%)</span>
                        </label>
                        <input type="number" class="input input-bordered input-sm custom-grade-percentage"
                               min="1" max="100" step="1" value="50" />
                    </div>
                    <div class="form-control">
                        <label class="label py-1">
                            <span class="label-text">Trade Type</span>
                        </label>
                        <select class="select select-bordered select-sm custom-grade-margin-source">
                            <option value="available" selected>Option Seller</option>
                            <option value="cash">Option Buyer</option>
                        </select>
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', gradeHtml);
        showNotification(`Grade ${nextGrade} added. Remember to save!`, 'info');
    }

    function removeGrade(btn) {
        const gradeItem = btn.closest('.custom-grade-item');
        const grade = gradeItem.dataset.grade;
        gradeItem.remove();
        showNotification(`Grade ${grade} removed. Remember to save!`, 'info');
    }

    async function saveTradeQualities(saveBtn) {
        // Disable save button and show loading
        const originalContent = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="loading loading-spinner loading-xs mr-1"></span>Saving...';

        // Collect default grades (A, B, C)
        const qualities = [
            {
                grade: 'A',
                percentage: parseFloat(document.getElementById('quality-a-percentage').value),
                risk_level: document.getElementById('quality-a-risk').value,
                margin_source: document.getElementById('quality-a-margin-source').value
            },
            {
                grade: 'B',
                percentage: parseFloat(document.getElementById('quality-b-percentage').value),
                risk_level: document.getElementById('quality-b-risk').value,
                margin_source: document.getElementById('quality-b-margin-source').value
            },
            {
                grade: 'C',
                percentage: parseFloat(document.getElementById('quality-c-percentage').value),
                risk_level: document.getElementById('quality-c-risk').value,
                margin_source: document.getElementById('quality-c-margin-source').value
            }
        ];

        // Collect custom grades dynamically
        document.querySelectorAll('.custom-grade-item').forEach(item => {
            const grade = item.dataset.grade;
            const percentage = parseFloat(item.querySelector('.custom-grade-percentage').value);
            const risk_level = item.querySelector('.custom-grade-risk').value;
            const margin_source = item.querySelector('.custom-grade-margin-source').value;
            qualities.push({ grade, percentage, risk_level, margin_source });
        });

        // Validate percentages
        for (const q of qualities) {
            if (isNaN(q.percentage) || q.percentage < 1 || q.percentage > 100) {
                showNotification(`Grade ${q.grade}: Percentage must be between 1 and 100`, 'error');
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalContent;
                return;
            }
        }

        try {
            const response = await fetch('/margin/qualities', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                },
                body: JSON.stringify({ qualities: qualities })
            });

            const result = await response.json();

            if (result.status === 'success') {
                showNotification('Trade quality settings saved successfully!', 'success');
            } else {
                throw new Error(result.message || 'Failed to save trade qualities');
            }
        } catch (error) {
            showNotification('Error saving trade qualities: ' + error.message, 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalContent;
        }
    }

    async function saveOptionBuyingPremium(saveBtn) {
        // Disable save button and show loading
        const originalContent = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="loading loading-spinner loading-xs mr-1"></span>Saving...';

        const niftyPremium = parseFloat(document.getElementById('option-buying-premium').value);
        const sensexPremium = parseFloat(document.getElementById('sensex-option-buying-premium').value);

        // Validate
        if (isNaN(niftyPremium) || niftyPremium < 0) {
            showNotification('Invalid NIFTY/BANKNIFTY premium value', 'error');
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalContent;
            return;
        }

        if (isNaN(sensexPremium) || sensexPremium < 0) {
            showNotification('Invalid SENSEX premium value', 'error');
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalContent;
            return;
        }

        try {
            const response = await fetch('/margin/update-option-buying-premium', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                },
                body: JSON.stringify({
                    option_buying_premium: niftyPremium,
                    sensex_option_buying_premium: sensexPremium
                })
            });

            const result = await response.json();

            if (result.status === 'success') {
                showNotification('Option buying premium saved successfully!', 'success');
            } else {
                throw new Error(result.message || 'Failed to save option buying premium');
            }
        } catch (error) {
            showNotification('Error saving option buying premium: ' + error.message, 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalContent;
        }
    }

    function showNotification(message, type = 'info') {
        // Remove any existing notifications
        const existingToasts = document.querySelectorAll('.toast');
        existingToasts.forEach(toast => toast.remove());

        const alertClass = type === 'error' ? 'alert-error' : type === 'success' ? 'alert-success' : 'alert-info';
        const icon = type === 'error' ? '❌' : type === 'success' ? '✓' : 'ℹ️';

        const toastHtml = `
            <div class="toast toast-top toast-end z-[9999]">
                <div class="alert ${alertClass} shadow-lg">
                    <div>
                        <span class="text-lg mr-2">${icon}</span>
                        <span>${message}</span>
                    </div>
                </div>
            </div>
        `;

        const toastContainer = document.createElement('div');
        toastContainer.innerHTML = toastHtml;
        document.body.appendChild(toastContainer.firstElementChild);

        // Add animation
        setTimeout(() => {
            const toast = document.querySelector('.toast');
            if (toast) {
                toast.style.animation = 'slide-in 0.3s ease-out';
            }
        }, 10);

        // Remove after 4 seconds
        setTimeout(() => {
            const toast = document.querySelector('.toast');
            if (toast) {
                toast.style.animation = 'slide-out 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }
        }, 4000);
    }
</script>
{% endblock %}