{% extends "layout.html" %}

{% block title %}Strategy Builder - AlgoMirror{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold">Strategy Builder</h1>
            <p class="text-base-content/70">Create multi-leg option strategies with 9 configurable parameters</p>
        </div>
        <a href="{{ url_for('strategy.dashboard') }}" class="btn btn-ghost">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Dashboard
        </a>
    </div>

    <form id="strategyForm">
        <!-- Basic Information Card -->
        <div class="card bg-base-100 shadow-lg mb-6">
            <div class="card-body">
                <h2 class="card-title mb-4">Basic Information</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Strategy Name</span>
                        </label>
                        <input type="text" id="strategyName" class="input input-bordered"
                               placeholder="e.g., Iron Condor Weekly" required
                               value="{{ strategy.name if strategy else '' }}">
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Risk Profile</span>
                        </label>
                        <select id="riskProfile" class="select select-bordered">
                            <option value="balanced" {% if strategy and strategy.risk_profile == 'balanced' %}selected{% endif %}>Balanced (65% margin)</option>
                            <option value="conservative" {% if strategy and strategy.risk_profile == 'conservative' %}selected{% endif %}>Conservative (40% margin)</option>
                            <option value="aggressive" {% if strategy and strategy.risk_profile == 'aggressive' %}selected{% endif %}>Aggressive (80% margin)</option>
                        </select>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Market Condition</span>
                        </label>
                        <select id="marketCondition" class="select select-bordered">
                            <option value="non_expiry" {% if strategy and strategy.market_condition == 'non_expiry' %}selected{% endif %}>Non-Expiry</option>
                            <option value="expiry" {% if strategy and strategy.market_condition == 'expiry' %}selected{% endif %}>Expiry Day</option>
                            <option value="any" {% if strategy and strategy.market_condition == 'any' %}selected{% endif %}>Any Day</option>
                        </select>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Select Accounts</span>
                        </label>
                        <div class="space-y-2">
                            {% for account in accounts %}
                            <label class="label cursor-pointer justify-start">
                                <input type="checkbox" class="checkbox checkbox-primary mr-3"
                                       name="accounts" value="{{ account.id }}"
                                       {% if strategy and strategy.selected_accounts and account.id in strategy.selected_accounts %}checked{% endif %}>
                                <span>{{ account.account_name }} ({{ account.broker_name }})</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy Legs Card -->
        <div class="card bg-base-100 shadow-lg mb-6">
            <div class="card-body">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="card-title">Strategy Legs</h2>
                    <button type="button" onclick="addLeg()" class="btn btn-primary btn-sm">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Add Leg
                    </button>
                </div>

                <div id="strategyLegs">
                    <!-- Legs will be added dynamically -->
                </div>
            </div>
        </div>

        <!-- Risk Management Card -->
        <div class="card bg-base-100 shadow-lg mb-6">
            <div class="card-body">
                <h2 class="card-title mb-4">Risk Management</h2>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Max Loss (₹)</span>
                        </label>
                        <input type="number" id="maxLoss" class="input input-bordered"
                               placeholder="5000" value="{{ strategy.max_loss if strategy else '' }}">
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Max Profit (₹)</span>
                        </label>
                        <input type="number" id="maxProfit" class="input input-bordered"
                               placeholder="10000" value="{{ strategy.max_profit if strategy else '' }}">
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Trailing Stop Loss (%)</span>
                        </label>
                        <input type="number" id="trailingSl" class="input input-bordered"
                               placeholder="20" step="0.1" value="{{ strategy.trailing_sl if strategy else '' }}">
                    </div>
                </div>
            </div>
        </div>

        {% if strategy %}
        <!-- Strategy Execution Tracking Section -->

        <!-- Tabs for Orderbook, Tradebook, Positions -->
        <div class="card bg-base-100 shadow-lg mb-6">
            <div class="card-body">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="card-title">Strategy Execution Tracking</h2>
                    <div class="flex gap-2">
                        <button type="button" onclick="refreshStrategyData()" class="btn btn-ghost btn-sm">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Refresh
                        </button>
                        <button type="button" onclick="closeAllPositions()" class="btn btn-error btn-sm">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            Close All Positions
                        </button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tabs tabs-boxed mb-4">
                    <a class="tab tab-active" onclick="showStrategyTab('orderbook', this)">Orderbook</a>
                    <a class="tab" onclick="showStrategyTab('tradebook', this)">Tradebook</a>
                    <a class="tab" onclick="showStrategyTab('positions', this)">Positions</a>
                </div>

                <!-- Orderbook Tab -->
                <div id="orderbook-tab" class="strategy-tab">
                    <div id="order-stats" class="mb-4"></div>
                    <div class="overflow-x-auto">
                        <table class="table table-compact">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Symbol</th>
                                    <th>Exchange</th>
                                    <th>Product</th>
                                    <th>Action</th>
                                    <th>Qty</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                            <tbody id="orderbook-body">
                                <tr>
                                    <td colspan="9" class="text-center text-base-content/60">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tradebook Tab -->
                <div id="tradebook-tab" class="strategy-tab hidden">
                    <div class="overflow-x-auto">
                        <table class="table table-compact">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Symbol</th>
                                    <th>Exchange</th>
                                    <th>Product</th>
                                    <th>Action</th>
                                    <th>Avg Price</th>
                                    <th>Trade Value</th>
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                            <tbody id="tradebook-body">
                                <tr>
                                    <td colspan="10" class="text-center text-base-content/60">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="stats shadow mt-4">
                        <div class="stat">
                            <div class="stat-title">Total P&L</div>
                            <div class="stat-value text-primary" id="total-pnl">₹0.00</div>
                        </div>
                    </div>
                </div>

                <!-- Positions Tab -->
                <div id="positions-tab" class="strategy-tab hidden">
                    <div class="overflow-x-auto">
                        <table class="table table-compact">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Exchange</th>
                                    <th>Product</th>
                                    <th>Action</th>
                                    <th>Qty</th>
                                    <th>Avg Price</th>
                                    <th>LTP</th>
                                    <th>P&L</th>
                                </tr>
                            </thead>
                            <tbody id="positions-body">
                                <tr>
                                    <td colspan="9" class="text-center text-base-content/60">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="stats shadow mt-4">
                        <div class="stat">
                            <div class="stat-title">Total Unrealized P&L</div>
                            <div class="stat-value" id="total-unrealized-pnl">₹0.00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Action Buttons -->
        <div class="flex justify-end gap-3">
            <button type="button" onclick="saveAsTemplate()" class="btn btn-ghost">Save as Template</button>
            <button type="button" onclick="saveStrategy(false)" class="btn btn-outline btn-primary">Save Strategy</button>
            <button type="button" onclick="saveStrategy(true)" class="btn btn-primary">Save & Execute</button>
        </div>
    </form>
</div>

<!-- Leg Template -->
<template id="legTemplate">
    <div class="leg-item border rounded-lg p-4 mb-4">
        <div class="flex justify-between items-center mb-3">
            <h3 class="font-semibold">Leg <span class="leg-number">1</span></h3>
            <button type="button" onclick="removeLeg(this)" class="btn btn-ghost btn-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <!-- Row 1: Instrument, Product Type, Expiry, Action -->
            <div class="form-control">
                <label class="label"><span class="label-text text-xs">1. Instrument</span></label>
                <select class="select select-bordered select-sm leg-instrument">
                    <option value="NIFTY">NIFTY</option>
                    <option value="BANKNIFTY">BANKNIFTY</option>
                    <option value="FINNIFTY">FINNIFTY</option>
                    <option value="MIDCPNIFTY">MIDCPNIFTY</option>
                    <option value="SENSEX">SENSEX</option>
                </select>
            </div>

            <div class="form-control">
                <label class="label"><span class="label-text text-xs">2. Product Type</span></label>
                <select class="select select-bordered select-sm leg-product-type" onchange="toggleOptionFields(this)">
                    <option value="options">Options</option>
                    <option value="futures">Futures</option>
                </select>
            </div>

            <div class="form-control">
                <label class="label"><span class="label-text text-xs">3. Expiry</span></label>
                <select class="select select-bordered select-sm leg-expiry">
                    <option value="current_week">Current Week</option>
                    <option value="next_week">Next Week</option>
                    <option value="current_month">Current Month</option>
                    <option value="next_month">Next Month</option>
                </select>
            </div>

            <div class="form-control">
                <label class="label"><span class="label-text text-xs">4. Action</span></label>
                <select class="select select-bordered select-sm leg-action">
                    <option value="BUY">BUY</option>
                    <option value="SELL">SELL</option>
                </select>
            </div>

            <!-- Row 2: Option Type, Strike Selection, Strike Price/Offset, Lots -->
            <div class="form-control option-field">
                <label class="label"><span class="label-text text-xs">5. Option Type</span></label>
                <select class="select select-bordered select-sm leg-option-type">
                    <option value="CE">Call (CE)</option>
                    <option value="PE">Put (PE)</option>
                </select>
            </div>

            <div class="form-control option-field">
                <label class="label"><span class="label-text text-xs">6. Strike Selection</span></label>
                <select class="select select-bordered select-sm leg-strike-selection" onchange="toggleStrikeInput(this)">
                    <option value="ATM">ATM (At The Money)</option>
                    <optgroup label="In The Money">
                        <option value="ITM" data-offset="1">ITM 1</option>
                        <option value="ITM" data-offset="2">ITM 2</option>
                        <option value="ITM" data-offset="3">ITM 3</option>
                        <option value="ITM" data-offset="4">ITM 4</option>
                        <option value="ITM" data-offset="5">ITM 5</option>
                        <option value="ITM" data-offset="6">ITM 6</option>
                        <option value="ITM" data-offset="7">ITM 7</option>
                        <option value="ITM" data-offset="8">ITM 8</option>
                        <option value="ITM" data-offset="9">ITM 9</option>
                        <option value="ITM" data-offset="10">ITM 10</option>
                        <option value="ITM" data-offset="11">ITM 11</option>
                        <option value="ITM" data-offset="12">ITM 12</option>
                        <option value="ITM" data-offset="13">ITM 13</option>
                        <option value="ITM" data-offset="14">ITM 14</option>
                        <option value="ITM" data-offset="15">ITM 15</option>
                        <option value="ITM" data-offset="16">ITM 16</option>
                        <option value="ITM" data-offset="17">ITM 17</option>
                        <option value="ITM" data-offset="18">ITM 18</option>
                        <option value="ITM" data-offset="19">ITM 19</option>
                        <option value="ITM" data-offset="20">ITM 20</option>
                    </optgroup>
                    <optgroup label="Out of The Money">
                        <option value="OTM" data-offset="1">OTM 1</option>
                        <option value="OTM" data-offset="2">OTM 2</option>
                        <option value="OTM" data-offset="3">OTM 3</option>
                        <option value="OTM" data-offset="4">OTM 4</option>
                        <option value="OTM" data-offset="5">OTM 5</option>
                        <option value="OTM" data-offset="6">OTM 6</option>
                        <option value="OTM" data-offset="7">OTM 7</option>
                        <option value="OTM" data-offset="8">OTM 8</option>
                        <option value="OTM" data-offset="9">OTM 9</option>
                        <option value="OTM" data-offset="10">OTM 10</option>
                        <option value="OTM" data-offset="11">OTM 11</option>
                        <option value="OTM" data-offset="12">OTM 12</option>
                        <option value="OTM" data-offset="13">OTM 13</option>
                        <option value="OTM" data-offset="14">OTM 14</option>
                        <option value="OTM" data-offset="15">OTM 15</option>
                        <option value="OTM" data-offset="16">OTM 16</option>
                        <option value="OTM" data-offset="17">OTM 17</option>
                        <option value="OTM" data-offset="18">OTM 18</option>
                        <option value="OTM" data-offset="19">OTM 19</option>
                        <option value="OTM" data-offset="20">OTM 20</option>
                    </optgroup>
                    <option value="strike_price">Specific Strike</option>
                    <option value="premium_near">Premium Near</option>
                </select>
            </div>

            <div class="form-control">
                <label class="label"><span class="label-text text-xs leg-strike-label">7. Strike Value</span></label>
                <input type="number" class="input input-bordered input-sm leg-strike-value" placeholder="Auto" disabled>
            </div>

            <div class="form-control">
                <label class="label"><span class="label-text text-xs">8. Lots</span></label>
                <input type="number" class="input input-bordered input-sm leg-lots" value="1" min="1">
            </div>

            <!-- Row 3: Order Type, Price Condition, Limit Price, Trigger Price -->
            <div class="form-control">
                <label class="label"><span class="label-text text-xs">9. Order Type</span></label>
                <select class="select select-bordered select-sm leg-order-type" onchange="togglePriceFields(this)">
                    <option value="MARKET">MARKET</option>
                    <option value="LIMIT">LIMIT</option>
                </select>
            </div>

            <div class="form-control price-condition-field" style="display:none;">
                <label class="label"><span class="label-text text-xs">Price Condition</span></label>
                <select class="select select-bordered select-sm leg-price-condition">
                    <option value="ABOVE">ABOVE</option>
                    <option value="BELOW">BELOW</option>
                </select>
            </div>

            <div class="form-control limit-price-field" style="display:none;">
                <label class="label"><span class="label-text text-xs">Limit Price</span></label>
                <input type="number" class="input input-bordered input-sm leg-limit-price" placeholder="0.00" step="0.05">
            </div>


            <!-- Row 4: SL%, TP% -->
            <div class="form-control">
                <label class="label"><span class="label-text text-xs">Stop Loss (%)</span></label>
                <input type="number" class="input input-bordered input-sm leg-sl" placeholder="%" step="0.1">
            </div>

            <div class="form-control">
                <label class="label"><span class="label-text text-xs">Take Profit (%)</span></label>
                <input type="number" class="input input-bordered input-sm leg-tp" placeholder="%" step="0.1">
            </div>
        </div>
    </div>
</template>

<script>
let legCount = 0;
let lotSizes = {};  // Store lot sizes fetched from backend

// Fetch lot sizes on page load
async function fetchLotSizes() {
    try {
        const response = await fetch('/strategy/api/lot-sizes');
        if (response.ok) {
            const data = await response.json();
            // Merge fetched data with defaults
            lotSizes = {
                'NIFTY': 75,
                'BANKNIFTY': 35,
                'FINNIFTY': 65,
                'MIDCPNIFTY': 75,
                'SENSEX': 20,
                ...data  // Override with database values
            };
            console.log('Loaded lot sizes from database:', lotSizes);
        } else {
            // Use defaults if fetch fails
            lotSizes = {
                'NIFTY': 75,
                'BANKNIFTY': 35,
                'FINNIFTY': 65,
                'MIDCPNIFTY': 75,
                'SENSEX': 20
            };
            console.log('Using default lot sizes (fetch failed)');
        }
    } catch (error) {
        console.error('Error fetching lot sizes:', error);
        // Use defaults on error
        lotSizes = {
            'NIFTY': 75,
            'BANKNIFTY': 35,
            'FINNIFTY': 65,
            'MIDCPNIFTY': 75,
            'SENSEX': 20
        };
        console.log('Using default lot sizes (error occurred)');
    }
}

// Add a new leg
function addLeg() {
    const template = document.getElementById('legTemplate');
    const clone = template.content.cloneNode(true);

    legCount++;
    clone.querySelector('.leg-number').textContent = legCount;

    document.getElementById('strategyLegs').appendChild(clone);
}

// Remove a leg
function removeLeg(button) {
    button.closest('.leg-item').remove();
    updateLegNumbers();
}

// Update leg numbers after removal
function updateLegNumbers() {
    const legs = document.querySelectorAll('.leg-item');
    legs.forEach((leg, index) => {
        leg.querySelector('.leg-number').textContent = index + 1;
    });
    legCount = legs.length;
}

// Toggle option-specific fields
function toggleOptionFields(select) {
    const legItem = select.closest('.leg-item');
    const optionFields = legItem.querySelectorAll('.option-field');

    if (select.value === 'futures') {
        optionFields.forEach(field => field.style.display = 'none');
    } else {
        optionFields.forEach(field => field.style.display = 'block');
    }
}

// Toggle price fields based on order type
function togglePriceFields(selectElement) {
    const legItem = selectElement.closest('.leg-item');
    const orderType = selectElement.value;
    const priceConditionField = legItem.querySelector('.price-condition-field');
    const limitPriceField = legItem.querySelector('.limit-price-field');

    // Hide all by default
    if (priceConditionField) priceConditionField.style.display = 'none';
    if (limitPriceField) limitPriceField.style.display = 'none';

    // Show relevant fields based on order type
    if (orderType === 'LIMIT') {
        if (priceConditionField) priceConditionField.style.display = 'block';
        if (limitPriceField) limitPriceField.style.display = 'block';
    }
}

// Toggle strike input based on selection
function toggleStrikeInput(select) {
    const legItem = select.closest('.leg-item');
    const input = legItem.querySelector('.leg-strike-value');
    const label = legItem.querySelector('.leg-strike-label');
    const selectedOption = select.options[select.selectedIndex];
    const offset = selectedOption.dataset.offset;

    if (select.value === 'strike_price') {
        input.disabled = false;
        input.placeholder = 'Enter strike price';
        input.value = '';
        label.textContent = '7. Strike Price';
    } else if (select.value === 'premium_near') {
        input.disabled = false;
        input.placeholder = 'Enter target premium';
        input.value = '';
        label.textContent = '7. Target Premium';
    } else if (select.value === 'ITM' || select.value === 'OTM') {
        // For ITM/OTM options, store offset as hidden value
        input.disabled = true;
        input.placeholder = 'Auto-calculated';
        input.value = offset || '0';
        input.dataset.offset = offset || '0';
        label.textContent = '7. Strike Offset';
    } else {
        // ATM
        input.disabled = true;
        input.placeholder = 'Auto (ATM)';
        input.value = '';
        label.textContent = '7. Strike Value';
    }
}

// Save strategy
function saveStrategy(execute = false) {
    const legs = [];
    document.querySelectorAll('.leg-item').forEach((legItem, index) => {
        const strikeSelect = legItem.querySelector('.leg-strike-selection');
        const selectedOption = strikeSelect?.options[strikeSelect.selectedIndex];
        const strikeValue = legItem.querySelector('.leg-strike-value').value;

        // Determine strike offset for ITM/OTM selections
        let strikeOffset = 0;
        if (selectedOption && selectedOption.dataset.offset) {
            strikeOffset = parseInt(selectedOption.dataset.offset) || 0;
        }

        const orderType = legItem.querySelector('.leg-order-type').value;
        const priceCondition = legItem.querySelector('.leg-price-condition')?.value;
        const limitPrice = legItem.querySelector('.leg-limit-price')?.value;
        const lots = parseInt(legItem.querySelector('.leg-lots').value) || 1;

        // Calculate quantity based on instrument and lots
        // Use lot sizes from database (fetched on page load)
        const instrument = legItem.querySelector('.leg-instrument').value;
        let lotSize = lotSizes[instrument] || 75; // Use fetched lot size or default to 75
        const calculatedQuantity = lots * lotSize;
        console.log(`Leg ${index + 1}: ${instrument} - lots=${lots}, lotSize=${lotSize}, quantity=${calculatedQuantity}`);

        legs.push({
            instrument: instrument,
            product_type: legItem.querySelector('.leg-product-type').value,
            expiry: legItem.querySelector('.leg-expiry').value,
            action: legItem.querySelector('.leg-action').value,
            option_type: legItem.querySelector('.leg-option-type')?.value,
            strike_selection: strikeSelect?.value,
            strike_price: strikeSelect?.value === 'strike_price' ? parseFloat(strikeValue) : null,
            strike_offset: strikeOffset,
            premium_value: strikeSelect?.value === 'premium_near' ? parseFloat(strikeValue) : null,
            lots: lots,
            quantity: calculatedQuantity,  // Use calculated quantity
            order_type: orderType,
            price_condition: orderType === 'LIMIT' ? priceCondition : null,
            limit_price: limitPrice ? parseFloat(limitPrice) : null,
            trigger_price: null,
            stop_loss_type: 'percentage',
            stop_loss_value: parseFloat(legItem.querySelector('.leg-sl').value) || null,
            take_profit_type: 'percentage',
            take_profit_value: parseFloat(legItem.querySelector('.leg-tp').value) || null
        });
    });

    const selectedAccounts = Array.from(document.querySelectorAll('input[name="accounts"]:checked'))
        .map(cb => parseInt(cb.value));

    const strategyData = {
        name: document.getElementById('strategyName').value,
        risk_profile: document.getElementById('riskProfile').value,
        market_condition: document.getElementById('marketCondition').value,
        selected_accounts: selectedAccounts,
        allocation_type: 'equal',
        max_loss: parseFloat(document.getElementById('maxLoss').value) || null,
        max_profit: parseFloat(document.getElementById('maxProfit').value) || null,
        trailing_sl: parseFloat(document.getElementById('trailingSl').value) || null,
        legs: legs
    };

    const url = {% if strategy %}'/strategy/builder/{{ strategy.id }}'{% else %}'/strategy/builder'{% endif %};

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify(strategyData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('Strategy saved successfully', 'success');

            if (execute) {
                // Execute the strategy
                fetch(`/strategy/execute/${data.strategy_id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    }
                })
                .then(response => response.json())
                .then(execData => {
                    // Handle different execution statuses
                    if (execData.status === 'success') {
                        showNotification(execData.message || 'Strategy executed successfully', 'success');
                        setTimeout(() => window.location.href = '/strategy', 2000);
                    } else if (execData.status === 'warning') {
                        // Orders were skipped due to insufficient margin
                        showNotification(execData.message || 'Strategy execution skipped', 'warning');
                        // Show details if available
                        if (execData.results && execData.results.length > 0) {
                            console.log('Execution details:', execData.results);
                        }
                    } else if (execData.status === 'partial') {
                        // Some orders succeeded, some failed/skipped
                        showNotification(execData.message || 'Strategy partially executed', 'warning');
                    } else {
                        // Error status
                        showNotification(execData.message || 'Strategy execution failed', 'error');
                    }
                });
            } else {
                setTimeout(() => window.location.href = '/strategy', 1500);
            }
        } else {
            showNotification(data.message || 'Failed to save strategy', 'error');
        }
    })
    .catch(error => {
        showNotification('Error saving strategy', 'error');
        console.error('Error:', error);
    });
}

// Save as template
function saveAsTemplate() {
    saveStrategy(false);
    // Additional logic to mark as template would go here
}

// Show notification
function showNotification(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast toast-end`;

    // Map type to appropriate alert class
    let alertClass = 'alert-info';
    if (type === 'success') {
        alertClass = 'alert-success';
    } else if (type === 'error') {
        alertClass = 'alert-error';
    } else if (type === 'warning') {
        alertClass = 'alert-warning';
    }

    toast.innerHTML = `
        <div class="alert ${alertClass}">
            <span>${message}</span>
        </div>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);  // Show for 5 seconds for important messages
}

// Initialize with existing data or add first leg
document.addEventListener('DOMContentLoaded', async function() {
    // Fetch lot sizes from database first
    await fetchLotSizes();

    console.log('Strategy object:', {{ 'true' if strategy else 'false' }});
    {% if strategy %}
        console.log('Strategy ID: {{ strategy.id }}');
    {% endif %}
    console.log('Strategy legs:', {{ strategy_legs|length if strategy_legs else 0 }});

    {% if strategy_legs and strategy_legs|length > 0 %}
        console.log('Loading {{ strategy_legs|length }} existing legs for strategy');
        // Load existing legs
        {% for leg in strategy_legs %}
        {
            console.log('Loading leg {{ loop.index }}: {{ leg.instrument }} {{ leg.action }}');
            addLeg();
            const legItem = document.querySelectorAll('.leg-item')[{{ loop.index0 }}];

            // Populate basic fields
            legItem.querySelector('.leg-instrument').value = '{{ leg.instrument }}';
            legItem.querySelector('.leg-product-type').value = '{{ leg.product_type }}';
            legItem.querySelector('.leg-expiry').value = '{{ leg.expiry }}';
            legItem.querySelector('.leg-action').value = '{{ leg.action }}';

            // Important: Use lots from database, not the stored quantity
            // This ensures we use the correct lot size from TradingSettings
            const lots = {{ leg.lots or 1 }};
            legItem.querySelector('.leg-lots').value = lots;

            // Recalculate quantity based on current lot size from database
            const instrument = '{{ leg.instrument }}';
            const lotSize = lotSizes[instrument] || 75;
            console.log(`Leg {{ loop.index }}: Using lot size ${lotSize} for ${instrument}, lots=${lots}, calculated quantity=${lots * lotSize}`);

            legItem.querySelector('.leg-order-type').value = '{{ leg.order_type or "MARKET" }}';

            // Populate option fields if options
            {% if leg.product_type == 'options' %}
            legItem.querySelector('.leg-option-type').value = '{{ leg.option_type or "" }}';
            legItem.querySelector('.leg-strike-selection').value = '{{ leg.strike_selection or "ATM" }}';

            // Set strike value based on selection
            {% if leg.strike_selection == 'strike_price' %}
            legItem.querySelector('.leg-strike-value').value = {{ leg.strike_price if leg.strike_price else '""' }};
            legItem.querySelector('.leg-strike-value').disabled = false;
            {% elif leg.strike_selection == 'premium_near' %}
            legItem.querySelector('.leg-strike-value').value = {{ leg.premium_value if leg.premium_value else '""' }};
            legItem.querySelector('.leg-strike-value').disabled = false;
            {% elif leg.strike_selection in ['ITM', 'OTM'] %}
            legItem.querySelector('.leg-strike-value').dataset.offset = '{{ leg.strike_offset or 0 }}';
            // Find and select the correct ITM/OTM option with offset
            const strikeSelect = legItem.querySelector('.leg-strike-selection');
            for (let option of strikeSelect.options) {
                if (option.value === '{{ leg.strike_selection }}' && option.dataset.offset === '{{ leg.strike_offset }}') {
                    strikeSelect.value = option.value;
                    option.selected = true;
                    break;
                }
            }
            {% endif %}
            {% endif %}

            // Populate price fields based on order type
            {% if leg.order_type == 'LIMIT' %}
            togglePriceFields(legItem.querySelector('.leg-order-type'));
            {% if leg.price_condition %}
            legItem.querySelector('.leg-price-condition').value = '{{ leg.price_condition }}';
            {% endif %}
            {% if leg.limit_price %}
            legItem.querySelector('.leg-limit-price').value = {{ leg.limit_price }};
            {% endif %}
            {% endif %}

            // Populate stop loss and take profit
            {% if leg.stop_loss_value %}
            legItem.querySelector('.leg-sl').value = {{ leg.stop_loss_value }};
            {% endif %}
            {% if leg.take_profit_value %}
            legItem.querySelector('.leg-tp').value = {{ leg.take_profit_value }};
            {% endif %}

            // Toggle option fields if futures
            {% if leg.product_type == 'futures' %}
            toggleOptionFields(legItem.querySelector('.leg-product-type'));
            {% endif %}
        }
        {% endfor %}
    {% else %}
        // Add first leg by default
        addLeg();
    {% endif %}

    // Load strategy execution data if editing existing strategy
    {% if strategy %}
    loadStrategyData();
    {% endif %}
});

// Strategy-level execution tracking functions
function showStrategyTab(tabName, element) {
    // Hide all tabs
    document.querySelectorAll('.strategy-tab').forEach(tab => {
        tab.classList.add('hidden');
    });

    // Remove active from all tab buttons
    document.querySelectorAll('.tabs .tab').forEach(tab => {
        tab.classList.remove('tab-active');
    });

    // Show selected tab
    document.getElementById(tabName + '-tab').classList.remove('hidden');
    element.classList.add('tab-active');
}

function loadStrategyData() {
    {% if strategy %}
    const strategyId = {{ strategy.id }};

    // Load orderbook
    loadOrderbook(strategyId);

    // Load tradebook
    loadTradebook(strategyId);

    // Load positions
    loadPositions(strategyId);
    {% endif %}
}

function refreshStrategyData() {
    loadStrategyData();
    showToast('Data refreshed', 'success');
}

async function loadOrderbook(strategyId) {
    try {
        const response = await fetch(`/strategy/${strategyId}/orderbook`);
        const data = await response.json();

        if (data.status === 'success' && data.data) {
            const tbody = document.getElementById('orderbook-body');
            tbody.innerHTML = '';

            const orders = data.data.orders || [];
            const stats = data.data.statistics || {};

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-base-content/60">No orders found</td></tr>';
            } else {
                orders.forEach(order => {
                    const row = tbody.insertRow();
                    const statusColor = order.order_status === 'complete' ? 'badge-success' :
                                      order.order_status === 'rejected' ? 'badge-error' :
                                      order.order_status === 'open' ? 'badge-warning' : 'badge-outline';
                    row.innerHTML = `
                        <td class="text-xs">${order.orderid || '-'}</td>
                        <td>${order.symbol}</td>
                        <td>${order.exchange}</td>
                        <td>${order.product}</td>
                        <td><span class="badge ${order.action === 'BUY' ? 'badge-success' : 'badge-error'} badge-sm">${order.action}</span></td>
                        <td>${order.quantity}</td>
                        <td>₹${order.price || 0}</td>
                        <td><span class="badge ${statusColor} badge-sm">${order.order_status}</span></td>
                        <td class="text-xs">${order.timestamp || '-'}</td>
                    `;
                });
            }

            // Update statistics if available
            if (stats.total_buy_orders !== undefined) {
                const statsDiv = document.getElementById('order-stats');
                if (statsDiv) {
                    statsDiv.innerHTML = `
                        <div class="stats shadow">
                            <div class="stat py-2">
                                <div class="stat-title text-xs">Buy Orders</div>
                                <div class="stat-value text-sm">${stats.total_buy_orders}</div>
                            </div>
                            <div class="stat py-2">
                                <div class="stat-title text-xs">Sell Orders</div>
                                <div class="stat-value text-sm">${stats.total_sell_orders}</div>
                            </div>
                            <div class="stat py-2">
                                <div class="stat-title text-xs">Completed</div>
                                <div class="stat-value text-sm text-success">${stats.total_completed_orders}</div>
                            </div>
                            <div class="stat py-2">
                                <div class="stat-title text-xs">Open</div>
                                <div class="stat-value text-sm text-warning">${stats.total_open_orders}</div>
                            </div>
                            <div class="stat py-2">
                                <div class="stat-title text-xs">Rejected</div>
                                <div class="stat-value text-sm text-error">${stats.total_rejected_orders}</div>
                            </div>
                        </div>
                    `;
                }
            }
        }
    } catch (error) {
        console.error('Error loading orderbook:', error);
    }
}

async function loadTradebook(strategyId) {
    try {
        const response = await fetch(`/strategy/${strategyId}/tradebook`);
        const data = await response.json();

        if (data.status === 'success' && data.data) {
            const tbody = document.getElementById('tradebook-body');
            tbody.innerHTML = '';

            const trades = data.data || [];

            if (trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-base-content/60">No trades found</td></tr>';
            } else {
                let totalTradeValue = 0;
                trades.forEach(trade => {
                    totalTradeValue += trade.trade_value || 0;
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td class="text-xs">${trade.orderid || '-'}</td>
                        <td>${trade.symbol}</td>
                        <td>${trade.exchange}</td>
                        <td>${trade.product}</td>
                        <td><span class="badge ${trade.action === 'BUY' ? 'badge-success' : 'badge-error'} badge-sm">${trade.action}</span></td>
                        <td>₹${trade.average_price || 0}</td>
                        <td>₹${trade.trade_value ? trade.trade_value.toFixed(2) : '0.00'}</td>
                        <td class="text-xs">${trade.timestamp || '-'}</td>
                    `;
                });

                // Update total trade value
                const totalValueEl = document.getElementById('total-trade-value');
                if (totalValueEl) {
                    totalValueEl.textContent = `₹${totalTradeValue.toFixed(2)}`;
                }
            }
        }
    } catch (error) {
        console.error('Error loading tradebook:', error);
    }
}

async function loadPositions(strategyId) {
    try {
        const response = await fetch(`/strategy/${strategyId}/positions`);
        const data = await response.json();

        if (data.status === 'success' && data.data) {
            const tbody = document.getElementById('positions-body');
            tbody.innerHTML = '';

            const positions = data.data || [];

            if (positions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-base-content/60">No open positions</td></tr>';
            } else {
                let totalPnl = 0;
                positions.forEach(position => {
                    const pnl = parseFloat(position.pnl) || 0;
                    totalPnl += pnl;
                    const row = tbody.insertRow();
                    const qty = parseInt(position.quantity) || 0;
                    const action = qty < 0 ? 'SELL' : 'BUY';
                    row.innerHTML = `
                        <td>${position.symbol}</td>
                        <td>${position.exchange}</td>
                        <td>${position.product}</td>
                        <td><span class="badge ${action === 'BUY' ? 'badge-success' : 'badge-error'} badge-sm">${action}</span></td>
                        <td>${Math.abs(qty)}</td>
                        <td>₹${position.average_price || 0}</td>
                        <td>₹${position.ltp || 0}</td>
                        <td class="${pnl >= 0 ? 'text-success' : 'text-error'}">₹${pnl.toFixed(2)}</td>
                    `;
                });

                // Update total P&L
                const totalElement = document.getElementById('total-unrealized-pnl');
                if (totalElement) {
                    totalElement.textContent = `₹${totalPnl.toFixed(2)}`;
                    totalElement.className = totalPnl >= 0 ? 'stat-value text-success' : 'stat-value text-error';
                }
            }
        }
    } catch (error) {
        console.error('Error loading positions:', error);
    }
}

async function closeAllPositions() {
    {% if strategy %}
    if (!confirm('Are you sure you want to close all open positions for this strategy?')) {
        return;
    }

    try {
        const strategyId = {{ strategy.id }};
        const response = await fetch(`/strategy/${strategyId}/close-all`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            }
        });

        const data = await response.json();

        if (data.status === 'success') {
            showToast(data.message + ` Total P&L: ₹${data.total_pnl.toFixed(2)}`, 'success');
            // Reload the data
            loadStrategyData();
        } else {
            showToast(data.message || 'Failed to close positions', 'error');
        }
    } catch (error) {
        console.error('Error closing positions:', error);
        showToast('Error closing positions', 'error');
    }
    {% endif %}
}

// Auto-refresh data every 10 seconds when on positions tab
let refreshInterval;
document.addEventListener('DOMContentLoaded', function() {
    {% if strategy %}
    refreshInterval = setInterval(function() {
        const positionsTab = document.getElementById('positions-tab');
        if (!positionsTab.classList.contains('hidden')) {
            loadPositions({{ strategy.id }});
        }
    }, 10000);
    {% endif %}
});
</script>
{% endblock %}