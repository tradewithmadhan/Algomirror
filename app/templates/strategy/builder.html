{% extends "layout.html" %}

{% block title %}Strategy Builder - AlgoMirror{% endblock %}

{% block head %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block content %}
<style>
/* Frozen leg styling */
.leg-frozen {
    position: relative;
}
.leg-frozen::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, transparent 48%, rgba(34, 197, 94, 0.1) 48%, rgba(34, 197, 94, 0.1) 52%, transparent 52%);
    background-size: 20px 20px;
    pointer-events: none;
    border-radius: 0.5rem;
    z-index: 0;
}
.leg-frozen > * {
    position: relative;
    z-index: 1;
}
.cursor-not-allowed {
    cursor: not-allowed !important;
}

/* Force black text in all strategy leg inputs and selects */
.leg-item input,
.leg-item select,
.leg-item input:disabled,
.leg-item select:disabled,
.leg-item input.text-black,
.leg-item select.text-black,
.leg-item .input,
.leg-item .select,
.leg-item input[type="number"],
.leg-item input[type="text"],
.select.text-black,
.input.text-black {
    color: #000000 !important;
    -webkit-text-fill-color: #000000 !important;
    font-weight: normal !important;
}

/* Force black text for labels */
.leg-item .label-text {
    color: #000000 !important;
    font-weight: bold !important;
}

/* Override any DaisyUI default text colors */
.leg-item .select-bordered,
.leg-item .input-bordered {
    color: #000000 !important;
    -webkit-text-fill-color: #000000 !important;
    font-weight: normal !important;
}

/* Placeholder text should be slightly lighter but still visible */
.leg-item input::placeholder,
.leg-item input::-webkit-input-placeholder,
.leg-item input::-moz-placeholder,
.leg-item input:-ms-input-placeholder {
    color: #666666 !important;
    opacity: 1 !important;
    font-weight: normal !important;
}

/* Force black text even on option elements */
.leg-item select option {
    color: #000000 !important;
    font-weight: normal !important;
}

/* Force black text for disabled inputs added by JavaScript */
.leg-item .input-disabled,
.leg-item input.input-disabled,
.leg-item select.input-disabled,
.input-disabled {
    color: #000000 !important;
    -webkit-text-fill-color: #000000 !important;
    font-weight: normal !important;
}

/* Global override for all form elements in strategy builder */
#strategyForm input,
#strategyForm select,
#strategyForm input:disabled,
#strategyForm select:disabled {
    color: #000000 !important;
    -webkit-text-fill-color: #000000 !important;
    font-weight: normal !important;
}
</style>
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold">Strategy Builder</h1>
            <p class="text-base-content/70">Create multi-leg option strategies with 9 configurable parameters</p>
        </div>
        <a href="{{ url_for('main.dashboard') }}" class="btn btn-ghost">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Dashboard
        </a>
    </div>

    <form id="strategyForm" onsubmit="return false;">
        <!-- Basic Information Card -->
        <div class="card bg-base-100 shadow-lg mb-6">
            <div class="card-body">
                <h2 class="card-title mb-4">Basic Information</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Strategy Name</span>
                        </label>
                        <input type="text" id="strategyName" class="input input-bordered"
                               placeholder="e.g., Iron Condor Weekly" required
                               value="{{ strategy.name if strategy else '' }}">
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Risk Profile</span>
                        </label>
                        <select id="riskProfile" class="select select-bordered" onchange="toggleLotFields()">
                            <option value="fixed_lots" {% if strategy and strategy.risk_profile == 'fixed_lots' %}selected{% elif not strategy %}selected{% endif %}>Fixed Lot Size (Default)</option>
                            {% for quality in trade_qualities|sort(attribute='quality_grade') %}
                            <option value="grade_{{ quality.quality_grade }}" {% if strategy and strategy.risk_profile == 'grade_' ~ quality.quality_grade %}selected{% endif %}>
                                Grade {{ quality.quality_grade }} ({{ quality.margin_percentage|int }}% margin)
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Market Condition</span>
                        </label>
                        <select id="marketCondition" class="select select-bordered">
                            <option value="non_expiry" {% if strategy and strategy.market_condition == 'non_expiry' %}selected{% endif %}>Non-Expiry</option>
                            <option value="expiry" {% if strategy and strategy.market_condition == 'expiry' %}selected{% endif %}>Expiry Day</option>
                            <option value="any" {% if strategy and strategy.market_condition == 'any' %}selected{% endif %}>Any Day</option>
                        </select>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Product Order Type</span>
                        </label>
                        <select id="productOrderType" class="select select-bordered">
                            <option value="MIS" {% if strategy and strategy.product_order_type == 'MIS' %}selected{% elif not strategy %}selected{% endif %}>MIS (Intraday)</option>
                            <option value="NRML" {% if strategy and strategy.product_order_type == 'NRML' %}selected{% endif %}>NRML (Overnight)</option>
                        </select>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Select Accounts</span>
                        </label>
                        <div class="space-y-2" id="accounts-container">
                            {% for account in accounts %}
                            <label class="label cursor-pointer justify-start">
                                <input type="checkbox" class="checkbox checkbox-primary mr-3"
                                       name="accounts" value="{{ account.id }}"
                                       {% if strategy and strategy.selected_accounts and account.id in strategy.selected_accounts %}checked{% endif %}
                                       id="account-checkbox-{{ account.id }}">
                                <span>{{ account.account_name }} ({{ account.broker_name }})</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy Legs Card -->
        <div class="card bg-base-100 shadow-lg mb-6">
            <div class="card-body">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="card-title">Strategy Legs</h2>
                    <button type="button" onclick="addLeg()" class="btn btn-primary btn-sm">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Add Leg
                    </button>
                </div>

                <div id="strategyLegs">
                    <!-- Legs will be added dynamically -->
                </div>
            </div>
        </div>

        <!-- Risk Management Card -->
        <div class="card bg-base-100 shadow-lg mb-6">
            <div class="card-body">
                <h2 class="card-title mb-2">Risk Management</h2>
                <p class="text-xs text-base-content/60 mb-4">Check ONE option - Traditional OR Supertrend (mutually exclusive)</p>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <!-- Traditional Risk Management Column -->
                    <div class="border rounded-lg p-4" id="traditional-risk-section">
                        <div class="flex items-center gap-2 mb-3">
                            <input type="checkbox" id="useTraditionalRisk"
                                   class="checkbox checkbox-primary checkbox-sm"
                                   onchange="toggleRiskManagementType('traditional')"
                                   {% if strategy and not strategy.supertrend_exit_enabled and (strategy.max_loss or strategy.max_profit or strategy.trailing_sl) %}checked{% endif %}>
                            <label for="useTraditionalRisk" class="cursor-pointer">
                                <span class="font-semibold text-sm">Traditional</span>
                            </label>
                        </div>
                        <div class="space-y-3" id="traditional-risk-fields">
                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text text-xs">Max Loss (₹)</span>
                                </label>
                                <input type="number" id="maxLoss" class="input input-bordered input-sm"
                                       placeholder="0" value="{{ strategy.max_loss if strategy else '0' }}">
                            </div>
                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text text-xs">Max Profit (₹)</span>
                                </label>
                                <input type="number" id="maxProfit" class="input input-bordered input-sm"
                                       placeholder="0" value="{{ strategy.max_profit if strategy else '0' }}">
                            </div>
                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text text-xs">Trailing SL (%)</span>
                                </label>
                                <input type="number" id="trailingSl" class="input input-bordered input-sm"
                                       placeholder="0" step="0.1" value="{{ strategy.trailing_sl if strategy else '0' }}">
                            </div>
                        </div>
                    </div>

                    <!-- Supertrend Exit Column -->
                    <div class="border rounded-lg p-4" id="supertrend-risk-section">
                        <div class="flex items-center gap-2 mb-3">
                            <input type="checkbox" id="useSupertrendExit"
                                   class="checkbox checkbox-primary checkbox-sm"
                                   onchange="toggleRiskManagementType('supertrend')"
                                   {% if strategy and strategy.supertrend_exit_enabled %}checked{% endif %}>
                            <label for="useSupertrendExit" class="cursor-pointer">
                                <span class="font-semibold text-sm">Supertrend Exit</span>
                            </label>
                        </div>
                        <div class="grid grid-cols-2 gap-2" id="supertrend-risk-fields">
                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text text-xs">Exit Type</span>
                                </label>
                                <select id="supertrendExitType" class="select select-bordered select-sm" disabled>
                                    <option value="breakout" {% if strategy and strategy.supertrend_exit_type == 'breakout' %}selected{% endif %}>Breakout (Net Credit)</option>
                                    <option value="breakdown" {% if strategy and strategy.supertrend_exit_type == 'breakdown' %}selected{% endif %}>Breakdown (Net Debit)</option>
                                </select>
                            </div>
                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text text-xs">Timeframe</span>
                                </label>
                                <select id="supertrendTimeframe" class="select select-bordered select-sm" disabled>
                                    <option value="3m" {% if strategy and strategy.supertrend_timeframe == '3m' %}selected{% endif %}>3m</option>
                                    <option value="5m" {% if strategy and strategy.supertrend_timeframe == '5m' %}selected{% endif %}>5m</option>
                                    <option value="10m" {% if strategy and strategy.supertrend_timeframe == '10m' %}selected{% elif not strategy %}selected{% endif %}>10m</option>
                                    <option value="15m" {% if strategy and strategy.supertrend_timeframe == '15m' %}selected{% endif %}>15m</option>
                                </select>
                            </div>
                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text text-xs">Period</span>
                                </label>
                                <input type="number" id="supertrendPeriod" class="input input-bordered input-sm"
                                       placeholder="10" min="5" max="20" disabled
                                       value="{{ strategy.supertrend_period if strategy and strategy.supertrend_period else '10' }}">
                            </div>
                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text text-xs">Multiplier</span>
                                </label>
                                <input type="number" id="supertrendMultiplier" class="input input-bordered input-sm"
                                       placeholder="3.0" min="1" max="10" step="0.5" disabled
                                       value="{{ strategy.supertrend_multiplier if strategy and strategy.supertrend_multiplier else '3.0' }}">
                            </div>
                        </div>
                        <div class="mt-3 text-xs text-base-content/70">
                            <strong>Note:</strong> Exits once on candle close when signal triggers.
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-wrap justify-end gap-3 mt-4">
                    {% if strategy %}
                    <a href="{{ url_for('tradingview.strategy_monitor', strategy_id=strategy.id) }}" class="btn btn-info btn-sm" target="_blank">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        Spread Monitor
                    </a>
                    {% endif %}
                    <button type="button" onclick="saveStrategy(false)" class="btn btn-primary btn-outline btn-sm">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                        </svg>
                        Save Strategy
                    </button>
                    <button type="button" onclick="saveStrategy(true)" class="btn btn-primary btn-sm">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        Save & Execute
                    </button>
                </div>
            </div>
        </div>

        {% if strategy %}
        <!-- Strategy Execution Tracking Section -->

        <!-- Tabs for Orderbook, Tradebook, Positions -->
        <div class="card bg-base-100 shadow-lg mb-6">
            <div class="card-body">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="card-title">Strategy Execution Tracking</h2>
                    <div class="flex gap-2">
                        <button type="button" onclick="refreshStrategyData()" class="btn btn-ghost btn-sm">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Refresh
                        </button>
                        <button type="button" onclick="closeAllPositions()" class="btn btn-error btn-sm">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            Close All Positions
                        </button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="border-b border-base-300 mb-4">
                    <div class="flex space-x-2">
                        <button type="button" class="px-6 py-3 font-semibold border-b-2 border-transparent text-base-content/60 hover:text-base-content hover:border-base-300" id="tab-orderbook" onclick="showStrategyTab('orderbook', this)">
                            Orderbook
                        </button>
                        <button type="button" class="px-6 py-3 font-semibold border-b-2 border-transparent text-base-content/60 hover:text-base-content hover:border-base-300" id="tab-tradebook" onclick="showStrategyTab('tradebook', this)">
                            Tradebook
                        </button>
                        <button type="button" class="px-6 py-3 font-semibold border-b-2 border-primary text-primary" id="tab-positions" onclick="showStrategyTab('positions', this)">
                            Positions
                        </button>
                        <button type="button" class="px-6 py-3 font-semibold border-b-2 border-transparent text-base-content/60 hover:text-base-content hover:border-base-300" id="tab-riskmonitor" onclick="showStrategyTab('riskmonitor', this)">
                            Risk Monitor
                        </button>
                    </div>
                </div>

                <!-- Orderbook Tab -->
                <div id="orderbook-tab" class="strategy-tab hidden">
                    <div id="order-stats" class="mb-4"></div>
                    <div class="overflow-x-auto">
                        <table class="table table-compact">
                            <thead>
                                <tr>
                                    <th>Account</th>
                                    <th>Leg</th>
                                    <th>Order ID</th>
                                    <th>Symbol</th>
                                    <th>Exchange</th>
                                    <th>Product</th>
                                    <th>Action</th>
                                    <th>Qty</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                            <tbody id="orderbook-body">
                                <tr>
                                    <td colspan="11" class="text-center text-base-content/60">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tradebook Tab -->
                <div id="tradebook-tab" class="strategy-tab hidden">
                    <div class="overflow-x-auto">
                        <table class="table table-compact">
                            <thead>
                                <tr>
                                    <th>Account</th>
                                    <th>Leg</th>
                                    <th>Order ID</th>
                                    <th>Symbol</th>
                                    <th>Exchange</th>
                                    <th>Product</th>
                                    <th>Action</th>
                                    <th>Qty</th>
                                    <th>Avg Price</th>
                                    <th>Trade Value</th>
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                            <tbody id="tradebook-body">
                                <tr>
                                    <td colspan="11" class="text-center text-base-content/60">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="stats shadow mt-4">
                        <div class="stat">
                            <div class="stat-title">Total P&L (Realized + Unrealized)</div>
                            <div class="stat-value" id="total-pnl">
                                {% if strategy %}
                                    ₹{{ "%.2f"|format(strategy.total_pnl) }}
                                {% else %}
                                    ₹0.00
                                {% endif %}
                            </div>
                            <div class="stat-desc">Persists even after positions close</div>
                        </div>
                        {% if strategy %}
                        <div class="stat">
                            <div class="stat-title">Realized P&L</div>
                            <div class="stat-value text-sm {% if strategy.realized_pnl >= 0 %}text-success{% else %}text-error{% endif %}" id="realized-pnl">
                                ₹{{ "%.2f"|format(strategy.realized_pnl) }}
                            </div>
                            <div class="stat-desc">From closed positions</div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Positions Tab -->
                <div id="positions-tab" class="strategy-tab">
                    <div class="overflow-x-auto">
                        <table class="table table-compact">
                            <thead>
                                <tr>
                                    <th>Account</th>
                                    <th>Leg</th>
                                    <th>Symbol</th>
                                    <th>Risk</th>
                                    <th>Product</th>
                                    <th>Type</th>
                                    <th>Action</th>
                                    <th>Qty</th>
                                    <th>Avg Price</th>
                                    <th>LTP</th>
                                    <th>P&L</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="positions-body">
                                <tr>
                                    <td colspan="11" class="text-center text-base-content/60">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="stats shadow mt-4">
                        <div class="stat">
                            <div class="stat-title">Total P&L (Realized + Unrealized)</div>
                            <div class="stat-value" id="total-positions-pnl">
                                {% if strategy %}
                                    ₹{{ "%.2f"|format(strategy.total_pnl) }}
                                {% else %}
                                    ₹0.00
                                {% endif %}
                            </div>
                            <div class="stat-desc">Includes open and closed positions</div>
                        </div>
                        {% if strategy %}
                        <div class="stat">
                            <div class="stat-title">Open Positions</div>
                            <div class="stat-value text-sm" id="open-positions-count">0</div>
                            <div class="stat-desc">Currently active</div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Risk Monitor Tab -->
                <div id="riskmonitor-tab" class="strategy-tab hidden">
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-semibold">Leg-Level Risk Tracking</h3>
                            <span class="badge badge-sm" id="riskMonitorConnection">
                                <span class="loading loading-spinner loading-xs"></span> Connecting...
                            </span>
                        </div>
                        <p class="text-sm text-base-content/60">Real-time stop loss and take profit monitoring for each leg</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="table table-compact">
                            <thead>
                                <tr>
                                    <th>Leg</th>
                                    <th>Symbol</th>
                                    <th>Action</th>
                                    <th>Entry</th>
                                    <th>LTP</th>
                                    <th>SL Price</th>
                                    <th>SL Dist</th>
                                    <th>TP Price</th>
                                    <th>TP Dist</th>
                                    <th>P&L</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="riskmonitor-body">
                                <tr>
                                    <td colspan="11" class="text-center text-base-content/60">Loading risk data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="stats shadow mt-4">
                        <div class="stat">
                            <div class="stat-title">Total Unrealized P&L</div>
                            <div class="stat-value" id="riskmonitor-total-pnl">₹0.00</div>
                            <div class="stat-desc">Real-time from WebSocket</div>
                        </div>
                        <div class="stat">
                            <div class="stat-title">Legs with SL</div>
                            <div class="stat-value text-sm" id="riskmonitor-sl-count">0</div>
                            <div class="stat-desc">Stop loss configured</div>
                        </div>
                        <div class="stat">
                            <div class="stat-title">Legs with TP</div>
                            <div class="stat-value text-sm" id="riskmonitor-tp-count">0</div>
                            <div class="stat-desc">Take profit configured</div>
                        </div>
                    </div>
                </div>

                <!-- Risk Status Section -->
                {% if strategy %}
                <div class="bg-base-200 rounded-lg p-4 mt-4" id="riskStatusSection">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-semibold flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                            Risk Status
                            <span class="badge badge-sm" id="riskConnectionStatus">
                                <span class="loading loading-spinner loading-xs"></span>
                            </span>
                        </h3>
                        <div class="text-sm">
                            <span class="text-base-content/60">Current P&L:</span>
                            <span class="font-bold text-lg ml-1" id="riskCurrentPnl">₹0.00</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Max Loss -->
                        {% if strategy.max_loss %}
                        <div class="bg-base-100 rounded-lg p-3">
                            <div class="flex justify-between text-sm mb-2">
                                <span class="flex items-center gap-1">
                                    <svg class="w-4 h-4 text-error" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path>
                                    </svg>
                                    Max Loss
                                </span>
                                <span class="font-mono font-bold">₹{{ strategy.max_loss }}</span>
                            </div>
                            <progress class="progress progress-error w-full h-3" id="riskMaxLossProgress" value="0" max="100"></progress>
                            <div class="flex justify-between text-xs mt-1">
                                <span id="riskMaxLossAmount">₹0.00</span>
                                <span id="riskMaxLossPct">0%</span>
                            </div>
                            {% if strategy.auto_exit_on_max_loss %}
                            <div class="badge badge-error badge-xs mt-2">Auto Exit</div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Max Profit -->
                        {% if strategy.max_profit %}
                        <div class="bg-base-100 rounded-lg p-3">
                            <div class="flex justify-between text-sm mb-2">
                                <span class="flex items-center gap-1">
                                    <svg class="w-4 h-4 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                    </svg>
                                    Max Profit
                                </span>
                                <span class="font-mono font-bold">₹{{ strategy.max_profit }}</span>
                            </div>
                            <progress class="progress progress-success w-full h-3" id="riskMaxProfitProgress" value="0" max="100"></progress>
                            <div class="flex justify-between text-xs mt-1">
                                <span id="riskMaxProfitAmount">₹0.00</span>
                                <span id="riskMaxProfitPct">0%</span>
                            </div>
                            {% if strategy.auto_exit_on_max_profit %}
                            <div class="badge badge-success badge-xs mt-2">Auto Exit</div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Trailing SL -->
                        {% if strategy.trailing_sl %}
                        <div class="bg-base-100 rounded-lg p-3">
                            <div class="flex justify-between text-sm mb-2">
                                <span class="flex items-center gap-1">
                                    <svg class="w-4 h-4 text-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                    Trailing SL
                                </span>
                                <span class="font-mono font-bold">{{ strategy.trailing_sl }}{{ '%' if strategy.trailing_sl_type == 'percentage' else ' pts' if strategy.trailing_sl_type == 'points' else '' }}</span>
                            </div>
                            <div class="text-sm">
                                <span class="text-base-content/60">Status:</span>
                                <span class="badge badge-warning badge-sm ml-1" id="riskTrailingSLStatus">Inactive</span>
                            </div>
                            <div class="text-xs mt-2">
                                <span class="text-base-content/60">Triggered at:</span>
                                <span id="riskTrailingSLTrigger">--</span>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Supertrend Exit -->
                        {% if strategy.supertrend_exit_enabled %}
                        <div class="bg-base-100 rounded-lg p-3">
                            <div class="flex justify-between text-sm mb-2">
                                <span class="flex items-center gap-1">
                                    <svg class="w-4 h-4 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                                    </svg>
                                    Supertrend Exit
                                </span>
                                <span class="font-mono font-bold text-xs">{{ strategy.supertrend_multiplier }},{{ strategy.supertrend_period }},{{ strategy.supertrend_timeframe }}</span>
                            </div>
                            <div class="text-sm mb-2">
                                <span class="text-base-content/60">Type:</span>
                                <span class="badge badge-outline badge-sm ml-1">{% if strategy.supertrend_exit_type == 'breakout' %}Breakout (Net Credit){% elif strategy.supertrend_exit_type == 'breakdown' %}Breakdown (Net Debit){% else %}Breakout (Net Credit){% endif %}</span>
                            </div>
                            <div class="text-sm">
                                <span class="text-base-content/60">Status:</span>
                                <span class="badge {{ 'badge-error' if strategy.supertrend_exit_triggered else 'badge-success' }} badge-sm ml-1" id="riskSupertrendStatus">
                                    {{ 'Triggered' if strategy.supertrend_exit_triggered else 'Active' }}
                                </span>
                            </div>
                            <div class="mt-2">
                                <a href="{{ url_for('tradingview.strategy_monitor', strategy_id=strategy.id) }}" class="btn btn-info btn-xs" target="_blank">
                                    View Spread Monitor
                                </a>
                            </div>
                        </div>

                        <!-- Combined Premium (for Supertrend strategies) -->
                        <div class="bg-base-100 rounded-lg p-3">
                            <div class="flex justify-between text-sm mb-2">
                                <span class="flex items-center gap-1">
                                    <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    Combined Premium
                                </span>
                                <span class="badge badge-sm" id="riskPremiumConnection">
                                    <span class="loading loading-spinner loading-xs"></span>
                                </span>
                            </div>
                            <div class="text-center my-2">
                                <span class="font-mono font-bold text-2xl" id="riskCombinedPremium">--</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div>
                                    <span class="text-base-content/60">Supertrend:</span>
                                    <span class="font-mono ml-1" id="riskSupertrendValue">--</span>
                                </div>
                                <div>
                                    <span class="text-base-content/60">Signal:</span>
                                    <span class="badge badge-sm ml-1" id="riskSupertrendSignal">--</span>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Leg-level SL/TP Tracking -->
                    <div id="legRiskTracking" class="mt-4">
                        <h4 class="text-sm font-semibold mb-2">Leg-Level Risk Tracking</h4>
                        <div class="overflow-x-auto">
                            <table class="table table-xs">
                                <thead>
                                    <tr>
                                        <th>Leg</th>
                                        <th>Symbol</th>
                                        <th>LTP</th>
                                        <th>SL</th>
                                        <th>SL Dist</th>
                                        <th>TP</th>
                                        <th>TP Dist</th>
                                    </tr>
                                </thead>
                                <tbody id="legRiskTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Last Update -->
                    <div class="text-xs text-base-content/50 mt-3 text-right">
                        Last update: <span id="riskLastUpdate">--:--:--</span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </form>
</div>

<!-- Leg Template -->
<template id="legTemplate">
    <div class="leg-item border rounded-lg p-4 mb-4" data-is-executed="false">
        <div class="flex justify-between items-center mb-3">
            <h3 class="font-semibold">
                Leg <span class="leg-number">1</span>
                <span class="leg-status-badge badge badge-sm badge-success ml-2" style="display:none;">EXECUTED</span>
            </h3>
            <div class="flex gap-2">
                <button type="button" onclick="closeLegAllAccounts(this)" class="btn btn-error btn-sm leg-close-btn" style="display:none;">
                    Close
                </button>
                <button type="button" onclick="modifyLegPrice(this)" class="btn btn-warning btn-sm leg-modify-btn" style="display:none;">
                    Modify Price
                </button>
                <button type="button" onclick="convertToMarket(this)" class="btn btn-success btn-sm leg-convert-btn" style="display:none;">
                    Convert to Market
                </button>
                <button type="button" onclick="cancelLegOrder(this)" class="btn btn-error btn-sm leg-cancel-btn" style="display:none;">
                    Cancel Order
                </button>
                <button type="button" onclick="removeLeg(this)" class="btn btn-ghost btn-sm leg-remove-btn">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Row 1 -->
        <div class="grid gap-2 mb-2" style="grid-template-columns: repeat(6, minmax(0, 1fr));">
            <div class="form-control">
                <label class="label py-1"><span class="label-text text-xs font-semibold text-black">1. Instrument</span></label>
                <select class="select select-bordered select-sm leg-instrument text-black">
                    <option value="NIFTY">NIFTY</option>
                    <option value="BANKNIFTY">BANKNIFTY</option>
                    <option value="SENSEX">SENSEX</option>
                </select>
            </div>

            <div class="form-control">
                <label class="label py-1"><span class="label-text text-xs font-semibold text-black">2. Product Type</span></label>
                <select class="select select-bordered select-sm leg-product-type text-black" onchange="toggleOptionFields(this)">
                    <option value="options">Options</option>
                    <option value="futures">Futures</option>
                </select>
            </div>

            <div class="form-control">
                <label class="label py-1"><span class="label-text text-xs font-semibold text-black">3. Expiry</span></label>
                <select class="select select-bordered select-sm leg-expiry text-black">
                    <option value="current_week">Current Week</option>
                    <option value="next_week">Next Week</option>
                    <option value="current_month">Current Month</option>
                    <option value="next_month">Next Month</option>
                </select>
            </div>

            <div class="form-control">
                <label class="label py-1"><span class="label-text text-xs font-semibold text-black">4. Action</span></label>
                <select class="select select-bordered select-sm leg-action text-black">
                    <option value="BUY">BUY</option>
                    <option value="SELL">SELL</option>
                </select>
            </div>

            <div class="form-control option-field">
                <label class="label py-1"><span class="label-text text-xs font-semibold text-black">5. Option Type</span></label>
                <select class="select select-bordered select-sm leg-option-type text-black">
                    <option value="CE">Call (CE)</option>
                    <option value="PE">Put (PE)</option>
                </select>
            </div>

            <div class="form-control option-field">
                <label class="label py-1"><span class="label-text text-xs font-semibold text-black">6. Strike Selection</span></label>
                <select class="select select-bordered select-sm leg-strike-selection text-black" onchange="toggleStrikeInput(this)">
                    <option value="ATM">ATM (At The Money)</option>
                    <optgroup label="In The Money">
                        <option value="ITM" data-offset="1">ITM 1</option>
                        <option value="ITM" data-offset="2">ITM 2</option>
                        <option value="ITM" data-offset="3">ITM 3</option>
                        <option value="ITM" data-offset="4">ITM 4</option>
                        <option value="ITM" data-offset="5">ITM 5</option>
                        <option value="ITM" data-offset="6">ITM 6</option>
                        <option value="ITM" data-offset="7">ITM 7</option>
                        <option value="ITM" data-offset="8">ITM 8</option>
                        <option value="ITM" data-offset="9">ITM 9</option>
                        <option value="ITM" data-offset="10">ITM 10</option>
                        <option value="ITM" data-offset="11">ITM 11</option>
                        <option value="ITM" data-offset="12">ITM 12</option>
                        <option value="ITM" data-offset="13">ITM 13</option>
                        <option value="ITM" data-offset="14">ITM 14</option>
                        <option value="ITM" data-offset="15">ITM 15</option>
                        <option value="ITM" data-offset="16">ITM 16</option>
                        <option value="ITM" data-offset="17">ITM 17</option>
                        <option value="ITM" data-offset="18">ITM 18</option>
                        <option value="ITM" data-offset="19">ITM 19</option>
                        <option value="ITM" data-offset="20">ITM 20</option>
                    </optgroup>
                    <optgroup label="Out of The Money">
                        <option value="OTM" data-offset="1">OTM 1</option>
                        <option value="OTM" data-offset="2">OTM 2</option>
                        <option value="OTM" data-offset="3">OTM 3</option>
                        <option value="OTM" data-offset="4">OTM 4</option>
                        <option value="OTM" data-offset="5">OTM 5</option>
                        <option value="OTM" data-offset="6">OTM 6</option>
                        <option value="OTM" data-offset="7">OTM 7</option>
                        <option value="OTM" data-offset="8">OTM 8</option>
                        <option value="OTM" data-offset="9">OTM 9</option>
                        <option value="OTM" data-offset="10">OTM 10</option>
                        <option value="OTM" data-offset="11">OTM 11</option>
                        <option value="OTM" data-offset="12">OTM 12</option>
                        <option value="OTM" data-offset="13">OTM 13</option>
                        <option value="OTM" data-offset="14">OTM 14</option>
                        <option value="OTM" data-offset="15">OTM 15</option>
                        <option value="OTM" data-offset="16">OTM 16</option>
                        <option value="OTM" data-offset="17">OTM 17</option>
                        <option value="OTM" data-offset="18">OTM 18</option>
                        <option value="OTM" data-offset="19">OTM 19</option>
                        <option value="OTM" data-offset="20">OTM 20</option>
                    </optgroup>
                    <option value="strike_price">Specific Strike</option>
                    <option value="premium_near">Premium Near</option>
                </select>
            </div>
        </div>

        <!-- Row 2 -->
        <div class="grid gap-2" style="grid-template-columns: repeat(6, minmax(0, 1fr));">
            <div class="form-control">
                <label class="label py-1"><span class="label-text text-xs font-semibold text-black leg-strike-label">7. Strike Value</span></label>
                <input type="number" class="input input-bordered input-sm leg-strike-value text-black" placeholder="Auto" disabled>
            </div>

            <div class="form-control">
                <label class="label py-1"><span class="label-text text-xs font-semibold text-black">8. Lots (Max: 100)</span></label>
                <input type="number" class="input input-bordered input-sm leg-lots text-black" value="1" min="1" max="100">
            </div>

            <div class="form-control">
                <label class="label py-1"><span class="label-text text-xs font-semibold text-black">9. Order Type</span></label>
                <select class="select select-bordered select-sm leg-order-type text-black" onchange="togglePriceFields(this)">
                    <option value="MARKET">MARKET</option>
                    <option value="LIMIT">LIMIT</option>
                </select>
            </div>

            <div class="form-control limit-price-field" style="display:none;">
                <label class="label py-1"><span class="label-text text-xs font-semibold text-black">Limit Price</span></label>
                <input type="number" class="input input-bordered input-sm leg-limit-price text-black" placeholder="0.00" step="0.05">
            </div>

            <div class="form-control">
                <label class="label py-1"><span class="label-text text-xs font-semibold text-black">Stop Loss (%)</span></label>
                <input type="number" class="input input-bordered input-sm leg-sl text-black" placeholder="%" step="0.1">
            </div>

            <div class="form-control">
                <label class="label py-1"><span class="label-text text-xs font-semibold text-black">Take Profit (%)</span></label>
                <input type="number" class="input input-bordered input-sm leg-tp text-black" placeholder="%" step="0.1">
            </div>
        </div>
    </div>
</template>

<!-- Close All Positions Confirmation Modal -->
<dialog id="close_positions_modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Close All Positions</h3>
        <p class="py-4">Are you sure you want to close all open positions for this strategy?</p>
        <p class="text-sm text-warning">This action will place market orders to exit all positions.</p>
        <div class="modal-action">
            <button class="btn btn-ghost" onclick="close_positions_modal.close()">Cancel</button>
            <button class="btn btn-error" onclick="confirmClosePositions()">Close All Positions</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Close Leg Modal -->
<dialog id="close_leg_modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Close Leg</h3>
        <p class="py-4">Are you sure you want to close <span class="font-semibold text-primary" id="close_leg_text">Leg 1</span> for ALL accounts?</p>
        <div class="alert alert-warning mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <span>This will close all positions for this leg across all selected accounts.</span>
        </div>
        <div class="modal-action">
            <button type="button" class="btn btn-ghost" onclick="close_leg_modal.close()">Cancel</button>
            <button type="button" class="btn btn-error" onclick="confirmCloseLeg()">Close Leg</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
let legCount = 0;
let lotSizes = {};  // Store lot sizes fetched from backend

// Fetch lot sizes on page load
async function fetchLotSizes() {
    try {
        const response = await fetch('/strategy/api/lot-sizes');
        if (response.ok) {
            const data = await response.json();
            // Merge fetched data with defaults
            lotSizes = {
                'NIFTY': 75,
                'BANKNIFTY': 35,
                'SENSEX': 20,
                ...data  // Override with database values
            };
        } else {
            // Use defaults if fetch fails
            lotSizes = {
                'NIFTY': 75,
                'BANKNIFTY': 35,
                'SENSEX': 20
            };
        }
    } catch (error) {
        console.error('Error fetching lot sizes:', error);
        // Use defaults on error
        lotSizes = {
            'NIFTY': 75,
            'BANKNIFTY': 35,
            'SENSEX': 20
        };
        console.log('Using default lot sizes (error occurred)');
    }
}

// Add a new leg
function addLeg() {
    const template = document.getElementById('legTemplate');
    const clone = template.content.cloneNode(true);

    legCount++;
    clone.querySelector('.leg-number').textContent = legCount;

    document.getElementById('strategyLegs').appendChild(clone);

    // Apply lot field state based on current risk profile
    toggleLotFields();
}

// Remove a leg
function removeLeg(button) {
    button.closest('.leg-item').remove();
    updateLegNumbers();
}

// Update leg numbers after removal
function updateLegNumbers() {
    const legs = document.querySelectorAll('.leg-item');
    legs.forEach((leg, index) => {
        leg.querySelector('.leg-number').textContent = index + 1;
    });
    legCount = legs.length;
}

// Toggle option-specific fields
function toggleOptionFields(select) {
    const legItem = select.closest('.leg-item');
    const optionFields = legItem.querySelectorAll('.option-field');
    const expirySelect = legItem.querySelector('.leg-expiry');

    if (select.value === 'futures') {
        // Hide option-specific fields for futures
        optionFields.forEach(field => field.style.display = 'none');

        // Hide weekly expiry options for futures (no weekly futures exist)
        if (expirySelect) {
            const currentWeekOpt = expirySelect.querySelector('option[value="current_week"]');
            const nextWeekOpt = expirySelect.querySelector('option[value="next_week"]');
            if (currentWeekOpt) currentWeekOpt.style.display = 'none';
            if (nextWeekOpt) nextWeekOpt.style.display = 'none';

            // If currently selected weekly, switch to current_month
            if (expirySelect.value === 'current_week' || expirySelect.value === 'next_week') {
                expirySelect.value = 'current_month';
            }
        }
    } else {
        // Show option-specific fields for options
        optionFields.forEach(field => field.style.display = 'block');

        // Show weekly expiry options for options
        if (expirySelect) {
            const currentWeekOpt = expirySelect.querySelector('option[value="current_week"]');
            const nextWeekOpt = expirySelect.querySelector('option[value="next_week"]');
            if (currentWeekOpt) currentWeekOpt.style.display = '';
            if (nextWeekOpt) nextWeekOpt.style.display = '';
        }
    }
}

// Toggle price fields based on order type
function togglePriceFields(selectElement) {
    const legItem = selectElement.closest('.leg-item');
    const orderType = selectElement.value;
    const limitPriceField = legItem.querySelector('.limit-price-field');

    // Hide by default
    if (limitPriceField) limitPriceField.style.display = 'none';

    // Show limit price field only for LIMIT orders
    if (orderType === 'LIMIT') {
        if (limitPriceField) limitPriceField.style.display = 'block';
    }
}

// Freeze/unfreeze leg (disable/enable all inputs)
// isPending: true for open LIMIT orders, false for filled orders
function freezeLeg(legItem, isExecuted, isPending = false) {
    legItem.dataset.isExecuted = isExecuted ? 'true' : 'false';
    legItem.dataset.isPending = isPending ? 'true' : 'false';

    if (isExecuted || isPending) {
        // Show appropriate badge
        const badge = legItem.querySelector('.leg-status-badge');
        if (badge) {
            badge.style.display = 'inline-block';
            if (isPending) {
                badge.classList.remove('badge-success');
                badge.classList.add('badge-warning');
                badge.textContent = 'PENDING';
            } else {
                badge.classList.remove('badge-warning');
                badge.classList.add('badge-success');
                badge.textContent = 'EXECUTED';
            }
        }

        // Disable all inputs and selects
        legItem.querySelectorAll('input, select').forEach(element => {
            element.disabled = true;
            element.classList.add('cursor-not-allowed');
        });

        // For pending orders, re-enable limit price field
        if (isPending) {
            const limitPriceField = legItem.querySelector('.leg-limit-price');
            if (limitPriceField) {
                limitPriceField.disabled = false;
                limitPriceField.classList.remove('cursor-not-allowed');
            }

            // Show modify, convert to market, and cancel buttons for pending orders
            const modifyBtn = legItem.querySelector('.leg-modify-btn');
            const convertBtn = legItem.querySelector('.leg-convert-btn');
            const cancelBtn = legItem.querySelector('.leg-cancel-btn');
            if (modifyBtn) {
                modifyBtn.style.display = 'inline-block';
            }
            if (convertBtn) {
                convertBtn.style.display = 'inline-block';
            }
            if (cancelBtn) {
                cancelBtn.style.display = 'inline-block';
            }
        } else {
            // For executed orders, show close button
            const closeBtn = legItem.querySelector('.leg-close-btn');
            if (closeBtn) {
                closeBtn.style.display = 'inline-block';
            }
        }

        // Hide remove button
        const removeBtn = legItem.querySelector('.leg-remove-btn');
        if (removeBtn) {
            removeBtn.style.display = 'none';
        }

        // Add visual indicator
        if (isPending) {
            // Yellow tint for pending
            legItem.style.opacity = '0.9';
            legItem.style.backgroundColor = '#fefce8';
            legItem.style.borderColor = '#eab308';
            legItem.style.borderWidth = '2px';
        } else {
            // Green tint for executed
            legItem.style.opacity = '0.85';
            legItem.style.backgroundColor = '#f0fdf4';
            legItem.style.borderColor = '#22c55e';
            legItem.style.borderWidth = '2px';
        }
        legItem.classList.add('leg-frozen');
    } else {
        // Hide badge
        const badge = legItem.querySelector('.leg-status-badge');
        if (badge) {
            badge.style.display = 'none';
            badge.classList.remove('badge-success', 'badge-warning');
        }

        // Hide cancel and close buttons
        const cancelBtn = legItem.querySelector('.leg-cancel-btn');
        const closeBtn = legItem.querySelector('.leg-close-btn');
        const modifyBtn = legItem.querySelector('.leg-modify-btn');
        if (cancelBtn) {
            cancelBtn.style.display = 'none';
        }
        if (closeBtn) {
            closeBtn.style.display = 'none';
        }
        if (modifyBtn) {
            modifyBtn.style.display = 'none';
        }

        // Enable all inputs and selects
        legItem.querySelectorAll('input, select').forEach(element => {
            element.disabled = false;
            element.classList.remove('cursor-not-allowed');
        });

        // Show remove button
        const removeBtn = legItem.querySelector('.leg-remove-btn');
        if (removeBtn) removeBtn.style.display = 'block';

        // Remove visual indicator
        legItem.style.opacity = '1';
        legItem.style.backgroundColor = '';
        legItem.style.borderColor = '';
        legItem.style.borderWidth = '';
        legItem.classList.remove('leg-frozen');
    }
}

// Cancel pending order for a leg
async function cancelLegOrder(button) {
    const legItem = button.closest('.leg-item');
    const legNumber = legItem.querySelector('.leg-number').textContent;

    if (!confirm(`Cancel pending order for Leg ${legNumber}?`)) {
        return;
    }

    try {
        // Get leg ID from execution data
        const legId = legItem.dataset.legId;
        if (!legId) {
            showNotification('Cannot find leg ID for cancellation', 'error');
            return;
        }

        const strategyId = {{ strategy.id if strategy else 'null' }};
        if (!strategyId) {
            showNotification('Strategy ID not found', 'error');
            return;
        }

        const response = await fetch(`/strategy/${strategyId}/leg/${legId}/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            }
        });

        const data = await response.json();

        if (data.status === 'success') {
            showNotification('Order cancelled successfully', 'success');
            // Unfreeze the leg
            freezeLeg(legItem, false, false);
            // Reload strategy data
            loadStrategyData();
        } else {
            showNotification(data.message || 'Failed to cancel order', 'error');
        }
    } catch (error) {
        console.error('Error cancelling order:', error);
        showNotification('Error cancelling order', 'error');
    }
}

// Modify limit price for pending order (inline - no modal)
async function modifyLegPrice(button) {
    const legItem = button.closest('.leg-item');
    const legNumber = legItem.querySelector('.leg-number').textContent;
    const limitPriceInput = legItem.querySelector('.leg-limit-price');
    const newPrice = limitPriceInput.value;

    if (!newPrice || parseFloat(newPrice) <= 0) {
        showNotification('Please enter a valid price', 'error');
        return;
    }

    try {
        // Get leg ID from execution data
        const legId = legItem.dataset.legId;
        if (!legId) {
            showNotification('Cannot find leg ID for modification', 'error');
            return;
        }

        const strategyId = {{ strategy.id if strategy else 'null' }};
        if (!strategyId) {
            showNotification('Strategy ID not found', 'error');
            return;
        }

        const response = await fetch(`/strategy/${strategyId}/leg/${legId}/modify`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({
                price: parseFloat(newPrice)
            })
        });

        const data = await response.json();

        if (data.status === 'success' || data.status === 'partial') {
            showNotification(data.message || 'Order price modified to ₹' + newPrice, 'success');
            // Reload strategy data to refresh orderbook
            loadStrategyData();
        } else {
            showNotification(data.message || 'Failed to modify order price', 'error');
            if (data.errors && data.errors.length > 0) {
                console.error('Modification errors:', data.errors);
            }
        }
    } catch (error) {
        console.error('Error modifying order:', error);
        showNotification('Failed to modify order price', 'error');
    }
}

// Convert pending limit order to market order
async function convertToMarket(button) {
    const legItem = button.closest('.leg-item');
    const legNumber = legItem.querySelector('.leg-number').textContent;

    if (!confirm(`Convert Leg ${legNumber} to Market Order? This will cancel the current pending order and place a market order for immediate execution.`)) {
        return;
    }

    try {
        // Get leg ID from execution data
        const legId = legItem.dataset.legId;
        if (!legId) {
            showNotification('Cannot find leg ID for conversion', 'error');
            return;
        }

        const strategyId = {{ strategy.id if strategy else 'null' }};
        if (!strategyId) {
            showNotification('Strategy ID not found', 'error');
            return;
        }

        const response = await fetch(`/strategy/${strategyId}/leg/${legId}/convert-to-market`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            }
        });

        const data = await response.json();

        if (data.status === 'success' || data.status === 'partial') {
            showNotification(data.message || 'Order converted to market and executed', 'success');
            // Reload strategy data to refresh everything
            loadStrategyData();
            checkAndFreezePendingLegs();
        } else {
            showNotification(data.message || 'Failed to convert to market order', 'error');
            if (data.errors && data.errors.length > 0) {
                console.error('Conversion errors:', data.errors);
            }
        }
    } catch (error) {
        console.error('Error converting to market order:', error);
        showNotification('Failed to convert to market order', 'error');
    }
}

// Poll order status every 5 seconds for pending orders
let statusPollingInterval = null;

function startStatusPolling() {
    // Clear any existing interval
    if (statusPollingInterval) {
        clearInterval(statusPollingInterval);
    }

    {% if strategy %}
    const strategyId = {{ strategy.id }};

    // Poll every 5 seconds
    statusPollingInterval = setInterval(async () => {
        try {
            // Check if there are any pending legs
            const pendingLegs = document.querySelectorAll('.leg-item[data-is-pending="true"]');
            if (pendingLegs.length === 0) {
                // No pending legs, stop polling
                console.log('No pending legs, stopping status polling');
                clearInterval(statusPollingInterval);
                statusPollingInterval = null;
                return;
            }

            console.log(`Polling status for ${pendingLegs.length} pending legs`);

            // Fetch latest orderbook
            const response = await fetch(`/strategy/${strategyId}/orderbook`);
            const data = await response.json();

            if (data.status === 'success' && data.data) {
                const orders = data.data.orders || [];

                // Update leg status based on order status
                pendingLegs.forEach(legItem => {
                    // Get leg number from displayed text
                    const legNumber = parseInt(legItem.querySelector('.leg-number').textContent);
                    if (!legNumber) return;

                    // Find orders for this leg by leg_number
                    const legOrders = orders.filter(o => o.leg_number == legNumber);
                    if (legOrders.length === 0) return;

                    // Store leg_id if not already set
                    if (legOrders[0].leg_id && !legItem.dataset.legId) {
                        legItem.dataset.legId = legOrders[0].leg_id;
                    }

                    // Check if all orders are complete or failed
                    const allComplete = legOrders.every(o => o.order_status === 'complete');
                    const allFailed = legOrders.every(o => ['rejected', 'cancelled'].includes(o.order_status));
                    const anyOpen = legOrders.some(o => o.order_status === 'open');

                    if (allComplete) {
                        // Mark as executed
                        console.log(`Leg ${legNumber} is now complete`);
                        freezeLeg(legItem, true, false);
                        legItem.dataset.isPending = 'false';
                        legItem.dataset.isExecuted = 'true';
                        showNotification(`Leg ${legNumber} order filled`, 'success');
                        // Freeze account selection when any leg is executed
                        freezeAccountsIfExecuted();
                    } else if (allFailed) {
                        // Unfreeze the leg
                        console.log(`Leg ${legNumber} orders failed, unfreezing`);
                        freezeLeg(legItem, false, false);
                        legItem.dataset.isPending = 'false';
                        showNotification(`Leg ${legNumber} order failed`, 'error');
                    }
                    // If still open, keep as pending
                });

                // Reload data to update tables
                loadStrategyData();
            }
        } catch (error) {
            console.error('Error polling order status:', error);
        }
    }, 5000); // 5 seconds

    console.log('Status polling started (every 5 seconds)');
    {% endif %}
}

function stopStatusPolling() {
    if (statusPollingInterval) {
        clearInterval(statusPollingInterval);
        statusPollingInterval = null;
        console.log('Status polling stopped');
    }
}

// Check orderbook and freeze legs with pending orders
async function checkAndFreezePendingLegs() {
    {% if strategy %}
    const strategyId = {{ strategy.id }};

    try {
        const response = await fetch(`/strategy/${strategyId}/orderbook`);
        const data = await response.json();

        if (data.status === 'success' && data.data) {
            const orders = data.data.orders || [];

            // Group orders by leg_number (more reliable than leg_id for new strategies)
            const ordersByLegNumber = {};
            orders.forEach(order => {
                if (!order.leg_number) return;
                if (!ordersByLegNumber[order.leg_number]) {
                    ordersByLegNumber[order.leg_number] = [];
                }
                ordersByLegNumber[order.leg_number].push(order);
            });

            // Check each leg
            document.querySelectorAll('.leg-item').forEach(legItem => {
                // Get leg number from the displayed number
                const legNumber = parseInt(legItem.querySelector('.leg-number').textContent);
                if (!legNumber) return;

                // Store leg_id from first order if not already set
                const legOrders = ordersByLegNumber[legNumber] || [];
                if (legOrders.length > 0 && legOrders[0].leg_id && !legItem.dataset.legId) {
                    legItem.dataset.legId = legOrders[0].leg_id;
                }

                if (legOrders.length === 0) return;

                // Check order statuses
                const hasOpen = legOrders.some(o => o.order_status === 'open');
                const allComplete = legOrders.every(o => o.order_status === 'complete');
                const allFailed = legOrders.every(o => ['rejected', 'cancelled'].includes(o.order_status));

                if (hasOpen) {
                    // Has pending orders - freeze partially
                    console.log(`Leg ${legNumber} has pending orders, freezing with edit allowed`);
                    freezeLeg(legItem, false, true);
                } else if (allComplete) {
                    // All complete - freeze completely
                    console.log(`Leg ${legNumber} is fully executed`);
                    freezeLeg(legItem, true, false);
                    // Freeze account selection when any leg is executed
                    freezeAccountsIfExecuted();
                } else if (allFailed) {
                    // All failed - unfreeze
                    console.log(`Leg ${legNumber} orders failed, keeping unfrozen`);
                    freezeLeg(legItem, false, false);
                }
            });
        }
    } catch (error) {
        console.error('Error checking pending legs:', error);
    }
    {% endif %}
}

// Toggle risk management type (Traditional vs Supertrend) - Mutually Exclusive Checkboxes
function toggleRiskManagementType(selectedType) {
    const traditionalCheckbox = document.getElementById('useTraditionalRisk');
    const supertrendCheckbox = document.getElementById('useSupertrendExit');

    // Get all traditional fields
    const traditionalFields = document.querySelectorAll('#traditional-risk-fields input');

    // Get all supertrend fields
    const supertrendFields = document.querySelectorAll('#supertrend-risk-fields input, #supertrend-risk-fields select');

    // Implement mutual exclusion
    if (selectedType === 'traditional' && traditionalCheckbox.checked) {
        // Uncheck supertrend
        supertrendCheckbox.checked = false;

        // Enable traditional fields
        traditionalFields.forEach(field => {
            field.disabled = false;
            field.classList.remove('input-disabled', 'cursor-not-allowed');
        });

        // Disable supertrend fields
        supertrendFields.forEach(field => {
            field.disabled = true;
            field.classList.add('input-disabled', 'cursor-not-allowed');
        });
    } else if (selectedType === 'supertrend' && supertrendCheckbox.checked) {
        // Uncheck traditional
        traditionalCheckbox.checked = false;

        // Disable traditional fields
        traditionalFields.forEach(field => {
            field.disabled = true;
            field.classList.add('input-disabled', 'cursor-not-allowed');
        });

        // Enable supertrend fields
        supertrendFields.forEach(field => {
            field.disabled = false;
            field.classList.remove('input-disabled', 'cursor-not-allowed');
        });
    } else {
        // Both unchecked - disable all fields
        traditionalFields.forEach(field => {
            field.disabled = true;
            field.classList.add('input-disabled', 'cursor-not-allowed');
        });

        supertrendFields.forEach(field => {
            field.disabled = true;
            field.classList.add('input-disabled', 'cursor-not-allowed');
        });
    }
}

// Toggle lot fields based on risk profile selection
function toggleLotFields() {
    const riskProfile = document.getElementById('riskProfile').value;
    const isFixedLots = riskProfile === 'fixed_lots';

    // Get all lot input fields
    const lotFields = document.querySelectorAll('.leg-lots');

    lotFields.forEach(field => {
        if (isFixedLots) {
            // Enable lot fields for fixed lot size
            field.disabled = false;
            field.classList.remove('input-disabled', 'cursor-not-allowed');
            field.placeholder = '1';
        } else {
            // Disable lot fields for margin-based profiles
            field.disabled = true;
            field.classList.add('input-disabled', 'cursor-not-allowed');
            field.value = ''; // Clear the value
            field.placeholder = 'Auto (calculated at execution)';
        }
    });
}

// Toggle strike input based on selection
function toggleStrikeInput(select) {
    const legItem = select.closest('.leg-item');
    const input = legItem.querySelector('.leg-strike-value');
    const label = legItem.querySelector('.leg-strike-label');
    const selectedOption = select.options[select.selectedIndex];
    const offset = selectedOption.dataset.offset;

    if (select.value === 'strike_price') {
        input.disabled = false;
        input.placeholder = 'Enter strike price';
        input.value = '';
        label.textContent = '7. Strike Price';
    } else if (select.value === 'premium_near') {
        input.disabled = false;
        input.placeholder = 'Enter target premium';
        input.value = '';
        label.textContent = '7. Target Premium';
    } else if (select.value === 'ITM' || select.value === 'OTM') {
        // For ITM/OTM options, store offset as hidden value
        input.disabled = true;
        input.placeholder = 'Auto-calculated';
        input.value = offset || '0';
        input.dataset.offset = offset || '0';
        label.textContent = '7. Strike Offset';
    } else {
        // ATM
        input.disabled = true;
        input.placeholder = 'Auto (ATM)';
        input.value = '';
        label.textContent = '7. Strike Value';
    }
}

// Save strategy
function saveStrategy(execute = false) {
    const riskProfile = document.getElementById('riskProfile').value;
    const isFixedLots = riskProfile === 'fixed_lots';

    // SAFETY CHECK: Validate lots before processing
    const MAX_LOTS = 100;
    if (isFixedLots) {
        const invalidLegs = [];
        document.querySelectorAll('.leg-item').forEach((legItem, index) => {
            // Skip executed or pending legs
            if (legItem.dataset.isExecuted === 'true' || legItem.dataset.isPending === 'true') {
                return;
            }

            const lots = parseInt(legItem.querySelector('.leg-lots').value) || 1;
            if (lots > MAX_LOTS) {
                const legNumber = legItem.querySelector('.leg-number').textContent;
                invalidLegs.push(`Leg ${legNumber}: ${lots} lots`);
            }
        });

        if (invalidLegs.length > 0) {
            showNotification(`Safety limit exceeded: Maximum ${MAX_LOTS} lots allowed per leg. Invalid legs: ${invalidLegs.join(', ')}`, 'error');
            return; // Stop execution
        }
    }

    const legs = [];
    document.querySelectorAll('.leg-item').forEach((legItem, index) => {
        // Skip executed or pending legs - backend preserves them automatically
        // Sending them would create duplicate legs
        if (legItem.dataset.isExecuted === 'true' || legItem.dataset.isPending === 'true') {
            return;
        }

        const strikeSelect = legItem.querySelector('.leg-strike-selection');
        const selectedOption = strikeSelect?.options[strikeSelect.selectedIndex];
        const strikeValue = legItem.querySelector('.leg-strike-value').value;

        // Determine strike offset for ITM/OTM selections
        let strikeOffset = 0;
        if (selectedOption && selectedOption.dataset.offset) {
            strikeOffset = parseInt(selectedOption.dataset.offset) || 0;
        }

        const orderType = legItem.querySelector('.leg-order-type').value;
        const limitPrice = legItem.querySelector('.leg-limit-price')?.value;

        // For margin-based profiles, don't send lots/quantity (will be calculated at execution)
        // For fixed lots profile, send the specified lots and calculated quantity
        let lots = null;
        let calculatedQuantity = null;

        if (isFixedLots) {
            lots = parseInt(legItem.querySelector('.leg-lots').value) || 1;
            const instrument = legItem.querySelector('.leg-instrument').value;
            let lotSize = lotSizes[instrument] || 75;
            calculatedQuantity = lots * lotSize;
        }

        legs.push({
            instrument: legItem.querySelector('.leg-instrument').value,
            product_type: legItem.querySelector('.leg-product-type').value,
            expiry: legItem.querySelector('.leg-expiry').value,
            action: legItem.querySelector('.leg-action').value,
            option_type: legItem.querySelector('.leg-option-type')?.value,
            strike_selection: strikeSelect?.value,
            strike_price: strikeSelect?.value === 'strike_price' ? parseFloat(strikeValue) : null,
            strike_offset: strikeOffset,
            premium_value: strikeSelect?.value === 'premium_near' ? parseFloat(strikeValue) : null,
            lots: lots,  // null for margin-based profiles
            quantity: calculatedQuantity,  // null for margin-based profiles
            order_type: orderType,
            limit_price: limitPrice ? parseFloat(limitPrice) : null,
            trigger_price: null,
            stop_loss_type: 'percentage',
            stop_loss_value: parseFloat(legItem.querySelector('.leg-sl').value) || null,
            take_profit_type: 'percentage',
            take_profit_value: parseFloat(legItem.querySelector('.leg-tp').value) || null
        });
    });

    const selectedAccounts = Array.from(document.querySelectorAll('input[name="accounts"]:checked'))
        .map(cb => parseInt(cb.value));

    // Determine which risk management type is selected
    const useTraditional = document.getElementById('useTraditionalRisk').checked;
    const useSupertrendExit = document.getElementById('useSupertrendExit').checked;

    const strategyData = {
        name: document.getElementById('strategyName').value,
        risk_profile: document.getElementById('riskProfile').value,
        market_condition: document.getElementById('marketCondition').value,
        product_order_type: document.getElementById('productOrderType').value,
        selected_accounts: selectedAccounts,
        allocation_type: 'equal',
        // Traditional risk management (only if selected)
        max_loss: useTraditional ? (parseFloat(document.getElementById('maxLoss').value) || null) : null,
        max_profit: useTraditional ? (parseFloat(document.getElementById('maxProfit').value) || null) : null,
        trailing_sl: useTraditional ? (parseFloat(document.getElementById('trailingSl').value) || null) : null,
        // Supertrend exit settings (only if selected)
        supertrend_exit_enabled: useSupertrendExit,
        supertrend_exit_type: useSupertrendExit ? document.getElementById('supertrendExitType').value : null,
        supertrend_period: useSupertrendExit ? parseInt(document.getElementById('supertrendPeriod').value) || 10 : null,
        supertrend_multiplier: useSupertrendExit ? parseFloat(document.getElementById('supertrendMultiplier').value) || 3.0 : null,
        supertrend_timeframe: useSupertrendExit ? document.getElementById('supertrendTimeframe').value : null,
        legs: legs
    };

    const url = {% if strategy %}'/strategy/builder/{{ strategy.id }}'{% else %}'/strategy/builder'{% endif %};

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify(strategyData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('Strategy saved successfully', 'success');

            if (execute) {
                // Execute the strategy
                fetch(`/strategy/execute/${data.strategy_id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    }
                })
                .then(response => response.json())
                .then(execData => {
                    // Handle different execution statuses
                    if (execData.status === 'success' || execData.status === 'partial') {
                        showNotification(execData.message || 'Orders placed successfully!', 'success');

                        // Reload strategy data and check for pending orders
                        setTimeout(() => {
                            loadStrategyData(); // Reload orderbook/tradebook/positions
                            checkAndFreezePendingLegs(); // Check and freeze pending legs
                            startStatusPolling(); // Start 5-second polling
                            freezeAccountsIfExecuted(); // Freeze account selection after execution
                        }, 1000);

                        // Stay on the same page - no redirect
                    } else if (execData.status === 'warning') {
                        // Orders were skipped due to insufficient margin
                        showNotification(execData.message || 'Strategy execution skipped', 'warning');
                        // Show details if available
                        if (execData.results && execData.results.length > 0) {
                            console.log('Execution details:', execData.results);
                        }
                        // Stay on the same page - no redirect
                    } else {
                        // Error status
                        showNotification(execData.message || 'Strategy execution failed', 'error');
                        // Stay on the same page - no redirect
                    }
                })
                .catch(error => {
                    showNotification('Error executing strategy', 'error');
                    console.error('Error:', error);
                    // Stay on the same page - no redirect
                });
            }
            // Stay on the same page after save (no redirect)
        } else {
            showNotification(data.message || 'Failed to save strategy', 'error');
        }
    })
    .catch(error => {
        showNotification('Error saving strategy', 'error');
        console.error('Error:', error);
    });
}

// Save as template
function saveAsTemplate() {
    saveStrategy(false);
    // Additional logic to mark as template would go here
}

// Show notification
function showNotification(message, type) {
    console.log('[showNotification] Called with:', message, type);

    // Map type to appropriate alert class
    let alertClass = 'alert-info';
    if (type === 'success') {
        alertClass = 'alert-success';
    } else if (type === 'error') {
        alertClass = 'alert-error';
    } else if (type === 'warning') {
        alertClass = 'alert-warning';
    }

    const alert = document.createElement('div');
    alert.className = `alert ${alertClass} shadow-lg mb-2`;
    alert.innerHTML = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span>${message}</span>
    `;

    // Find toast container (from base.html)
    let container = document.querySelector('.toast');
    console.log('[showNotification] Toast container found:', container);

    if (!container) {
        // Create container if it doesn't exist
        console.log('[showNotification] Creating new toast container');
        container = document.createElement('div');
        container.className = 'toast toast-top toast-end z-50';
        document.body.appendChild(container);
    }

    container.appendChild(alert);
    console.log('[showNotification] Alert added to container');
    setTimeout(() => alert.remove(), 5000);  // Show for 5 seconds for important messages
}

// Initialize with existing data or add first leg
document.addEventListener('DOMContentLoaded', async function() {
    // Fetch lot sizes from database first
    await fetchLotSizes();

    // Initialize risk management toggle state
    // Check which risk management is enabled (if any) and initialize fields accordingly
    const traditionalCheckbox = document.getElementById('useTraditionalRisk');
    const supertrendCheckbox = document.getElementById('useSupertrendExit');

    if (traditionalCheckbox.checked) {
        toggleRiskManagementType('traditional');
    } else if (supertrendCheckbox.checked) {
        toggleRiskManagementType('supertrend');
    } else {
        // Both unchecked by default - disable all fields
        toggleRiskManagementType(null);
    }

    {% if strategy_legs and strategy_legs|length > 0 %}
        // Load existing legs
        {% for leg in strategy_legs %}
        {
            addLeg();
            const legItem = document.querySelectorAll('.leg-item')[{{ loop.index0 }}];

            // Store leg ID for status tracking and cancellation
            legItem.dataset.legId = '{{ leg.id }}';

            // Populate basic fields
            legItem.querySelector('.leg-instrument').value = '{{ leg.instrument }}';
            legItem.querySelector('.leg-product-type').value = '{{ leg.product_type }}';
            legItem.querySelector('.leg-expiry').value = '{{ leg.expiry }}';
            legItem.querySelector('.leg-action').value = '{{ leg.action }}';

            // Important: Use lots from database, not the stored quantity
            // This ensures we use the correct lot size from TradingSettings
            const lots = {{ leg.lots or 1 }};
            legItem.querySelector('.leg-lots').value = lots;

            // Recalculate quantity based on current lot size from database
            const instrument = '{{ leg.instrument }}';
            const lotSize = lotSizes[instrument] || 75;

            legItem.querySelector('.leg-order-type').value = '{{ leg.order_type or "MARKET" }}';

            // Populate option fields if options
            {% if leg.product_type == 'options' %}
            legItem.querySelector('.leg-option-type').value = '{{ leg.option_type or "" }}';
            legItem.querySelector('.leg-strike-selection').value = '{{ leg.strike_selection or "ATM" }}';

            // Set strike value based on selection
            {% if leg.strike_selection == 'strike_price' %}
            legItem.querySelector('.leg-strike-value').value = {{ leg.strike_price if leg.strike_price else '""' }};
            legItem.querySelector('.leg-strike-value').disabled = false;
            {% elif leg.strike_selection == 'premium_near' %}
            legItem.querySelector('.leg-strike-value').value = {{ leg.premium_value if leg.premium_value else '""' }};
            legItem.querySelector('.leg-strike-value').disabled = false;
            {% elif leg.strike_selection in ['ITM', 'OTM'] %}
            legItem.querySelector('.leg-strike-value').dataset.offset = '{{ leg.strike_offset or 0 }}';
            // Find and select the correct ITM/OTM option with offset
            const strikeSelect = legItem.querySelector('.leg-strike-selection');
            for (let option of strikeSelect.options) {
                if (option.value === '{{ leg.strike_selection }}' && option.dataset.offset === '{{ leg.strike_offset }}') {
                    strikeSelect.value = option.value;
                    option.selected = true;
                    break;
                }
            }
            {% endif %}
            {% endif %}

            // Populate price fields based on order type
            {% if leg.order_type == 'LIMIT' %}
            togglePriceFields(legItem.querySelector('.leg-order-type'));
            {% if leg.price_condition %}
            legItem.querySelector('.leg-price-condition').value = '{{ leg.price_condition }}';
            {% endif %}
            {% if leg.limit_price %}
            legItem.querySelector('.leg-limit-price').value = {{ leg.limit_price }};
            {% endif %}
            {% endif %}

            // Populate stop loss and take profit
            {% if leg.stop_loss_value %}
            legItem.querySelector('.leg-sl').value = {{ leg.stop_loss_value }};
            {% endif %}
            {% if leg.take_profit_value %}
            legItem.querySelector('.leg-tp').value = {{ leg.take_profit_value }};
            {% endif %}

            // Toggle option fields if futures
            {% if leg.product_type == 'futures' %}
            toggleOptionFields(legItem.querySelector('.leg-product-type'));
            {% endif %}

            // Mark as executed and freeze if leg is already executed
            {% if leg.is_executed %}
            freezeLeg(legItem, true);
            {% endif %}
        }
        {% endfor %}
    {% else %}
        // Add first leg by default
        addLeg();
    {% endif %}

    // Load strategy execution data if editing existing strategy
    {% if strategy %}
    loadStrategyData();
    // Check for pending orders and start polling
    setTimeout(() => {
        checkAndFreezePendingLegs();
        startStatusPolling();
    }, 1000); // Wait 1 second for data to load

    // Auto-refresh Strategy Execution Tracking tabs every 3 seconds
    setInterval(() => {
        loadStrategyData();
    }, 3000);
    {% endif %}

    // Set initial lot field state based on risk profile
    toggleLotFields();

    // Freeze account checkboxes if any leg is executed
    freezeAccountsIfExecuted();
});

// Freeze account selection if any leg has been executed
function freezeAccountsIfExecuted() {
    const hasExecutedLeg = document.querySelector('.leg-frozen');

    if (hasExecutedLeg) {
        const accountCheckboxes = document.querySelectorAll('input[name="accounts"]');
        accountCheckboxes.forEach(checkbox => {
            checkbox.disabled = true;
            checkbox.classList.add('cursor-not-allowed');
        });
    }
}

// Strategy-level execution tracking functions
function showStrategyTab(tabName, element) {
    // Hide all tabs
    document.querySelectorAll('.strategy-tab').forEach(tab => {
        tab.classList.add('hidden');
    });

    // Remove active styling from all tab buttons
    document.querySelectorAll('[id^="tab-"]').forEach(tab => {
        tab.classList.remove('border-primary', 'text-primary');
        tab.classList.add('border-transparent', 'text-base-content/60');
    });

    // Add active styling to clicked tab
    element.classList.remove('border-transparent', 'text-base-content/60');
    element.classList.add('border-primary', 'text-primary');

    // Show selected tab
    document.getElementById(tabName + '-tab').classList.remove('hidden');

    // Load risk monitor data when that tab is shown
    if (tabName === 'riskmonitor') {
        loadRiskMonitorData();
    }
}

function loadStrategyData() {
    {% if strategy %}
    const strategyId = {{ strategy.id }};

    // Load orderbook
    loadOrderbook(strategyId);

    // Load tradebook
    loadTradebook(strategyId);

    // Load positions
    loadPositions(strategyId);
    {% endif %}
}

function refreshStrategyData() {
    loadStrategyData();
    showNotification('Data refreshed', 'success');
}

// Risk Monitor Tab Functions
let riskMonitorEventSource = null;

function loadRiskMonitorData() {
    {% if strategy %}
    const strategyId = {{ strategy.id }};

    // Close existing connection
    if (riskMonitorEventSource) {
        riskMonitorEventSource.close();
    }

    // Update connection status
    const statusEl = document.getElementById('riskMonitorConnection');
    if (statusEl) {
        statusEl.innerHTML = '<span class="loading loading-spinner loading-xs"></span> Connecting...';
        statusEl.className = 'badge badge-sm';
    }

    // Start SSE connection for risk data
    riskMonitorEventSource = new EventSource('/trading/api/risk-status/stream');

    riskMonitorEventSource.onopen = function() {
        if (statusEl) {
            statusEl.innerHTML = '<span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-success opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-success"></span></span> Connected';
            statusEl.className = 'badge badge-sm badge-success';
        }
    };

    riskMonitorEventSource.onmessage = function(event) {
        try {
            const response = JSON.parse(event.data);
            if (response.status === 'success' && response.data) {
                // Find this strategy's data
                const strategyData = response.data.find(s => s.strategy_id === strategyId);
                if (strategyData) {
                    updateRiskMonitorTable(strategyData);
                }
            }
        } catch (e) {
            console.error('Error parsing risk data:', e);
        }
    };

    riskMonitorEventSource.onerror = function() {
        if (statusEl) {
            statusEl.innerHTML = 'Offline';
            statusEl.className = 'badge badge-sm badge-error';
        }
    };
    {% endif %}
}

function updateRiskMonitorTable(strategyData) {
    const tbody = document.getElementById('riskmonitor-body');
    if (!tbody) return;

    const executions = strategyData.executions || [];

    if (executions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center text-base-content/60">No open positions</td></tr>';
        return;
    }

    let html = '';
    let totalPnl = 0;
    let slCount = 0;
    let tpCount = 0;

    executions.forEach(exec => {
        const pnl = exec.unrealized_pnl || 0;
        totalPnl += pnl;

        if (exec.sl_price) slCount++;
        if (exec.tp_price) tpCount++;

        const actionBadge = exec.action === 'BUY'
            ? '<span class="badge badge-success badge-sm">BUY</span>'
            : '<span class="badge badge-error badge-sm">SELL</span>';

        // Status badge based on price source
        let statusBadge;
        if (exec.price_source === 'realtime') {
            // Show Live for any valid price data (WebSocket, cached, or calculated)
            statusBadge = '<span class="badge badge-success badge-xs">Live</span>';
        } else {
            // Only show Offline if truly no price data available
            statusBadge = '<span class="badge badge-ghost badge-xs">Offline</span>';
        }

        // SL display with color coding
        let slPriceDisplay = exec.sl_price ? `<span class="font-mono text-error">${exec.sl_price.toFixed(2)}</span>` : '<span class="text-base-content/40">--</span>';
        let slDistDisplay = '--';
        if (exec.sl_distance !== null && exec.sl_distance !== undefined) {
            const color = exec.sl_hit ? 'text-error font-bold animate-pulse' : (exec.sl_distance < 5 ? 'text-warning' : '');
            slDistDisplay = exec.sl_hit
                ? `<span class="${color}">HIT!</span>`
                : `<span class="${color}">${exec.sl_distance.toFixed(1)} pts</span>`;
        }

        // TP display with color coding
        let tpPriceDisplay = exec.tp_price ? `<span class="font-mono text-success">${exec.tp_price.toFixed(2)}</span>` : '<span class="text-base-content/40">--</span>';
        let tpDistDisplay = '--';
        if (exec.tp_distance !== null && exec.tp_distance !== undefined) {
            const color = exec.tp_hit ? 'text-success font-bold animate-pulse' : (exec.tp_distance < 5 ? 'text-info' : '');
            tpDistDisplay = exec.tp_hit
                ? `<span class="${color}">HIT!</span>`
                : `<span class="${color}">${exec.tp_distance.toFixed(1)} pts</span>`;
        }

        const pnlColor = pnl >= 0 ? 'text-success' : 'text-error';

        // Check if position is being closed
        let closingBadge = '';
        if (exec.status === 'exit_pending') {
            const reason = exec.exit_reason || 'closing';
            closingBadge = `<span class="badge badge-warning badge-xs ml-1 animate-pulse">${reason.toUpperCase()}</span>`;
        }

        html += `
            <tr class="${exec.status === 'exit_pending' ? 'opacity-60' : ''}">
                <td><span class="badge badge-primary badge-sm">${exec.leg_number}</span></td>
                <td class="font-mono text-xs">${exec.symbol}${closingBadge}</td>
                <td>${actionBadge}</td>
                <td class="font-mono">₹${(exec.entry_price || 0).toFixed(2)}</td>
                <td class="font-mono font-bold">₹${(exec.last_price || 0).toFixed(2)}</td>
                <td>${slPriceDisplay}</td>
                <td class="text-xs">${slDistDisplay}</td>
                <td>${tpPriceDisplay}</td>
                <td class="text-xs">${tpDistDisplay}</td>
                <td class="font-mono ${pnlColor}">₹${pnl.toFixed(2)}</td>
                <td>${statusBadge}</td>
            </tr>
        `;
    });

    tbody.innerHTML = html;

    // Update stats
    const totalPnlEl = document.getElementById('riskmonitor-total-pnl');
    if (totalPnlEl) {
        totalPnlEl.textContent = `₹${totalPnl.toFixed(2)}`;
        totalPnlEl.className = `stat-value ${totalPnl >= 0 ? 'text-success' : 'text-error'}`;
    }

    const slCountEl = document.getElementById('riskmonitor-sl-count');
    if (slCountEl) slCountEl.textContent = slCount;

    const tpCountEl = document.getElementById('riskmonitor-tp-count');
    if (tpCountEl) tpCountEl.textContent = tpCount;
}

// Risk Status SSE Connection
let riskEventSource = null;
const strategyIdForRisk = {{ strategy.id if strategy else 'null' }};

function startRiskStatusStream() {
    if (!strategyIdForRisk || !document.getElementById('riskStatusSection')) {
        return;
    }

    if (riskEventSource) {
        riskEventSource.close();
    }

    riskEventSource = new EventSource('/trading/api/risk-status/stream');

    riskEventSource.onopen = function() {
        const statusEl = document.getElementById('riskConnectionStatus');
        if (statusEl) {
            statusEl.innerHTML = '<span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-success opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-success"></span></span>';
            statusEl.className = 'badge badge-sm badge-success';
        }
    };

    riskEventSource.onmessage = function(event) {
        try {
            const response = JSON.parse(event.data);
            if (response.status === 'success') {
                updateRiskStatusDisplay(response.data);
            }
        } catch (e) {
            console.error('Error parsing risk SSE data:', e);
        }
    };

    riskEventSource.onerror = function(error) {
        const statusEl = document.getElementById('riskConnectionStatus');
        if (statusEl) {
            statusEl.innerHTML = 'Offline';
            statusEl.className = 'badge badge-sm badge-error';
        }
        setTimeout(() => startRiskStatusStream(), 5000);
    };
}

function updateRiskStatusDisplay(data) {
    // Find data for current strategy
    const strategyData = data.find(s => s.strategy_id === strategyIdForRisk);

    if (!strategyData) {
        return;
    }

    // Update current P&L
    const currentPnlEl = document.getElementById('riskCurrentPnl');
    if (currentPnlEl) {
        const pnl = strategyData.total_pnl || 0;
        currentPnlEl.textContent = `₹${pnl.toFixed(2)}`;
        currentPnlEl.className = `font-bold text-lg ml-1 ${pnl >= 0 ? 'text-success' : 'text-error'}`;
    }

    // Update Max Loss progress
    const maxLossProgress = document.getElementById('riskMaxLossProgress');
    const maxLossAmount = document.getElementById('riskMaxLossAmount');
    const maxLossPct = document.getElementById('riskMaxLossPct');

    if (maxLossProgress && maxLossAmount && maxLossPct) {
        const pct = strategyData.max_loss_pct || 0;
        const amount = strategyData.total_pnl < 0 ? Math.abs(strategyData.total_pnl) : 0;

        maxLossProgress.value = pct;
        maxLossAmount.textContent = `₹${amount.toFixed(2)}`;
        maxLossPct.textContent = `${pct}%`;

        // Change color based on risk level
        if (pct >= 80) {
            maxLossProgress.className = 'progress progress-error w-full h-3';
        } else if (pct >= 50) {
            maxLossProgress.className = 'progress progress-warning w-full h-3';
        } else {
            maxLossProgress.className = 'progress progress-error w-full h-3';
        }
    }

    // Update Max Profit progress
    const maxProfitProgress = document.getElementById('riskMaxProfitProgress');
    const maxProfitAmount = document.getElementById('riskMaxProfitAmount');
    const maxProfitPct = document.getElementById('riskMaxProfitPct');

    if (maxProfitProgress && maxProfitAmount && maxProfitPct) {
        const pct = strategyData.max_profit_pct || 0;
        const amount = strategyData.total_pnl > 0 ? strategyData.total_pnl : 0;

        maxProfitProgress.value = pct;
        maxProfitAmount.textContent = `₹${amount.toFixed(2)}`;
        maxProfitPct.textContent = `${pct}%`;
    }

    // Update trailing SL status
    const trailingSLStatus = document.getElementById('riskTrailingSLStatus');
    const trailingSLTrigger = document.getElementById('riskTrailingSLTrigger');

    if (trailingSLStatus) {
        // Check if any execution has trailing SL triggered
        const triggered = strategyData.executions.some(e => e.trailing_sl_triggered);
        if (triggered) {
            trailingSLStatus.textContent = 'Active';
            trailingSLStatus.className = 'badge badge-success badge-sm ml-1';
        } else {
            trailingSLStatus.textContent = 'Inactive';
            trailingSLStatus.className = 'badge badge-warning badge-sm ml-1';
        }
    }

    if (trailingSLTrigger) {
        const triggeredExec = strategyData.executions.find(e => e.trailing_sl_triggered);
        trailingSLTrigger.textContent = triggeredExec ? `₹${triggeredExec.trailing_sl_triggered}` : '--';
    }

    // Update leg-level SL/TP tracking table
    const legRiskTracking = document.getElementById('legRiskTracking');
    const legRiskTableBody = document.getElementById('legRiskTableBody');

    if (legRiskTracking && legRiskTableBody && strategyData.executions.length > 0) {
        // Show the table if there are executions
        legRiskTracking.classList.remove('hidden');

        // Check if any execution has SL or TP configured
        const hasLegRisk = strategyData.executions.some(e => e.sl_price || e.tp_price);

        if (hasLegRisk) {
            let tableHtml = '';
            strategyData.executions.forEach(exec => {
                const slClass = exec.sl_hit ? 'text-error font-bold animate-pulse' : 'text-error';
                const tpClass = exec.tp_hit ? 'text-success font-bold animate-pulse' : 'text-success';

                tableHtml += `
                    <tr>
                        <td><span class="badge badge-primary badge-xs">${exec.leg_number || '-'}</span></td>
                        <td class="text-xs font-mono">${exec.symbol ? exec.symbol.slice(-10) : '--'}</td>
                        <td class="font-mono">${exec.last_price ? exec.last_price.toFixed(2) : '--'}</td>
                        <td class="font-mono ${slClass}">${exec.sl_price ? exec.sl_price.toFixed(2) : 'N/A'}</td>
                        <td class="text-xs ${exec.sl_hit ? 'text-error font-bold' : ''}">
                            ${exec.sl_distance !== null ? (exec.sl_distance >= 0 ? exec.sl_distance.toFixed(1) + ' pts' : 'HIT!') : '--'}
                        </td>
                        <td class="font-mono ${tpClass}">${exec.tp_price ? exec.tp_price.toFixed(2) : 'N/A'}</td>
                        <td class="text-xs ${exec.tp_hit ? 'text-success font-bold' : ''}">
                            ${exec.tp_distance !== null ? (exec.tp_distance >= 0 ? exec.tp_distance.toFixed(1) + ' pts' : 'HIT!') : '--'}
                        </td>
                    </tr>
                `;
            });
            legRiskTableBody.innerHTML = tableHtml;
        } else {
            legRiskTracking.classList.add('hidden');
        }
    } else if (legRiskTracking) {
        legRiskTracking.classList.add('hidden');
    }

    // Update last update time
    const lastUpdateEl = document.getElementById('riskLastUpdate');
    if (lastUpdateEl) {
        lastUpdateEl.textContent = new Date().toLocaleTimeString();
    }
}

// Start risk status stream when page loads
if (strategyIdForRisk && document.getElementById('riskStatusSection')) {
    document.addEventListener('DOMContentLoaded', function() {
        startRiskStatusStream();
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (riskEventSource) {
            riskEventSource.close();
        }
        if (combinedPremiumInterval) {
            clearInterval(combinedPremiumInterval);
        }
    });
}

// Combined Premium polling for Supertrend strategies
let combinedPremiumInterval = null;
const supertrendEnabled = {{ 'true' if strategy and strategy.supertrend_exit_enabled else 'false' }};

function startCombinedPremiumPolling() {
    if (!supertrendEnabled || !strategyIdForRisk) {
        return;
    }

    // Initial fetch
    fetchCombinedPremium();

    // Poll every 10 seconds
    combinedPremiumInterval = setInterval(fetchCombinedPremium, 10000);
}

async function fetchCombinedPremium() {
    const connectionEl = document.getElementById('riskPremiumConnection');
    const premiumEl = document.getElementById('riskCombinedPremium');
    const supertrendValueEl = document.getElementById('riskSupertrendValue');
    const signalEl = document.getElementById('riskSupertrendSignal');

    if (!premiumEl) return;

    try {
        // Fetch chart data with strategy's supertrend parameters
        const period = {{ strategy.supertrend_period if strategy and strategy.supertrend_period else 10 }};
        const multiplier = {{ strategy.supertrend_multiplier if strategy and strategy.supertrend_multiplier else 3.0 }};
        const interval = '{{ strategy.supertrend_timeframe if strategy and strategy.supertrend_timeframe else "10m" }}';

        const response = await fetch(
            `/tradingview/api/chart-data/${strategyIdForRisk}?period=${period}&multiplier=${multiplier}&interval=${interval}&days=1&_=${Date.now()}`
        );
        const result = await response.json();

        if (result.status === 'success' && result.data && result.data.length > 0) {
            // Check if all positions are closed
            const allPositionsClosed = result.all_positions_closed === true;

            // Get the latest data point
            const latestData = result.data[result.data.length - 1];
            const combinedPremium = latestData.close;
            const supertrendValue = latestData.supertrend;
            const direction = latestData.direction; // 1 = bullish (BUY), -1 = bearish (SELL)

            // Update connection status
            if (connectionEl) {
                if (allPositionsClosed) {
                    connectionEl.innerHTML = 'Closed';
                    connectionEl.className = 'badge badge-sm badge-warning';
                } else {
                    connectionEl.innerHTML = '<span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-success opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-success"></span></span>';
                    connectionEl.className = 'badge badge-sm badge-success';
                }
            }

            // Update combined premium
            premiumEl.textContent = combinedPremium !== null ? combinedPremium.toFixed(2) : '--';

            // Update supertrend value
            if (supertrendValueEl) {
                supertrendValueEl.textContent = supertrendValue !== null ? supertrendValue.toFixed(2) : '--';
            }

            // Update signal
            // Direction convention (matching Pine Script/TradingView):
            //   direction = -1: Bullish (Up direction) - premium ABOVE supertrend -> BUY
            //   direction = 1: Bearish (Down direction) - premium BELOW supertrend -> SELL
            if (signalEl) {
                if (allPositionsClosed) {
                    signalEl.textContent = 'CLOSED';
                    signalEl.className = 'badge badge-warning badge-sm ml-1';
                } else if (direction === -1) {
                    signalEl.textContent = 'BUY';
                    signalEl.className = 'badge badge-success badge-sm ml-1';
                } else if (direction === 1) {
                    signalEl.textContent = 'SELL';
                    signalEl.className = 'badge badge-error badge-sm ml-1';
                } else {
                    signalEl.textContent = '--';
                    signalEl.className = 'badge badge-sm ml-1';
                }
            }
        } else {
            throw new Error('No data received');
        }
    } catch (error) {
        console.error('Error fetching combined premium:', error);

        // Update connection status to offline
        if (connectionEl) {
            connectionEl.innerHTML = 'Offline';
            connectionEl.className = 'badge badge-sm badge-error';
        }
    }
}

// Start combined premium polling when page loads (if supertrend is enabled)
if (supertrendEnabled && strategyIdForRisk) {
    document.addEventListener('DOMContentLoaded', function() {
        // Delay slightly to let other initializations complete
        setTimeout(startCombinedPremiumPolling, 1000);
    });
}

async function loadOrderbook(strategyId) {
    try {
        // Add cache buster to ensure fresh data
        const response = await fetch(`/strategy/${strategyId}/orderbook?_=${Date.now()}`);
        const data = await response.json();

        if (data.status === 'success' && data.data) {
            const tbody = document.getElementById('orderbook-body');
            tbody.innerHTML = '';

            const orders = data.data.orders || [];
            const stats = data.data.statistics || {};

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="text-center text-base-content/60">No orders found</td></tr>';
            } else {
                orders.forEach(order => {
                    const row = tbody.insertRow();
                    const statusColor = order.order_status === 'complete' ? 'badge-success' :
                                      order.order_status === 'rejected' ? 'badge-error' :
                                      order.order_status === 'open' ? 'badge-warning' : 'badge-outline';
                    row.innerHTML = `
                        <td><span class="badge badge-outline badge-sm">${order.account_name || 'N/A'}</span></td>
                        <td><span class="badge badge-primary badge-sm">${order.leg_number || '-'}</span></td>
                        <td class="text-xs">${order.orderid || '-'}</td>
                        <td>${order.symbol}</td>
                        <td>${order.exchange}</td>
                        <td>${order.product}</td>
                        <td><span class="badge ${order.action === 'BUY' ? 'badge-success' : 'badge-error'} badge-sm">${order.action}</span></td>
                        <td>${order.quantity}</td>
                        <td>₹${order.price || 0}</td>
                        <td><span class="badge ${statusColor} badge-sm">${order.order_status}</span></td>
                        <td class="text-xs">${order.timestamp || '-'}</td>
                    `;
                });
            }

            // Update statistics if available
            if (stats.total_buy_orders !== undefined) {
                const statsDiv = document.getElementById('order-stats');
                if (statsDiv) {
                    statsDiv.innerHTML = `
                        <div class="stats shadow">
                            <div class="stat py-2">
                                <div class="stat-title text-xs">Buy Orders</div>
                                <div class="stat-value text-sm">${stats.total_buy_orders}</div>
                            </div>
                            <div class="stat py-2">
                                <div class="stat-title text-xs">Sell Orders</div>
                                <div class="stat-value text-sm">${stats.total_sell_orders}</div>
                            </div>
                            <div class="stat py-2">
                                <div class="stat-title text-xs">Completed</div>
                                <div class="stat-value text-sm text-success">${stats.total_completed_orders}</div>
                            </div>
                            <div class="stat py-2">
                                <div class="stat-title text-xs">Open</div>
                                <div class="stat-value text-sm text-warning">${stats.total_open_orders}</div>
                            </div>
                            <div class="stat py-2">
                                <div class="stat-title text-xs">Rejected</div>
                                <div class="stat-value text-sm text-error">${stats.total_rejected_orders}</div>
                            </div>
                        </div>
                    `;
                }
            }
        }
    } catch (error) {
        console.error('Error loading orderbook:', error);
    }
}

async function loadTradebook(strategyId) {
    try {
        // Add cache buster to ensure fresh data
        const response = await fetch(`/strategy/${strategyId}/tradebook?_=${Date.now()}`);
        const data = await response.json();

        if (data.status === 'success' && data.data) {
            const tbody = document.getElementById('tradebook-body');
            tbody.innerHTML = '';

            const trades = data.data || [];

            if (trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="text-center text-base-content/60">No trades found</td></tr>';
            } else {
                trades.forEach(trade => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td><span class="badge badge-outline badge-sm">${trade.account_name || 'N/A'}</span></td>
                        <td><span class="badge badge-primary badge-sm">${trade.leg_number || '-'}</span></td>
                        <td class="text-xs">${trade.orderid || '-'}</td>
                        <td>${trade.symbol}</td>
                        <td>${trade.exchange}</td>
                        <td>${trade.product}</td>
                        <td><span class="badge ${trade.action === 'BUY' ? 'badge-success' : 'badge-error'} badge-sm">${trade.action}</span></td>
                        <td>${trade.quantity || trade.filled_quantity || '-'}</td>
                        <td>${trade.average_price || 0}</td>
                        <td>${trade.trade_value ? trade.trade_value.toFixed(2) : '0.00'}</td>
                        <td class="text-xs">${trade.timestamp || '-'}</td>
                    `;
                });
            }
        }
    } catch (error) {
        console.error('Error loading tradebook:', error);
    }
}

async function loadPositions(strategyId) {
    try {
        // Add cache buster to ensure fresh data
        const response = await fetch(`/strategy/${strategyId}/positions?_=${Date.now()}`);
        const data = await response.json();

        if (data.status === 'success' && data.data) {
            const tbody = document.getElementById('positions-body');
            tbody.innerHTML = '';

            const positions = data.data || [];
            console.log(`Loaded ${positions.length} positions:`, positions);

            if (positions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="text-center text-base-content/60">No positions</td></tr>';

                // Update open positions count to 0
                const countElement = document.getElementById('open-positions-count');
                if (countElement) {
                    countElement.textContent = '0';
                }
            } else {
                let openPositionsCount = 0;

                positions.forEach(position => {
                    const pnl = parseFloat(position.pnl) || 0;
                    const row = tbody.insertRow();
                    const qty = parseInt(position.quantity) || 0;
                    const isOpenPosition = qty !== 0 && position.is_closed !== true;

                    console.log(`Position ${position.symbol}: qty=${qty}, is_closed=${position.is_closed}, status=${position.status}, isOpen=${isOpenPosition}`);

                    // Count only open positions (qty != 0 and not closed)
                    if (isOpenPosition) {
                        openPositionsCount++;
                    }

                    // Determine Risk Management Type(s) - can have multiple
                    let riskTypes = [];

                    // Check for Basic - leg-level SL/TP
                    if ((position.stop_loss && parseFloat(position.stop_loss) > 0) ||
                        (position.take_profit && parseFloat(position.take_profit) > 0)) {
                        riskTypes.push('Basic');
                    }

                    // Check for Traditional - strategy-level risk management
                    if ((position.max_loss && parseFloat(position.max_loss) > 0) ||
                        (position.max_profit && parseFloat(position.max_profit) > 0) ||
                        (position.trailing_sl && parseFloat(position.trailing_sl) > 0)) {
                        riskTypes.push('Traditional');
                    }

                    // Check for Supertrend - must be explicitly true
                    if (position.supertrend_exit_enabled === true || position.supertrend_exit_enabled === 'true') {
                        riskTypes.push('Supertrend');
                    }

                    // Combine risk types with comma separator
                    let riskMgmtType = riskTypes.length > 0 ? riskTypes.join(', ') : 'No';

                    // Badge color: info for Supertrend, warning for others, ghost for No
                    let riskMgmtBadgeClass = 'badge-ghost';
                    if (riskTypes.includes('Supertrend')) {
                        riskMgmtBadgeClass = 'badge-info';
                    } else if (riskTypes.length > 0) {
                        riskMgmtBadgeClass = 'badge-warning';
                    }

                    const action = qty < 0 ? 'SELL' : 'BUY';
                    const closeButtonHtml = isOpenPosition ?
                        `<button class="btn btn-circle btn-xs btn-error" onclick="closeIndividualPosition('${position.symbol}', '${position.exchange}', '${position.product}', ${position.account_id}, '${position.account_name}')" title="Close position for ${position.account_name}">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>` :
                        '<span class="badge badge-ghost badge-sm">Closed</span>';

                    // Detect instrument type from symbol
                    let instrumentType = '-';
                    let typeBadgeClass = 'badge-ghost';
                    const symbol = position.symbol.toUpperCase();

                    if (symbol.endsWith('CE')) {
                        instrumentType = 'CE';
                        typeBadgeClass = 'badge-success';
                    } else if (symbol.endsWith('PE')) {
                        instrumentType = 'PE';
                        typeBadgeClass = 'badge-error';
                    } else if (symbol.endsWith('FUT')) {
                        instrumentType = 'FUT';
                        typeBadgeClass = 'badge-info';
                    }

                    row.innerHTML = `
                        <td><span class="badge badge-outline badge-sm">${position.account_name || 'N/A'}</span></td>
                        <td><span class="badge badge-primary badge-sm">${position.leg_number || '-'}</span></td>
                        <td>${position.symbol}</td>
                        <td><span class="badge ${riskMgmtBadgeClass} badge-sm">${riskMgmtType}</span></td>
                        <td>${position.product}</td>
                        <td><span class="badge ${typeBadgeClass} badge-sm">${instrumentType}</span></td>
                        <td><span class="badge ${action === 'BUY' ? 'badge-success' : 'badge-error'} badge-sm">${action}</span></td>
                        <td>${Math.abs(qty)}</td>
                        <td>₹${position.average_price || 0}</td>
                        <td>₹${position.ltp || 0}</td>
                        <td class="${pnl >= 0 ? 'text-success' : 'text-error'}">₹${pnl.toFixed(2)}</td>
                        <td>${closeButtonHtml}</td>
                    `;
                });

                // Update open positions count
                const countElement = document.getElementById('open-positions-count');
                if (countElement) {
                    countElement.textContent = openPositionsCount;
                }
            }
        }
    } catch (error) {
        console.error('Error loading positions:', error);
    }
}

// Show modal for close positions confirmation
function closeAllPositions() {
    {% if strategy %}
    close_positions_modal.showModal();
    {% endif %}
}

// Actually close positions after confirmation
async function confirmClosePositions() {
    {% if strategy %}
    close_positions_modal.close();

    try {
        const strategyId = {{ strategy.id }};
        const response = await fetch(`/strategy/${strategyId}/close-all`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            }
        });

        const data = await response.json();

        if (data.status === 'success') {
            showNotification(data.message + ` Total P&L: ₹${data.total_pnl.toFixed(2)}`, 'success');
            // Reload the data
            loadStrategyData();
        } else {
            showNotification(data.message || 'Failed to close positions', 'error');
        }
    } catch (error) {
        console.error('Error closing positions:', error);
        showNotification('Error closing positions', 'error');
    }
    {% endif %}
}

// Close individual position
async function closeIndividualPosition(symbol, exchange, product, accountId, accountName) {
    {% if strategy %}
    console.log('[closeIndividualPosition] Called with:', { symbol, exchange, product, accountId, accountName });

    // No confirmation dialog - direct close
    console.log('[closeIndividualPosition] Proceeding with direct close (no confirmation)');

    try {
        const strategyId = {{ strategy.id }};
        console.log('[closeIndividualPosition] Sending API request for strategy:', strategyId);

        const response = await fetch(`/strategy/${strategyId}/close-position`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({
                symbol: symbol,
                exchange: exchange,
                product: product,
                account_id: accountId
            })
        });

        console.log('[closeIndividualPosition] Response received, status:', response.status);
        const data = await response.json();

        console.log('[closeIndividualPosition] API response data:', data);

        if (data.status === 'success') {
            console.log('[closeIndividualPosition] Success - calling showNotification');
            showNotification(`${data.message || 'Position closed for ' + symbol}. P&L: ₹${data.pnl ? data.pnl.toFixed(2) : '0.00'}`, 'success');
            // Immediately reload data
            console.log('Reloading strategy data...');
            loadStrategyData();
            // Force another refresh after 1 second to ensure database updates are visible
            setTimeout(() => {
                console.log('Second refresh after position close...');
                loadStrategyData();
            }, 1000);
        } else {
            console.error('[closeIndividualPosition] Failed:', data);
            showNotification(data.message || 'Failed to close position', 'error');
            // Refresh anyway to show current state
            loadStrategyData();
        }
    } catch (error) {
        console.error('[closeIndividualPosition] Exception:', error);
        showNotification('Error closing position', 'error');
    }
    {% endif %}
}

// Store current leg number for modal
let currentCloseLegNumber = null;

// Close leg for all accounts - Show modal
function closeLegAllAccounts(button) {
    {% if strategy %}
    console.log('[closeLegAllAccounts] Button clicked');
    const legItem = button.closest('.leg-item');
    const legNumber = legItem.querySelector('.leg-number').textContent;
    console.log('[closeLegAllAccounts] Leg number:', legNumber);

    // Store leg number for confirmation
    currentCloseLegNumber = parseInt(legNumber);
    console.log('[closeLegAllAccounts] Stored leg number:', currentCloseLegNumber);

    // Update modal text
    const modalText = document.getElementById('close_leg_text');
    if (modalText) {
        modalText.textContent = `Leg ${legNumber}`;
    }

    // Show modal
    console.log('[closeLegAllAccounts] Showing modal');
    close_leg_modal.showModal();
    {% endif %}
}

// Confirm close leg - Actually close after modal confirmation
async function confirmCloseLeg() {
    {% if strategy %}
    console.log('[confirmCloseLeg] Function called, leg number:', currentCloseLegNumber);

    if (!currentCloseLegNumber) {
        console.log('[confirmCloseLeg] No leg number stored, returning');
        return;
    }

    console.log('[confirmCloseLeg] Closing modal');
    close_leg_modal.close();

    try {
        const strategyId = {{ strategy.id }};
        console.log('[confirmCloseLeg] Sending API request for strategy:', strategyId, 'leg:', currentCloseLegNumber);

        const response = await fetch(`/strategy/${strategyId}/close-leg`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({
                leg_number: currentCloseLegNumber
            })
        });

        console.log('[confirmCloseLeg] Response received, status:', response.status);
        const data = await response.json();

        console.log('[confirmCloseLeg] API response data:', data);

        if (data.status === 'success') {
            console.log('[confirmCloseLeg] Success - calling showNotification');
            showNotification(`${data.message}. Total P&L: ₹${data.total_pnl ? data.total_pnl.toFixed(2) : '0.00'}`, 'success');
            // Immediately reload data
            console.log('Reloading strategy data after leg close...');
            loadStrategyData();
            checkAndFreezePendingLegs();
            // Force another refresh after 1 second to ensure database updates are visible
            setTimeout(() => {
                console.log('Second refresh after leg close...');
                loadStrategyData();
                checkAndFreezePendingLegs();
            }, 1000);
        } else {
            console.error('[confirmCloseLeg] Failed:', data);
            showNotification(data.message || 'Failed to close leg', 'error');
            // Refresh anyway to show current state
            loadStrategyData();
        }
    } catch (error) {
        console.error('[confirmCloseLeg] Exception:', error);
        showNotification('Error closing leg', 'error');
    }

    console.log('[confirmCloseLeg] Clearing leg number');
    currentCloseLegNumber = null;
    {% endif %}
}

// Auto-refresh data every 10 seconds when on positions tab
let refreshInterval;
document.addEventListener('DOMContentLoaded', function() {
    {% if strategy %}
    refreshInterval = setInterval(function() {
        const positionsTab = document.getElementById('positions-tab');
        if (!positionsTab.classList.contains('hidden')) {
            loadPositions({{ strategy.id }});
        }
    }, 10000);
    {% endif %}
});
</script>
{% endblock %}