{% extends "layout.html" %}

{% block title %}Strategy Builder - AlgoMirror{% endblock %}

{% block content %}
<style>
/* Frozen leg styling */
.leg-frozen {
    position: relative;
}
.leg-frozen::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, transparent 48%, rgba(34, 197, 94, 0.1) 48%, rgba(34, 197, 94, 0.1) 52%, transparent 52%);
    background-size: 20px 20px;
    pointer-events: none;
    border-radius: 0.5rem;
    z-index: 0;
}
.leg-frozen > * {
    position: relative;
    z-index: 1;
}
.cursor-not-allowed {
    cursor: not-allowed !important;
}
</style>
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold">Strategy Builder</h1>
            <p class="text-base-content/70">Create multi-leg option strategies with 9 configurable parameters</p>
        </div>
        <a href="{{ url_for('strategy.dashboard') }}" class="btn btn-ghost">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Dashboard
        </a>
    </div>

    <form id="strategyForm">
        <!-- Basic Information Card -->
        <div class="card bg-base-100 shadow-lg mb-6">
            <div class="card-body">
                <h2 class="card-title mb-4">Basic Information</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Strategy Name</span>
                        </label>
                        <input type="text" id="strategyName" class="input input-bordered"
                               placeholder="e.g., Iron Condor Weekly" required
                               value="{{ strategy.name if strategy else '' }}">
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Risk Profile</span>
                        </label>
                        <select id="riskProfile" class="select select-bordered" onchange="toggleLotFields()">
                            <option value="fixed_lots" {% if strategy and strategy.risk_profile == 'fixed_lots' %}selected{% elif not strategy %}selected{% endif %}>Fixed Lot Size (Default)</option>
                            <option value="balanced" {% if strategy and strategy.risk_profile == 'balanced' %}selected{% endif %}>Balanced (65% margin)</option>
                            <option value="conservative" {% if strategy and strategy.risk_profile == 'conservative' %}selected{% endif %}>Conservative (40% margin)</option>
                            <option value="aggressive" {% if strategy and strategy.risk_profile == 'aggressive' %}selected{% endif %}>Aggressive (80% margin)</option>
                        </select>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Market Condition</span>
                        </label>
                        <select id="marketCondition" class="select select-bordered">
                            <option value="non_expiry" {% if strategy and strategy.market_condition == 'non_expiry' %}selected{% endif %}>Non-Expiry</option>
                            <option value="expiry" {% if strategy and strategy.market_condition == 'expiry' %}selected{% endif %}>Expiry Day</option>
                            <option value="any" {% if strategy and strategy.market_condition == 'any' %}selected{% endif %}>Any Day</option>
                        </select>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Product Order Type</span>
                        </label>
                        <select id="productOrderType" class="select select-bordered">
                            <option value="MIS" {% if strategy and strategy.product_order_type == 'MIS' %}selected{% elif not strategy %}selected{% endif %}>MIS (Intraday)</option>
                            <option value="NRML" {% if strategy and strategy.product_order_type == 'NRML' %}selected{% endif %}>NRML (Overnight)</option>
                        </select>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Select Accounts</span>
                        </label>
                        <div class="space-y-2">
                            {% for account in accounts %}
                            <label class="label cursor-pointer justify-start">
                                <input type="checkbox" class="checkbox checkbox-primary mr-3"
                                       name="accounts" value="{{ account.id }}"
                                       {% if strategy and strategy.selected_accounts and account.id in strategy.selected_accounts %}checked{% endif %}>
                                <span>{{ account.account_name }} ({{ account.broker_name }})</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy Legs Card -->
        <div class="card bg-base-100 shadow-lg mb-6">
            <div class="card-body">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="card-title">Strategy Legs</h2>
                    <button type="button" onclick="addLeg()" class="btn btn-primary btn-sm">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Add Leg
                    </button>
                </div>

                <div id="strategyLegs">
                    <!-- Legs will be added dynamically -->
                </div>
            </div>
        </div>

        <!-- Risk Management Card -->
        <div class="card bg-base-100 shadow-lg mb-6">
            <div class="card-body">
                <h2 class="card-title mb-4">Risk Management</h2>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Max Loss (₹)</span>
                        </label>
                        <input type="number" id="maxLoss" class="input input-bordered"
                               placeholder="5000" value="{{ strategy.max_loss if strategy else '' }}">
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Max Profit (₹)</span>
                        </label>
                        <input type="number" id="maxProfit" class="input input-bordered"
                               placeholder="10000" value="{{ strategy.max_profit if strategy else '' }}">
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Trailing Stop Loss (%)</span>
                        </label>
                        <input type="number" id="trailingSl" class="input input-bordered"
                               placeholder="20" step="0.1" value="{{ strategy.trailing_sl if strategy else '' }}">
                    </div>
                </div>
            </div>
        </div>

        {% if strategy %}
        <!-- Strategy Execution Tracking Section -->

        <!-- Tabs for Orderbook, Tradebook, Positions -->
        <div class="card bg-base-100 shadow-lg mb-6">
            <div class="card-body">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="card-title">Strategy Execution Tracking</h2>
                    <div class="flex gap-2">
                        <button type="button" onclick="refreshStrategyData()" class="btn btn-ghost btn-sm">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Refresh
                        </button>
                        <button type="button" onclick="closeAllPositions()" class="btn btn-error btn-sm">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            Close All Positions
                        </button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="border-b border-base-300 mb-4">
                    <div class="flex space-x-2">
                        <button type="button" class="px-6 py-3 font-semibold border-b-2 border-primary text-primary" id="tab-orderbook" onclick="showStrategyTab('orderbook', this)">
                            Orderbook
                        </button>
                        <button type="button" class="px-6 py-3 font-semibold border-b-2 border-transparent text-base-content/60 hover:text-base-content hover:border-base-300" id="tab-tradebook" onclick="showStrategyTab('tradebook', this)">
                            Tradebook
                        </button>
                        <button type="button" class="px-6 py-3 font-semibold border-b-2 border-transparent text-base-content/60 hover:text-base-content hover:border-base-300" id="tab-positions" onclick="showStrategyTab('positions', this)">
                            Positions
                        </button>
                    </div>
                </div>

                <!-- Orderbook Tab -->
                <div id="orderbook-tab" class="strategy-tab">
                    <div id="order-stats" class="mb-4"></div>
                    <div class="overflow-x-auto">
                        <table class="table table-compact">
                            <thead>
                                <tr>
                                    <th>Account</th>
                                    <th>Order ID</th>
                                    <th>Symbol</th>
                                    <th>Exchange</th>
                                    <th>Product</th>
                                    <th>Action</th>
                                    <th>Qty</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                            <tbody id="orderbook-body">
                                <tr>
                                    <td colspan="10" class="text-center text-base-content/60">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tradebook Tab -->
                <div id="tradebook-tab" class="strategy-tab hidden">
                    <div class="overflow-x-auto">
                        <table class="table table-compact">
                            <thead>
                                <tr>
                                    <th>Account</th>
                                    <th>Order ID</th>
                                    <th>Symbol</th>
                                    <th>Exchange</th>
                                    <th>Product</th>
                                    <th>Action</th>
                                    <th>Avg Price</th>
                                    <th>Trade Value</th>
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                            <tbody id="tradebook-body">
                                <tr>
                                    <td colspan="9" class="text-center text-base-content/60">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="stats shadow mt-4">
                        <div class="stat">
                            <div class="stat-title">Total P&L (Realized + Unrealized)</div>
                            <div class="stat-value" id="total-pnl">
                                {% if strategy %}
                                    ₹{{ "%.2f"|format(strategy.total_pnl) }}
                                {% else %}
                                    ₹0.00
                                {% endif %}
                            </div>
                            <div class="stat-desc">Persists even after positions close</div>
                        </div>
                        {% if strategy %}
                        <div class="stat">
                            <div class="stat-title">Realized P&L</div>
                            <div class="stat-value text-sm {% if strategy.realized_pnl >= 0 %}text-success{% else %}text-error{% endif %}" id="realized-pnl">
                                ₹{{ "%.2f"|format(strategy.realized_pnl) }}
                            </div>
                            <div class="stat-desc">From closed positions</div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Positions Tab -->
                <div id="positions-tab" class="strategy-tab hidden">
                    <div class="overflow-x-auto">
                        <table class="table table-compact">
                            <thead>
                                <tr>
                                    <th>Account</th>
                                    <th>Symbol</th>
                                    <th>Exchange</th>
                                    <th>Product</th>
                                    <th>Action</th>
                                    <th>Qty</th>
                                    <th>Avg Price</th>
                                    <th>LTP</th>
                                    <th>P&L</th>
                                </tr>
                            </thead>
                            <tbody id="positions-body">
                                <tr>
                                    <td colspan="9" class="text-center text-base-content/60">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="stats shadow mt-4">
                        <div class="stat">
                            <div class="stat-title">Total P&L (Realized + Unrealized)</div>
                            <div class="stat-value" id="total-positions-pnl">
                                {% if strategy %}
                                    ₹{{ "%.2f"|format(strategy.total_pnl) }}
                                {% else %}
                                    ₹0.00
                                {% endif %}
                            </div>
                            <div class="stat-desc">Includes open and closed positions</div>
                        </div>
                        {% if strategy %}
                        <div class="stat">
                            <div class="stat-title">Open Positions</div>
                            <div class="stat-value text-sm" id="open-positions-count">0</div>
                            <div class="stat-desc">Currently active</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Action Buttons -->
        <div class="flex justify-end gap-3">
            <button type="button" onclick="saveAsTemplate()" class="btn btn-ghost">Save as Template</button>
            <button type="button" onclick="saveStrategy(false)" class="btn btn-outline btn-primary">Save Strategy</button>
            <button type="button" onclick="saveStrategy(true)" class="btn btn-primary">Save & Execute</button>
        </div>
    </form>
</div>

<!-- Leg Template -->
<template id="legTemplate">
    <div class="leg-item border rounded-lg p-4 mb-4" data-is-executed="false">
        <div class="flex justify-between items-center mb-3">
            <h3 class="font-semibold">
                Leg <span class="leg-number">1</span>
                <span class="leg-status-badge badge badge-sm badge-success ml-2" style="display:none;">EXECUTED</span>
            </h3>
            <div class="flex gap-2">
                <button type="button" onclick="modifyLegPrice(this)" class="btn btn-warning btn-sm leg-modify-btn" style="display:none;">
                    Modify Price
                </button>
                <button type="button" onclick="cancelLegOrder(this)" class="btn btn-error btn-sm leg-cancel-btn" style="display:none;">
                    Cancel Order
                </button>
                <button type="button" onclick="removeLeg(this)" class="btn btn-ghost btn-sm leg-remove-btn">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <!-- Row 1: Instrument, Product Type, Expiry, Action -->
            <div class="form-control">
                <label class="label"><span class="label-text text-xs">1. Instrument</span></label>
                <select class="select select-bordered select-sm leg-instrument">
                    <option value="NIFTY">NIFTY</option>
                    <option value="BANKNIFTY">BANKNIFTY</option>
                    <option value="FINNIFTY">FINNIFTY</option>
                    <option value="MIDCPNIFTY">MIDCPNIFTY</option>
                    <option value="SENSEX">SENSEX</option>
                </select>
            </div>

            <div class="form-control">
                <label class="label"><span class="label-text text-xs">2. Product Type</span></label>
                <select class="select select-bordered select-sm leg-product-type" onchange="toggleOptionFields(this)">
                    <option value="options">Options</option>
                    <option value="futures">Futures</option>
                </select>
            </div>

            <div class="form-control">
                <label class="label"><span class="label-text text-xs">3. Expiry</span></label>
                <select class="select select-bordered select-sm leg-expiry">
                    <option value="current_week">Current Week</option>
                    <option value="next_week">Next Week</option>
                    <option value="current_month">Current Month</option>
                    <option value="next_month">Next Month</option>
                </select>
            </div>

            <div class="form-control">
                <label class="label"><span class="label-text text-xs">4. Action</span></label>
                <select class="select select-bordered select-sm leg-action">
                    <option value="BUY">BUY</option>
                    <option value="SELL">SELL</option>
                </select>
            </div>

            <!-- Row 2: Option Type, Strike Selection, Strike Price/Offset, Lots -->
            <div class="form-control option-field">
                <label class="label"><span class="label-text text-xs">5. Option Type</span></label>
                <select class="select select-bordered select-sm leg-option-type">
                    <option value="CE">Call (CE)</option>
                    <option value="PE">Put (PE)</option>
                </select>
            </div>

            <div class="form-control option-field">
                <label class="label"><span class="label-text text-xs">6. Strike Selection</span></label>
                <select class="select select-bordered select-sm leg-strike-selection" onchange="toggleStrikeInput(this)">
                    <option value="ATM">ATM (At The Money)</option>
                    <optgroup label="In The Money">
                        <option value="ITM" data-offset="1">ITM 1</option>
                        <option value="ITM" data-offset="2">ITM 2</option>
                        <option value="ITM" data-offset="3">ITM 3</option>
                        <option value="ITM" data-offset="4">ITM 4</option>
                        <option value="ITM" data-offset="5">ITM 5</option>
                        <option value="ITM" data-offset="6">ITM 6</option>
                        <option value="ITM" data-offset="7">ITM 7</option>
                        <option value="ITM" data-offset="8">ITM 8</option>
                        <option value="ITM" data-offset="9">ITM 9</option>
                        <option value="ITM" data-offset="10">ITM 10</option>
                        <option value="ITM" data-offset="11">ITM 11</option>
                        <option value="ITM" data-offset="12">ITM 12</option>
                        <option value="ITM" data-offset="13">ITM 13</option>
                        <option value="ITM" data-offset="14">ITM 14</option>
                        <option value="ITM" data-offset="15">ITM 15</option>
                        <option value="ITM" data-offset="16">ITM 16</option>
                        <option value="ITM" data-offset="17">ITM 17</option>
                        <option value="ITM" data-offset="18">ITM 18</option>
                        <option value="ITM" data-offset="19">ITM 19</option>
                        <option value="ITM" data-offset="20">ITM 20</option>
                    </optgroup>
                    <optgroup label="Out of The Money">
                        <option value="OTM" data-offset="1">OTM 1</option>
                        <option value="OTM" data-offset="2">OTM 2</option>
                        <option value="OTM" data-offset="3">OTM 3</option>
                        <option value="OTM" data-offset="4">OTM 4</option>
                        <option value="OTM" data-offset="5">OTM 5</option>
                        <option value="OTM" data-offset="6">OTM 6</option>
                        <option value="OTM" data-offset="7">OTM 7</option>
                        <option value="OTM" data-offset="8">OTM 8</option>
                        <option value="OTM" data-offset="9">OTM 9</option>
                        <option value="OTM" data-offset="10">OTM 10</option>
                        <option value="OTM" data-offset="11">OTM 11</option>
                        <option value="OTM" data-offset="12">OTM 12</option>
                        <option value="OTM" data-offset="13">OTM 13</option>
                        <option value="OTM" data-offset="14">OTM 14</option>
                        <option value="OTM" data-offset="15">OTM 15</option>
                        <option value="OTM" data-offset="16">OTM 16</option>
                        <option value="OTM" data-offset="17">OTM 17</option>
                        <option value="OTM" data-offset="18">OTM 18</option>
                        <option value="OTM" data-offset="19">OTM 19</option>
                        <option value="OTM" data-offset="20">OTM 20</option>
                    </optgroup>
                    <option value="strike_price">Specific Strike</option>
                    <option value="premium_near">Premium Near</option>
                </select>
            </div>

            <div class="form-control">
                <label class="label"><span class="label-text text-xs leg-strike-label">7. Strike Value</span></label>
                <input type="number" class="input input-bordered input-sm leg-strike-value" placeholder="Auto" disabled>
            </div>

            <div class="form-control">
                <label class="label"><span class="label-text text-xs">8. Lots</span></label>
                <input type="number" class="input input-bordered input-sm leg-lots" value="1" min="1">
            </div>

            <!-- Row 3: Order Type, Limit Price -->
            <div class="form-control">
                <label class="label"><span class="label-text text-xs">9. Order Type</span></label>
                <select class="select select-bordered select-sm leg-order-type" onchange="togglePriceFields(this)">
                    <option value="MARKET">MARKET</option>
                    <option value="LIMIT">LIMIT</option>
                </select>
            </div>

            <div class="form-control limit-price-field" style="display:none;">
                <label class="label"><span class="label-text text-xs">Limit Price</span></label>
                <input type="number" class="input input-bordered input-sm leg-limit-price" placeholder="0.00" step="0.05">
            </div>


            <!-- Row 4: SL%, TP% -->
            <div class="form-control">
                <label class="label"><span class="label-text text-xs">Stop Loss (%)</span></label>
                <input type="number" class="input input-bordered input-sm leg-sl" placeholder="%" step="0.1">
            </div>

            <div class="form-control">
                <label class="label"><span class="label-text text-xs">Take Profit (%)</span></label>
                <input type="number" class="input input-bordered input-sm leg-tp" placeholder="%" step="0.1">
            </div>
        </div>
    </div>
</template>

<!-- Close All Positions Confirmation Modal -->
<dialog id="close_positions_modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Close All Positions</h3>
        <p class="py-4">Are you sure you want to close all open positions for this strategy?</p>
        <p class="text-sm text-warning">This action will place market orders to exit all positions.</p>
        <div class="modal-action">
            <button class="btn btn-ghost" onclick="close_positions_modal.close()">Cancel</button>
            <button class="btn btn-error" onclick="confirmClosePositions()">Close All Positions</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
let legCount = 0;
let lotSizes = {};  // Store lot sizes fetched from backend

// Fetch lot sizes on page load
async function fetchLotSizes() {
    try {
        const response = await fetch('/strategy/api/lot-sizes');
        if (response.ok) {
            const data = await response.json();
            // Merge fetched data with defaults
            lotSizes = {
                'NIFTY': 75,
                'BANKNIFTY': 35,
                'FINNIFTY': 65,
                'MIDCPNIFTY': 75,
                'SENSEX': 20,
                ...data  // Override with database values
            };
        } else {
            // Use defaults if fetch fails
            lotSizes = {
                'NIFTY': 75,
                'BANKNIFTY': 35,
                'FINNIFTY': 65,
                'MIDCPNIFTY': 75,
                'SENSEX': 20
            };
        }
    } catch (error) {
        console.error('Error fetching lot sizes:', error);
        // Use defaults on error
        lotSizes = {
            'NIFTY': 75,
            'BANKNIFTY': 35,
            'FINNIFTY': 65,
            'MIDCPNIFTY': 75,
            'SENSEX': 20
        };
        console.log('Using default lot sizes (error occurred)');
    }
}

// Add a new leg
function addLeg() {
    const template = document.getElementById('legTemplate');
    const clone = template.content.cloneNode(true);

    legCount++;
    clone.querySelector('.leg-number').textContent = legCount;

    document.getElementById('strategyLegs').appendChild(clone);

    // Apply lot field state based on current risk profile
    toggleLotFields();
}

// Remove a leg
function removeLeg(button) {
    button.closest('.leg-item').remove();
    updateLegNumbers();
}

// Update leg numbers after removal
function updateLegNumbers() {
    const legs = document.querySelectorAll('.leg-item');
    legs.forEach((leg, index) => {
        leg.querySelector('.leg-number').textContent = index + 1;
    });
    legCount = legs.length;
}

// Toggle option-specific fields
function toggleOptionFields(select) {
    const legItem = select.closest('.leg-item');
    const optionFields = legItem.querySelectorAll('.option-field');

    if (select.value === 'futures') {
        optionFields.forEach(field => field.style.display = 'none');
    } else {
        optionFields.forEach(field => field.style.display = 'block');
    }
}

// Toggle price fields based on order type
function togglePriceFields(selectElement) {
    const legItem = selectElement.closest('.leg-item');
    const orderType = selectElement.value;
    const limitPriceField = legItem.querySelector('.limit-price-field');

    // Hide by default
    if (limitPriceField) limitPriceField.style.display = 'none';

    // Show limit price field only for LIMIT orders
    if (orderType === 'LIMIT') {
        if (limitPriceField) limitPriceField.style.display = 'block';
    }
}

// Freeze/unfreeze leg (disable/enable all inputs)
// isPending: true for open LIMIT orders, false for filled orders
function freezeLeg(legItem, isExecuted, isPending = false) {
    legItem.dataset.isExecuted = isExecuted ? 'true' : 'false';
    legItem.dataset.isPending = isPending ? 'true' : 'false';

    if (isExecuted || isPending) {
        // Show appropriate badge
        const badge = legItem.querySelector('.leg-status-badge');
        if (badge) {
            badge.style.display = 'inline-block';
            if (isPending) {
                badge.classList.remove('badge-success');
                badge.classList.add('badge-warning');
                badge.textContent = 'PENDING';
            } else {
                badge.classList.remove('badge-warning');
                badge.classList.add('badge-success');
                badge.textContent = 'EXECUTED';
            }
        }

        // Disable all inputs and selects
        legItem.querySelectorAll('input, select').forEach(element => {
            element.disabled = true;
            element.classList.add('cursor-not-allowed');
        });

        // For pending orders, re-enable limit price field
        if (isPending) {
            const limitPriceField = legItem.querySelector('.leg-limit-price');
            if (limitPriceField) {
                limitPriceField.disabled = false;
                limitPriceField.classList.remove('cursor-not-allowed');
            }

            // Show modify and cancel buttons for pending orders
            const modifyBtn = legItem.querySelector('.leg-modify-btn');
            const cancelBtn = legItem.querySelector('.leg-cancel-btn');
            if (modifyBtn) {
                modifyBtn.style.display = 'inline-block';
            }
            if (cancelBtn) {
                cancelBtn.style.display = 'inline-block';
            }
        }

        // Hide remove button
        const removeBtn = legItem.querySelector('.leg-remove-btn');
        if (removeBtn) {
            removeBtn.style.display = 'none';
        }

        // Add visual indicator
        if (isPending) {
            // Yellow tint for pending
            legItem.style.opacity = '0.9';
            legItem.style.backgroundColor = '#fefce8';
            legItem.style.borderColor = '#eab308';
            legItem.style.borderWidth = '2px';
        } else {
            // Green tint for executed
            legItem.style.opacity = '0.85';
            legItem.style.backgroundColor = '#f0fdf4';
            legItem.style.borderColor = '#22c55e';
            legItem.style.borderWidth = '2px';
        }
        legItem.classList.add('leg-frozen');
    } else {
        // Hide badge
        const badge = legItem.querySelector('.leg-status-badge');
        if (badge) {
            badge.style.display = 'none';
            badge.classList.remove('badge-success', 'badge-warning');
        }

        // Hide cancel button
        const cancelBtn = legItem.querySelector('.leg-cancel-btn');
        if (cancelBtn) {
            cancelBtn.style.display = 'none';
        }

        // Enable all inputs and selects
        legItem.querySelectorAll('input, select').forEach(element => {
            element.disabled = false;
            element.classList.remove('cursor-not-allowed');
        });

        // Show remove button
        const removeBtn = legItem.querySelector('.leg-remove-btn');
        if (removeBtn) removeBtn.style.display = 'block';

        // Remove visual indicator
        legItem.style.opacity = '1';
        legItem.style.backgroundColor = '';
        legItem.style.borderColor = '';
        legItem.style.borderWidth = '';
        legItem.classList.remove('leg-frozen');
    }
}

// Cancel pending order for a leg
async function cancelLegOrder(button) {
    const legItem = button.closest('.leg-item');
    const legNumber = legItem.querySelector('.leg-number').textContent;

    if (!confirm(`Cancel pending order for Leg ${legNumber}?`)) {
        return;
    }

    try {
        // Get leg ID from execution data
        const legId = legItem.dataset.legId;
        if (!legId) {
            showNotification('Cannot find leg ID for cancellation', 'error');
            return;
        }

        const strategyId = {{ strategy.id if strategy else 'null' }};
        if (!strategyId) {
            showNotification('Strategy ID not found', 'error');
            return;
        }

        const response = await fetch(`/strategy/${strategyId}/leg/${legId}/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            }
        });

        const data = await response.json();

        if (data.status === 'success') {
            showNotification('Order cancelled successfully', 'success');
            // Unfreeze the leg
            freezeLeg(legItem, false, false);
            // Reload strategy data
            loadStrategyData();
        } else {
            showNotification(data.message || 'Failed to cancel order', 'error');
        }
    } catch (error) {
        console.error('Error cancelling order:', error);
        showNotification('Error cancelling order', 'error');
    }
}

// Modify limit price for pending order (inline - no modal)
async function modifyLegPrice(button) {
    const legItem = button.closest('.leg-item');
    const legNumber = legItem.querySelector('.leg-number').textContent;
    const limitPriceInput = legItem.querySelector('.leg-limit-price');
    const newPrice = limitPriceInput.value;

    if (!newPrice || parseFloat(newPrice) <= 0) {
        showNotification('Please enter a valid price', 'error');
        return;
    }

    try {
        // Get leg ID from execution data
        const legId = legItem.dataset.legId;
        if (!legId) {
            showNotification('Cannot find leg ID for modification', 'error');
            return;
        }

        const strategyId = {{ strategy.id if strategy else 'null' }};
        if (!strategyId) {
            showNotification('Strategy ID not found', 'error');
            return;
        }

        const response = await fetch(`/strategy/${strategyId}/leg/${legId}/modify`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({
                price: parseFloat(newPrice)
            })
        });

        const data = await response.json();

        if (data.status === 'success' || data.status === 'partial') {
            showNotification(data.message || 'Order price modified to ₹' + newPrice, 'success');
            // Reload strategy data to refresh orderbook
            loadStrategyData();
        } else {
            showNotification(data.message || 'Failed to modify order price', 'error');
            if (data.errors && data.errors.length > 0) {
                console.error('Modification errors:', data.errors);
            }
        }
    } catch (error) {
        console.error('Error modifying order:', error);
        showNotification('Failed to modify order price', 'error');
    }
}

// Poll order status every 5 seconds for pending orders
let statusPollingInterval = null;

function startStatusPolling() {
    // Clear any existing interval
    if (statusPollingInterval) {
        clearInterval(statusPollingInterval);
    }

    {% if strategy %}
    const strategyId = {{ strategy.id }};

    // Poll every 5 seconds
    statusPollingInterval = setInterval(async () => {
        try {
            // Check if there are any pending legs
            const pendingLegs = document.querySelectorAll('.leg-item[data-is-pending="true"]');
            if (pendingLegs.length === 0) {
                // No pending legs, stop polling
                console.log('No pending legs, stopping status polling');
                clearInterval(statusPollingInterval);
                statusPollingInterval = null;
                return;
            }

            console.log(`Polling status for ${pendingLegs.length} pending legs`);

            // Fetch latest orderbook
            const response = await fetch(`/strategy/${strategyId}/orderbook`);
            const data = await response.json();

            if (data.status === 'success' && data.data) {
                const orders = data.data.orders || [];

                // Update leg status based on order status
                pendingLegs.forEach(legItem => {
                    // Get leg number from displayed text
                    const legNumber = parseInt(legItem.querySelector('.leg-number').textContent);
                    if (!legNumber) return;

                    // Find orders for this leg by leg_number
                    const legOrders = orders.filter(o => o.leg_number == legNumber);
                    if (legOrders.length === 0) return;

                    // Store leg_id if not already set
                    if (legOrders[0].leg_id && !legItem.dataset.legId) {
                        legItem.dataset.legId = legOrders[0].leg_id;
                    }

                    // Check if all orders are complete or failed
                    const allComplete = legOrders.every(o => o.order_status === 'complete');
                    const allFailed = legOrders.every(o => ['rejected', 'cancelled'].includes(o.order_status));
                    const anyOpen = legOrders.some(o => o.order_status === 'open');

                    if (allComplete) {
                        // Mark as executed
                        console.log(`Leg ${legNumber} is now complete`);
                        freezeLeg(legItem, true, false);
                        legItem.dataset.isPending = 'false';
                        legItem.dataset.isExecuted = 'true';
                        showNotification(`Leg ${legNumber} order filled`, 'success');
                    } else if (allFailed) {
                        // Unfreeze the leg
                        console.log(`Leg ${legNumber} orders failed, unfreezing`);
                        freezeLeg(legItem, false, false);
                        legItem.dataset.isPending = 'false';
                        showNotification(`Leg ${legNumber} order failed`, 'error');
                    }
                    // If still open, keep as pending
                });

                // Reload data to update tables
                loadStrategyData();
            }
        } catch (error) {
            console.error('Error polling order status:', error);
        }
    }, 5000); // 5 seconds

    console.log('Status polling started (every 5 seconds)');
    {% endif %}
}

function stopStatusPolling() {
    if (statusPollingInterval) {
        clearInterval(statusPollingInterval);
        statusPollingInterval = null;
        console.log('Status polling stopped');
    }
}

// Check orderbook and freeze legs with pending orders
async function checkAndFreezePendingLegs() {
    {% if strategy %}
    const strategyId = {{ strategy.id }};

    try {
        const response = await fetch(`/strategy/${strategyId}/orderbook`);
        const data = await response.json();

        if (data.status === 'success' && data.data) {
            const orders = data.data.orders || [];

            // Group orders by leg_number (more reliable than leg_id for new strategies)
            const ordersByLegNumber = {};
            orders.forEach(order => {
                if (!order.leg_number) return;
                if (!ordersByLegNumber[order.leg_number]) {
                    ordersByLegNumber[order.leg_number] = [];
                }
                ordersByLegNumber[order.leg_number].push(order);
            });

            // Check each leg
            document.querySelectorAll('.leg-item').forEach(legItem => {
                // Get leg number from the displayed number
                const legNumber = parseInt(legItem.querySelector('.leg-number').textContent);
                if (!legNumber) return;

                // Store leg_id from first order if not already set
                const legOrders = ordersByLegNumber[legNumber] || [];
                if (legOrders.length > 0 && legOrders[0].leg_id && !legItem.dataset.legId) {
                    legItem.dataset.legId = legOrders[0].leg_id;
                }

                if (legOrders.length === 0) return;

                // Check order statuses
                const hasOpen = legOrders.some(o => o.order_status === 'open');
                const allComplete = legOrders.every(o => o.order_status === 'complete');
                const allFailed = legOrders.every(o => ['rejected', 'cancelled'].includes(o.order_status));

                if (hasOpen) {
                    // Has pending orders - freeze partially
                    console.log(`Leg ${legNumber} has pending orders, freezing with edit allowed`);
                    freezeLeg(legItem, false, true);
                } else if (allComplete) {
                    // All complete - freeze completely
                    console.log(`Leg ${legNumber} is fully executed`);
                    freezeLeg(legItem, true, false);
                } else if (allFailed) {
                    // All failed - unfreeze
                    console.log(`Leg ${legNumber} orders failed, keeping unfrozen`);
                    freezeLeg(legItem, false, false);
                }
            });
        }
    } catch (error) {
        console.error('Error checking pending legs:', error);
    }
    {% endif %}
}

// Toggle lot fields based on risk profile selection
function toggleLotFields() {
    const riskProfile = document.getElementById('riskProfile').value;
    const isFixedLots = riskProfile === 'fixed_lots';

    // Get all lot input fields
    const lotFields = document.querySelectorAll('.leg-lots');

    lotFields.forEach(field => {
        if (isFixedLots) {
            // Enable lot fields for fixed lot size
            field.disabled = false;
            field.classList.remove('input-disabled', 'cursor-not-allowed');
            field.placeholder = '1';
        } else {
            // Disable lot fields for margin-based profiles
            field.disabled = true;
            field.classList.add('input-disabled', 'cursor-not-allowed');
            field.value = ''; // Clear the value
            field.placeholder = 'Auto (calculated at execution)';
        }
    });
}

// Toggle strike input based on selection
function toggleStrikeInput(select) {
    const legItem = select.closest('.leg-item');
    const input = legItem.querySelector('.leg-strike-value');
    const label = legItem.querySelector('.leg-strike-label');
    const selectedOption = select.options[select.selectedIndex];
    const offset = selectedOption.dataset.offset;

    if (select.value === 'strike_price') {
        input.disabled = false;
        input.placeholder = 'Enter strike price';
        input.value = '';
        label.textContent = '7. Strike Price';
    } else if (select.value === 'premium_near') {
        input.disabled = false;
        input.placeholder = 'Enter target premium';
        input.value = '';
        label.textContent = '7. Target Premium';
    } else if (select.value === 'ITM' || select.value === 'OTM') {
        // For ITM/OTM options, store offset as hidden value
        input.disabled = true;
        input.placeholder = 'Auto-calculated';
        input.value = offset || '0';
        input.dataset.offset = offset || '0';
        label.textContent = '7. Strike Offset';
    } else {
        // ATM
        input.disabled = true;
        input.placeholder = 'Auto (ATM)';
        input.value = '';
        label.textContent = '7. Strike Value';
    }
}

// Save strategy
function saveStrategy(execute = false) {
    const riskProfile = document.getElementById('riskProfile').value;
    const isFixedLots = riskProfile === 'fixed_lots';

    const legs = [];
    document.querySelectorAll('.leg-item').forEach((legItem, index) => {
        // Skip executed or pending legs - backend preserves them automatically
        // Sending them would create duplicate legs
        if (legItem.dataset.isExecuted === 'true' || legItem.dataset.isPending === 'true') {
            return;
        }

        const strikeSelect = legItem.querySelector('.leg-strike-selection');
        const selectedOption = strikeSelect?.options[strikeSelect.selectedIndex];
        const strikeValue = legItem.querySelector('.leg-strike-value').value;

        // Determine strike offset for ITM/OTM selections
        let strikeOffset = 0;
        if (selectedOption && selectedOption.dataset.offset) {
            strikeOffset = parseInt(selectedOption.dataset.offset) || 0;
        }

        const orderType = legItem.querySelector('.leg-order-type').value;
        const limitPrice = legItem.querySelector('.leg-limit-price')?.value;

        // For margin-based profiles, don't send lots/quantity (will be calculated at execution)
        // For fixed lots profile, send the specified lots and calculated quantity
        let lots = null;
        let calculatedQuantity = null;

        if (isFixedLots) {
            lots = parseInt(legItem.querySelector('.leg-lots').value) || 1;
            const instrument = legItem.querySelector('.leg-instrument').value;
            let lotSize = lotSizes[instrument] || 75;
            calculatedQuantity = lots * lotSize;
        }

        legs.push({
            instrument: legItem.querySelector('.leg-instrument').value,
            product_type: legItem.querySelector('.leg-product-type').value,
            expiry: legItem.querySelector('.leg-expiry').value,
            action: legItem.querySelector('.leg-action').value,
            option_type: legItem.querySelector('.leg-option-type')?.value,
            strike_selection: strikeSelect?.value,
            strike_price: strikeSelect?.value === 'strike_price' ? parseFloat(strikeValue) : null,
            strike_offset: strikeOffset,
            premium_value: strikeSelect?.value === 'premium_near' ? parseFloat(strikeValue) : null,
            lots: lots,  // null for margin-based profiles
            quantity: calculatedQuantity,  // null for margin-based profiles
            order_type: orderType,
            limit_price: limitPrice ? parseFloat(limitPrice) : null,
            trigger_price: null,
            stop_loss_type: 'percentage',
            stop_loss_value: parseFloat(legItem.querySelector('.leg-sl').value) || null,
            take_profit_type: 'percentage',
            take_profit_value: parseFloat(legItem.querySelector('.leg-tp').value) || null
        });
    });

    const selectedAccounts = Array.from(document.querySelectorAll('input[name="accounts"]:checked'))
        .map(cb => parseInt(cb.value));

    const strategyData = {
        name: document.getElementById('strategyName').value,
        risk_profile: document.getElementById('riskProfile').value,
        market_condition: document.getElementById('marketCondition').value,
        product_order_type: document.getElementById('productOrderType').value,
        selected_accounts: selectedAccounts,
        allocation_type: 'equal',
        max_loss: parseFloat(document.getElementById('maxLoss').value) || null,
        max_profit: parseFloat(document.getElementById('maxProfit').value) || null,
        trailing_sl: parseFloat(document.getElementById('trailingSl').value) || null,
        legs: legs
    };

    const url = {% if strategy %}'/strategy/builder/{{ strategy.id }}'{% else %}'/strategy/builder'{% endif %};

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify(strategyData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('Strategy saved successfully', 'success');

            if (execute) {
                // Execute the strategy
                fetch(`/strategy/execute/${data.strategy_id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    }
                })
                .then(response => response.json())
                .then(execData => {
                    // Handle different execution statuses
                    if (execData.status === 'success' || execData.status === 'partial') {
                        showNotification(execData.message || 'Orders placed successfully!', 'success');

                        // Reload strategy data and check for pending orders
                        setTimeout(() => {
                            loadStrategyData(); // Reload orderbook/tradebook/positions
                            checkAndFreezePendingLegs(); // Check and freeze pending legs
                            startStatusPolling(); // Start 5-second polling
                        }, 1000);

                        // Stay on the same page - no redirect
                    } else if (execData.status === 'warning') {
                        // Orders were skipped due to insufficient margin
                        showNotification(execData.message || 'Strategy execution skipped', 'warning');
                        // Show details if available
                        if (execData.results && execData.results.length > 0) {
                            console.log('Execution details:', execData.results);
                        }
                        // Stay on the same page - no redirect
                    } else {
                        // Error status
                        showNotification(execData.message || 'Strategy execution failed', 'error');
                        // Stay on the same page - no redirect
                    }
                })
                .catch(error => {
                    showNotification('Error executing strategy', 'error');
                    console.error('Error:', error);
                    // Stay on the same page - no redirect
                });
            }
            // Stay on the same page after save (no redirect)
        } else {
            showNotification(data.message || 'Failed to save strategy', 'error');
        }
    })
    .catch(error => {
        showNotification('Error saving strategy', 'error');
        console.error('Error:', error);
    });
}

// Save as template
function saveAsTemplate() {
    saveStrategy(false);
    // Additional logic to mark as template would go here
}

// Show notification
function showNotification(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast toast-end`;

    // Map type to appropriate alert class
    let alertClass = 'alert-info';
    if (type === 'success') {
        alertClass = 'alert-success';
    } else if (type === 'error') {
        alertClass = 'alert-error';
    } else if (type === 'warning') {
        alertClass = 'alert-warning';
    }

    toast.innerHTML = `
        <div class="alert ${alertClass}">
            <span>${message}</span>
        </div>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);  // Show for 5 seconds for important messages
}

// Initialize with existing data or add first leg
document.addEventListener('DOMContentLoaded', async function() {
    // Fetch lot sizes from database first
    await fetchLotSizes();

    {% if strategy_legs and strategy_legs|length > 0 %}
        // Load existing legs
        {% for leg in strategy_legs %}
        {
            addLeg();
            const legItem = document.querySelectorAll('.leg-item')[{{ loop.index0 }}];

            // Store leg ID for status tracking and cancellation
            legItem.dataset.legId = '{{ leg.id }}';

            // Populate basic fields
            legItem.querySelector('.leg-instrument').value = '{{ leg.instrument }}';
            legItem.querySelector('.leg-product-type').value = '{{ leg.product_type }}';
            legItem.querySelector('.leg-expiry').value = '{{ leg.expiry }}';
            legItem.querySelector('.leg-action').value = '{{ leg.action }}';

            // Important: Use lots from database, not the stored quantity
            // This ensures we use the correct lot size from TradingSettings
            const lots = {{ leg.lots or 1 }};
            legItem.querySelector('.leg-lots').value = lots;

            // Recalculate quantity based on current lot size from database
            const instrument = '{{ leg.instrument }}';
            const lotSize = lotSizes[instrument] || 75;

            legItem.querySelector('.leg-order-type').value = '{{ leg.order_type or "MARKET" }}';

            // Populate option fields if options
            {% if leg.product_type == 'options' %}
            legItem.querySelector('.leg-option-type').value = '{{ leg.option_type or "" }}';
            legItem.querySelector('.leg-strike-selection').value = '{{ leg.strike_selection or "ATM" }}';

            // Set strike value based on selection
            {% if leg.strike_selection == 'strike_price' %}
            legItem.querySelector('.leg-strike-value').value = {{ leg.strike_price if leg.strike_price else '""' }};
            legItem.querySelector('.leg-strike-value').disabled = false;
            {% elif leg.strike_selection == 'premium_near' %}
            legItem.querySelector('.leg-strike-value').value = {{ leg.premium_value if leg.premium_value else '""' }};
            legItem.querySelector('.leg-strike-value').disabled = false;
            {% elif leg.strike_selection in ['ITM', 'OTM'] %}
            legItem.querySelector('.leg-strike-value').dataset.offset = '{{ leg.strike_offset or 0 }}';
            // Find and select the correct ITM/OTM option with offset
            const strikeSelect = legItem.querySelector('.leg-strike-selection');
            for (let option of strikeSelect.options) {
                if (option.value === '{{ leg.strike_selection }}' && option.dataset.offset === '{{ leg.strike_offset }}') {
                    strikeSelect.value = option.value;
                    option.selected = true;
                    break;
                }
            }
            {% endif %}
            {% endif %}

            // Populate price fields based on order type
            {% if leg.order_type == 'LIMIT' %}
            togglePriceFields(legItem.querySelector('.leg-order-type'));
            {% if leg.price_condition %}
            legItem.querySelector('.leg-price-condition').value = '{{ leg.price_condition }}';
            {% endif %}
            {% if leg.limit_price %}
            legItem.querySelector('.leg-limit-price').value = {{ leg.limit_price }};
            {% endif %}
            {% endif %}

            // Populate stop loss and take profit
            {% if leg.stop_loss_value %}
            legItem.querySelector('.leg-sl').value = {{ leg.stop_loss_value }};
            {% endif %}
            {% if leg.take_profit_value %}
            legItem.querySelector('.leg-tp').value = {{ leg.take_profit_value }};
            {% endif %}

            // Toggle option fields if futures
            {% if leg.product_type == 'futures' %}
            toggleOptionFields(legItem.querySelector('.leg-product-type'));
            {% endif %}

            // Mark as executed and freeze if leg is already executed
            {% if leg.is_executed %}
            freezeLeg(legItem, true);
            {% endif %}
        }
        {% endfor %}
    {% else %}
        // Add first leg by default
        addLeg();
    {% endif %}

    // Load strategy execution data if editing existing strategy
    {% if strategy %}
    loadStrategyData();
    // Check for pending orders and start polling
    setTimeout(() => {
        checkAndFreezePendingLegs();
        startStatusPolling();
    }, 1000); // Wait 1 second for data to load
    {% endif %}

    // Set initial lot field state based on risk profile
    toggleLotFields();
});

// Strategy-level execution tracking functions
function showStrategyTab(tabName, element) {
    // Hide all tabs
    document.querySelectorAll('.strategy-tab').forEach(tab => {
        tab.classList.add('hidden');
    });

    // Remove active styling from all tab buttons
    document.querySelectorAll('[id^="tab-"]').forEach(tab => {
        tab.classList.remove('border-primary', 'text-primary');
        tab.classList.add('border-transparent', 'text-base-content/60');
    });

    // Add active styling to clicked tab
    element.classList.remove('border-transparent', 'text-base-content/60');
    element.classList.add('border-primary', 'text-primary');

    // Show selected tab
    document.getElementById(tabName + '-tab').classList.remove('hidden');
}

function loadStrategyData() {
    {% if strategy %}
    const strategyId = {{ strategy.id }};

    // Load orderbook
    loadOrderbook(strategyId);

    // Load tradebook
    loadTradebook(strategyId);

    // Load positions
    loadPositions(strategyId);
    {% endif %}
}

function refreshStrategyData() {
    loadStrategyData();
    showToast('Data refreshed', 'success');
}

async function loadOrderbook(strategyId) {
    try {
        const response = await fetch(`/strategy/${strategyId}/orderbook`);
        const data = await response.json();

        if (data.status === 'success' && data.data) {
            const tbody = document.getElementById('orderbook-body');
            tbody.innerHTML = '';

            const orders = data.data.orders || [];
            const stats = data.data.statistics || {};

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-base-content/60">No orders found</td></tr>';
            } else {
                orders.forEach(order => {
                    const row = tbody.insertRow();
                    const statusColor = order.order_status === 'complete' ? 'badge-success' :
                                      order.order_status === 'rejected' ? 'badge-error' :
                                      order.order_status === 'open' ? 'badge-warning' : 'badge-outline';
                    row.innerHTML = `
                        <td><span class="badge badge-outline badge-sm">${order.account_name || 'N/A'}</span></td>
                        <td class="text-xs">${order.orderid || '-'}</td>
                        <td>${order.symbol}</td>
                        <td>${order.exchange}</td>
                        <td>${order.product}</td>
                        <td><span class="badge ${order.action === 'BUY' ? 'badge-success' : 'badge-error'} badge-sm">${order.action}</span></td>
                        <td>${order.quantity}</td>
                        <td>₹${order.price || 0}</td>
                        <td><span class="badge ${statusColor} badge-sm">${order.order_status}</span></td>
                        <td class="text-xs">${order.timestamp || '-'}</td>
                    `;
                });
            }

            // Update statistics if available
            if (stats.total_buy_orders !== undefined) {
                const statsDiv = document.getElementById('order-stats');
                if (statsDiv) {
                    statsDiv.innerHTML = `
                        <div class="stats shadow">
                            <div class="stat py-2">
                                <div class="stat-title text-xs">Buy Orders</div>
                                <div class="stat-value text-sm">${stats.total_buy_orders}</div>
                            </div>
                            <div class="stat py-2">
                                <div class="stat-title text-xs">Sell Orders</div>
                                <div class="stat-value text-sm">${stats.total_sell_orders}</div>
                            </div>
                            <div class="stat py-2">
                                <div class="stat-title text-xs">Completed</div>
                                <div class="stat-value text-sm text-success">${stats.total_completed_orders}</div>
                            </div>
                            <div class="stat py-2">
                                <div class="stat-title text-xs">Open</div>
                                <div class="stat-value text-sm text-warning">${stats.total_open_orders}</div>
                            </div>
                            <div class="stat py-2">
                                <div class="stat-title text-xs">Rejected</div>
                                <div class="stat-value text-sm text-error">${stats.total_rejected_orders}</div>
                            </div>
                        </div>
                    `;
                }
            }
        }
    } catch (error) {
        console.error('Error loading orderbook:', error);
    }
}

async function loadTradebook(strategyId) {
    try {
        const response = await fetch(`/strategy/${strategyId}/tradebook`);
        const data = await response.json();

        if (data.status === 'success' && data.data) {
            const tbody = document.getElementById('tradebook-body');
            tbody.innerHTML = '';

            const trades = data.data || [];

            if (trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-base-content/60">No trades found</td></tr>';
            } else {
                trades.forEach(trade => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td><span class="badge badge-outline badge-sm">${trade.account_name || 'N/A'}</span></td>
                        <td class="text-xs">${trade.orderid || '-'}</td>
                        <td>${trade.symbol}</td>
                        <td>${trade.exchange}</td>
                        <td>${trade.product}</td>
                        <td><span class="badge ${trade.action === 'BUY' ? 'badge-success' : 'badge-error'} badge-sm">${trade.action}</span></td>
                        <td>₹${trade.average_price || 0}</td>
                        <td>₹${trade.trade_value ? trade.trade_value.toFixed(2) : '0.00'}</td>
                        <td class="text-xs">${trade.timestamp || '-'}</td>
                    `;
                });
            }
        }
    } catch (error) {
        console.error('Error loading tradebook:', error);
    }
}

async function loadPositions(strategyId) {
    try {
        const response = await fetch(`/strategy/${strategyId}/positions`);
        const data = await response.json();

        if (data.status === 'success' && data.data) {
            const tbody = document.getElementById('positions-body');
            tbody.innerHTML = '';

            const positions = data.data || [];

            if (positions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-base-content/60">No positions</td></tr>';

                // Update open positions count to 0
                const countElement = document.getElementById('open-positions-count');
                if (countElement) {
                    countElement.textContent = '0';
                }
            } else {
                let openPositionsCount = 0;

                positions.forEach(position => {
                    const pnl = parseFloat(position.pnl) || 0;
                    const row = tbody.insertRow();
                    const qty = parseInt(position.quantity) || 0;

                    // Count only open positions (qty != 0 and not closed)
                    if (qty !== 0 && position.is_closed !== true) {
                        openPositionsCount++;
                    }

                    const action = qty < 0 ? 'SELL' : 'BUY';
                    row.innerHTML = `
                        <td><span class="badge badge-outline badge-sm">${position.account_name || 'N/A'}</span></td>
                        <td>${position.symbol}</td>
                        <td>${position.exchange}</td>
                        <td>${position.product}</td>
                        <td><span class="badge ${action === 'BUY' ? 'badge-success' : 'badge-error'} badge-sm">${action}</span></td>
                        <td>${Math.abs(qty)}</td>
                        <td>₹${position.average_price || 0}</td>
                        <td>₹${position.ltp || 0}</td>
                        <td class="${pnl >= 0 ? 'text-success' : 'text-error'}">₹${pnl.toFixed(2)}</td>
                    `;
                });

                // Update open positions count
                const countElement = document.getElementById('open-positions-count');
                if (countElement) {
                    countElement.textContent = openPositionsCount;
                }
            }
        }
    } catch (error) {
        console.error('Error loading positions:', error);
    }
}

// Show modal for close positions confirmation
function closeAllPositions() {
    {% if strategy %}
    close_positions_modal.showModal();
    {% endif %}
}

// Actually close positions after confirmation
async function confirmClosePositions() {
    {% if strategy %}
    close_positions_modal.close();

    try {
        const strategyId = {{ strategy.id }};
        const response = await fetch(`/strategy/${strategyId}/close-all`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            }
        });

        const data = await response.json();

        if (data.status === 'success') {
            showToast(data.message + ` Total P&L: ₹${data.total_pnl.toFixed(2)}`, 'success');
            // Reload the data
            loadStrategyData();
        } else {
            showToast(data.message || 'Failed to close positions', 'error');
        }
    } catch (error) {
        console.error('Error closing positions:', error);
        showToast('Error closing positions', 'error');
    }
    {% endif %}
}

// Auto-refresh data every 10 seconds when on positions tab
let refreshInterval;
document.addEventListener('DOMContentLoaded', function() {
    {% if strategy %}
    refreshInterval = setInterval(function() {
        const positionsTab = document.getElementById('positions-tab');
        if (!positionsTab.classList.contains('hidden')) {
            loadPositions({{ strategy.id }});
        }
    }, 10000);
    {% endif %}
});
</script>
{% endblock %}